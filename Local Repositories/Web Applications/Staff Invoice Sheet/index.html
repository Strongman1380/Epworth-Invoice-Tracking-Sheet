<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Staff Invoice Sheet</title>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Google Maps API for distance calculation -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHuKbelQ7u7Ukb5BvfGnx_-5dvz1xM1w4&libraries=places"></script>
    <!-- Google Font for signatures -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-navy: #1f3c73;
            --brand-gold: #d88a2b;
            --brand-sky: #5fa8dd;
            --brand-light: #f4f7fb;
            --brand-muted: #5b6b82;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 0;
            color: #333;
            font-size: 14px;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-sky) 100%);
            color: white;
            padding: 12px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .header h2 {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
        }

        .week-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .nav-bar {
            margin-top: 10px;
        }

        .main-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .nav-tab {
            padding: 10px 14px;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.25);
        }

        .nav-tab.active {
            background: white;
            color: #2c5aa0;
        }

        .nav-tab.admin-only {
            background: rgba(220,53,69,0.3);
        }

        .nav-tab.admin-only.active {
            background: #dc3545;
            color: white;
        }

        .container {
            background: white;
            display: none;
        }

        .container.active {
            display: block;
        }

        .form-section {
            border-bottom: 1px solid #e9ecef;
        }

        .section-title {
            background-color: #f8f9fa;
            color: #2c5aa0;
            padding: 8px 15px;
            font-weight: 700;
            font-size: 13px;
            border-bottom: 2px solid #2c5aa0;
            position: sticky;
            top: 118px;
            z-index: 50;
        }

        .form-grid {
            padding: 12px 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
            color: #444;
        }

        label .required {
            color: #dc3545;
            margin-left: 2px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            border-width: 2px;
            padding: 9px 11px;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .readonly {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        /* Modern Service Instance Card */
        .instance-card {
            background: #ffffff;
            padding: 0;
            border-radius: 16px;
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-sky) 100%);
            color: white;
            border-bottom: none;
            margin-bottom: 0;
        }

        .instance-title {
            font-size: 15px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
        }

        .validation-tag {
            font-size: 11px;
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 10px;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .validation-tag.ok {
            background: #e6ffed;
            color: #137333;
            border-color: #b7f0c2;
        }

        .validation-warning {
            margin-top: 8px;
            font-size: 11px;
            color: #b45309;
            background: #fff7ed;
            border: 1px dashed #fdba74;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .remove-instance {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-instance:hover {
            background: rgba(255,255,255,0.3);
        }

        .instance-body {
            padding: 20px;
        }

        /* Modern Form Sections */
        .modern-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .modern-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .modern-section.service-info { border-left: 4px solid #6366f1; }
        .modern-section.travel-to { border-left: 4px solid #3b82f6; }
        .modern-section.service-time { border-left: 4px solid #10b981; }
        .modern-section.travel-from { border-left: 4px solid #f59e0b; }
        .modern-section.additional-travel { border-left: 4px solid var(--brand-gold); }
        .modern-section.event-summary { border-left: 4px solid var(--brand-navy); background: linear-gradient(135deg, #eef4fb 0%, #e3ecfa 100%); }
        .modern-section.comments-section { border-left: 4px solid #64748b; }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .section-icon.service-info { background: #eef2ff; }
        .section-icon.travel-to { background: #dbeafe; }
        .section-icon.service-time { background: #d1fae5; }
        .section-icon.travel-from { background: #fef3c7; }
        .section-icon.additional-travel { background: #fce7f3; }
        .section-icon.event-summary { background: #ede9fe; }
        .section-icon.comments { background: #f1f5f9; }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-subtitle {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }

        /* Modern Form Grid */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-label {
            font-size: 11px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .field-label .required {
            color: #ef4444;
        }

        /* Modern Inputs */
        .modern-input, .modern-select {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            color: #1e293b;
        }

        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modern-input.readonly {
            background: #f1f5f9;
            color: #64748b;
        }

        .modern-input.highlight {
            font-size: 18px;
            font-weight: 700;
            color: #10b981;
            text-align: center;
        }

        .modern-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            color: #1e293b;
            resize: vertical;
            font-family: inherit;
        }

        .modern-textarea:focus {
            outline: none;
            border-color: #64748b;
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
        }

        /* Button Group */
        .btn-calc {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-calc:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-calc.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-calc.orange:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-calc.pink {
            background: linear-gradient(135deg, var(--brand-gold) 0%, #c77621 100%);
        }

        .btn-calc.pink:hover {
            box-shadow: 0 4px 12px rgba(216, 138, 43, 0.3);
        }

        .input-with-btn {
            display: flex;
            gap: 8px;
        }

        .input-with-btn .modern-input {
            flex: 1;
        }

        /* Reimbursement Badge */
        .reimb-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #059669;
            margin-top: 8px;
            float: right;
        }

        .reimb-badge.pink {
            background: linear-gradient(135deg, #fff6eb 0%, #fde8cf 100%);
            color: #c77621;
        }

        /* Add Instance Button */
        .add-instance-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            width: 100%;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .add-instance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .add-instance-btn:active {
            transform: scale(0.98);
        }

        /* Save Event Button */
        .save-event-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            width: 100%;
        }

        .save-event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
        }

        /* Additional Travel Entry */
        .extra-trip-card {
            background: white;
            border: 1px solid #d8e4f5;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .extra-trip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .extra-trip-title {
            font-size: 12px;
            font-weight: 700;
            color: #be185d;
        }

        .btn-remove-trip {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-add-trip {
            background: linear-gradient(135deg, var(--brand-gold) 0%, #c77621 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-trip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .timesheet-grid {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #d8e4f5;
        }
        .timesheet-grid th {
            background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-sky) 100%);
            color: white;
            padding: 10px;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .timesheet-grid td {
            padding: 8px;
            border: 1px solid #d8e4f5;
            vertical-align: middle;
        }
        .timesheet-grid tr:nth-child(even) td {
            background: var(--brand-light);
        }
        .tiny-note {
            font-size: 11px;
            color: var(--brand-muted);
        }
        /* Summary Stats */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: #1e293b;
        }

        .stat-value.green { color: #10b981; }
        .stat-value.blue { color: #3b82f6; }
        .stat-value.purple { color: #8b5cf6; }

        .stat-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .travel-section {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        .travel-section label {
            font-size: 11px;
        }

        .miles-display {
            font-size: 11px;
            color: #28a745;
            font-weight: 600;
            margin-top: 4px;
            text-align: right;
        }

        /* Empty state for additional travel */
        .empty-state {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 10px;
            color: #94a3b8;
            font-size: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 12px 15px;
        }

        .summary-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #2c5aa0;
        }

        .summary-box label {
            font-size: 10px;
            color: #666;
            display: block;
            margin-bottom: 2px;
        }

        .summary-box .value {
            font-size: 18px;
            font-weight: 700;
            color: #2c5aa0;
        }

        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }

        .fixed-bottom.show {
            display: block;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        button {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background-color: #2c5aa0;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        /* Saved Entries List */
        .entries-list {
            padding: 15px;
        }

        .entry-card {
            background: white;
            border: 1.5px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .entry-title {
            font-weight: 700;
            font-size: 14px;
            color: #2c5aa0;
        }

        .entry-date {
            font-size: 11px;
            color: #666;
        }

        .entry-details {
            font-size: 12px;
            color: #555;
            margin-bottom: 8px;
        }

        .entry-details div {
            margin-bottom: 4px;
        }

        .entry-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .entry-actions button {
            padding: 8px;
            font-size: 12px;
        }

        .no-entries {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .autosave-indicator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .autosave-indicator.show {
            opacity: 1;
        }

        /* Toast/Alert messages */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background: #dc3545;
            color: white;
        }

        .toast.success {
            background: #28a745;
            color: white;
        }

        .toast.warning {
            background: #ffc107;
            color: #000;
        }

        /* Login/Auth styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-box {
            background: white;
            padding: 30px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .auth-box h2 {
            color: #2c5aa0;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-box p {
            color: #666;
            font-size: 13px;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-form-group {
            margin-bottom: 16px;
        }

        .auth-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 13px;
            color: #444;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .auth-link {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #2c5aa0;
            cursor: pointer;
        }

        /* Dashboard styles */
        .dashboard-container {
            padding: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #2c5aa0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            color: #2c5aa0;
            font-weight: 700;
            margin-top: 4px;
        }

        .quick-actions {
            background: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }

        .filter-tab:hover {
            background: #e0e0e0;
        }

        .filter-tab.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .quick-actions h3 {
            font-size: 15px;
            color: #2c5aa0;
            margin-bottom: 12px;
        }

        .action-buttons {
            display: grid;
            gap: 10px;
        }

        .action-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3f75 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Admin styles */
        .admin-header {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .admin-header h2 {
            font-size: 18px;
            color: #2c5aa0;
            margin-bottom: 4px;
        }

        .staff-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .staff-item {
            padding: 14px 16px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }

        .staff-item:last-child {
            border-bottom: none;
        }

        .staff-item:active {
            background: #f8f9fa;
        }

        .staff-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c5aa0;
            margin-bottom: 4px;
        }

        .staff-meta {
            font-size: 11px;
            color: #666;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-info .name {
            font-size: 12px;
            font-weight: 600;
        }

        .user-info .role {
            font-size: 10px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .role-badge {
            background: rgba(255,193,7,0.9);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .role-badge.admin {
            background: rgba(220,53,69,0.9);
            color: white;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .header,
            .fixed-bottom,
            .entry-actions {
                display: none !important;
            }

            .container {
                display: block !important;
            }

            .section-title {
                position: static;
            }
        }

        /* PRF Document Styles */
        .prf-document {
            background: white;
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
        }

        .prf-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .prf-header h1 {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: #000;
        }

        .prf-header h2 {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            color: #333;
        }

        .prf-header h3 {
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0 0 0;
            color: #000;
        }

        .prf-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .prf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .prf-table th,
        .prf-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        .prf-table th {
            background: #e0e0e0;
            font-weight: bold;
            text-align: center;
            font-size: 10px;
        }

        .prf-table td.date {
            width: 80px;
            text-align: center;
        }

        .prf-table td.miles,
        .prf-table td.mileage,
        .prf-table td.other {
            width: 70px;
            text-align: right;
        }

        .prf-table td.notes {
            width: 80px;
        }

        .prf-table tfoot td {
            font-weight: bold;
            background: #f0f0f0;
        }

        .prf-totals {
            margin-top: 20px;
            border-top: 2px solid #000;
            padding-top: 10px;
        }

        .prf-totals-row {
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .prf-totals-row span {
            min-width: 120px;
        }

        .prf-totals-row strong {
            min-width: 80px;
            text-align: right;
        }

        .prf-signatures {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .prf-signature-line {
            margin-bottom: 25px;
        }

        .prf-signature-line .line {
            border-bottom: 1px solid #000;
            height: 30px;
            margin-bottom: 5px;
        }

        .prf-signature-line .label {
            font-size: 10px;
            color: #333;
        }

        /* PRF Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #prfOutputView,
            #prfOutputView * {
                visibility: visible;
            }

            #prfOutputView {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }

            .prf-document {
                padding: 20px;
                max-width: none;
            }

            .prf-table {
                page-break-inside: auto;
            }

            .prf-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .prf-signatures {
                page-break-inside: avoid;
            }
        }

        /* =============================================
           SIMPLIFIED UI - Easy Mode Styles
           ============================================= */

        /* Big 3-Button Navigation */
        .simple-nav {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
        }

        .simple-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 90px;
        }

        .simple-nav-btn:hover {
            border-color: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .simple-nav-btn.active {
            background: #2c5aa0;
            border-color: #2c5aa0;
            color: white;
        }

        .simple-nav-btn .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .simple-nav-btn .label {
            font-size: 14px;
            font-weight: 700;
            text-align: center;
        }

        /* Simple Dashboard */
        .simple-dashboard {
            padding: 20px;
        }

        .simple-welcome {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .simple-welcome h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .simple-welcome p {
            opacity: 0.9;
            font-size: 14px;
        }

        .simple-big-button {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            padding: 24px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            text-align: left;
        }

        .simple-big-button:hover {
            border-color: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .simple-big-button.primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }

        .simple-big-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .simple-big-button .btn-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .simple-big-button .btn-text {
            flex: 1;
        }

        .simple-big-button .btn-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .simple-big-button .btn-subtitle {
            font-size: 13px;
            opacity: 0.7;
        }

        .simple-big-button .btn-arrow {
            font-size: 24px;
            opacity: 0.5;
        }

        /* Wizard Steps */
        .wizard-container {
            padding: 20px;
        }

        .wizard-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .wizard-step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .wizard-step-dot.active {
            background: #2c5aa0;
            transform: scale(1.3);
        }

        .wizard-step-dot.completed {
            background: #28a745;
        }

        .wizard-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .wizard-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-title {
            text-align: center;
            margin-bottom: 24px;
        }

        .wizard-title h3 {
            font-size: 22px;
            color: #333;
            margin-bottom: 8px;
        }

        .wizard-title p {
            color: #666;
            font-size: 14px;
        }

        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wizard-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wizard-option:hover {
            border-color: #2c5aa0;
            background: #f8faff;
        }

        .wizard-option.selected {
            border-color: #2c5aa0;
            background: #e8f0fe;
        }

        .wizard-option .option-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 12px;
        }

        .wizard-option.selected .option-icon {
            background: #2c5aa0;
        }

        .wizard-option .option-text {
            flex: 1;
        }

        .wizard-option .option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .wizard-option .option-desc {
            font-size: 12px;
            color: #666;
        }

        .wizard-input-group {
            margin-bottom: 20px;
        }

        .wizard-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .wizard-input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .wizard-input:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .wizard-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .wizard-btn {
            flex: 1;
            padding: 18px 24px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wizard-btn.back {
            background: #f0f0f0;
            color: #333;
        }

        .wizard-btn.next {
            background: #2c5aa0;
            color: white;
        }

        .wizard-btn.submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .wizard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Simple Entry History */
        .simple-entry-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .simple-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .simple-entry-client {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .simple-entry-date {
            font-size: 13px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .simple-entry-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .simple-entry-stat {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .simple-entry-stat .value {
            font-size: 20px;
            font-weight: 700;
            color: #2c5aa0;
        }

        .simple-entry-stat .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        /* Admin-only badge */
        .admin-section {
            border-top: 3px solid #dc3545;
            margin-top: 30px;
            padding-top: 20px;
        }

        .admin-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #dc3545;
            font-weight: 700;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div>
                <h1>Staff Invoice Sheet</h1>
                <h2>Epworth Village</h2>
            </div>
            <div class="user-header" id="userHeader" style="display: none;">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-info">
                    <div class="name" id="userName"></div>
                    <div class="role" id="userRole"></div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <div class="week-badge" id="weekBadge">Week</div>
        </div>
        <!-- Simplified 3-Button Navigation -->
        <div class="simple-nav" id="simpleNav" style="display: none;">
            <button id="simpleTabHome" class="simple-nav-btn active" onclick="showSimpleView('home')">
                <span class="icon">üè†</span>
                <span class="label">Home</span>
            </button>
            <button id="simpleTabAdd" class="simple-nav-btn" onclick="showSimpleView('add')">
                <span class="icon">‚ûï</span>
                <span class="label">Add Entry</span>
            </button>
            <button id="simpleTabHistory" class="simple-nav-btn" onclick="showSimpleView('history')">
                <span class="icon">üìã</span>
                <span class="label">My Entries</span>
            </button>
        </div>

        <!-- Old nav bar (hidden, kept for admin) -->
        <div class="nav-bar" id="navBar" style="display: none;">
            <div class="main-tabs">
                <button id="tabHome" class="nav-tab active" onclick="showMainView('home')">üè† Home</button>
                <button id="tabNewInvoice" class="nav-tab" onclick="showMainView('newInvoice')">üìù New Invoice</button>
                <button id="tabMyInvoices" class="nav-tab" onclick="showMainView('myInvoices')">üìã My Invoices</button>
                <button id="tabClients" class="nav-tab" onclick="showMainView('clients')">üë• Clients</button>
                <button id="tabAdmin" class="nav-tab admin-only" onclick="showMainView('admin')" style="display: none;">‚öôÔ∏è Admin</button>
            </div>
        </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="container active">
        <div class="auth-container">
            <div class="auth-box">
                <h2>Staff Login</h2>
                <p>Sign in to access your invoice sheets</p>

                <!-- Email/Password Login -->
                <form id="loginForm" onsubmit="handleEmailLogin(event)">
                    <div class="auth-form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required autocomplete="email">
                    </div>
                    <div class="auth-form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="auth-btn">Sign In</button>
                </form>
                <div id="forgotPasswordLink" class="auth-link" onclick="handleForgotPassword()">
                    Forgot Password?
                </div>
                <div id="signupLink" class="auth-link" onclick="showView('signupView')" style="margin-top: 10px;">
                    Don't have an account? <strong>Sign Up</strong>
                </div>
                <div id="localAuthInfo" class="auth-link" style="display: none; margin-top: 15px; font-size: 11px; color: #666;">
                    <strong>Default Login:</strong><br>
                    Email: bhinrichs@epworthfamilyresources.org<br>
                    Password: baseball1380
                </div>
            </div>
        </div>
    </div>

    <!-- SIGNUP VIEW -->
    <div id="signupView" class="container">
        <div class="auth-container">
            <div class="auth-box">
                <h2>Create Account</h2>
                <p>Sign up to start tracking your invoices</p>

                <form id="signupForm" onsubmit="handleSignup(event)">
                    <div class="auth-form-group">
                        <label>Full Name</label>
                        <input type="text" id="signupName" required autocomplete="name" placeholder="John Doe">
                    </div>
                    <div class="auth-form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" required autocomplete="email" placeholder="john@example.com">
                    </div>
                    <div class="auth-form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" required autocomplete="new-password" placeholder="Min 8 chars, 1 number, 1 special">
                    </div>
                    <div class="auth-form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="auth-btn">Create Account</button>
                </form>
                <div class="auth-link" onclick="showView('loginView')" style="margin-top: 15px;">
                    Already have an account? <strong>Sign In</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- PASSWORD CHANGE VIEW -->
    <div id="passwordChangeView" class="container">
        <div class="auth-container">
            <div class="auth-box">
                <button onclick="showView(currentUserData?.role === 'admin' ? 'adminDashboardView' : 'dashboardView')" style="background: #2c5aa0; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; cursor: pointer;">‚Üê Back</button>
                <h2>Change Password</h2>
                <p>Please update your password to continue</p>
                <form id="passwordChangeForm" onsubmit="handlePasswordChange(event)">
                    <div class="auth-form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required autocomplete="current-password">
                    </div>
                    <div class="auth-form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required autocomplete="new-password">
                    </div>
                    <div class="auth-form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="auth-btn">Update Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- =============================================
         SIMPLIFIED UI VIEWS
         ============================================= -->

    <!-- SIMPLE HOME VIEW -->
    <div id="simpleHomeView" class="container">
        <div class="simple-dashboard">
            <div class="simple-welcome">
                <h2>Welcome Back!</h2>
                <p id="simpleUserGreeting">Ready to log your work?</p>
            </div>

            <!-- Main Action - Add New Entry -->
            <button class="simple-big-button primary" onclick="showSimpleView('add')">
                <span class="btn-icon">‚ûï</span>
                <div class="btn-text">
                    <div class="btn-title">Add New Entry</div>
                    <div class="btn-subtitle">Log a visit or service</div>
                </div>
                <span class="btn-arrow">‚Üí</span>
            </button>

            <!-- View History -->
            <button class="simple-big-button" onclick="showSimpleView('history')">
                <span class="btn-icon">üìã</span>
                <div class="btn-text">
                    <div class="btn-title">My Entries</div>
                    <div class="btn-subtitle" id="simpleEntryCount">View your recent work</div>
                </div>
                <span class="btn-arrow">‚Üí</span>
            </button>

            <!-- Quick Stats -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                <div class="simple-entry-stat">
                    <div class="value" id="simpleHoursThisWeek">0</div>
                    <div class="label">Hours This Week</div>
                </div>
                <div class="simple-entry-stat">
                    <div class="value" id="simpleMilesThisWeek">0</div>
                    <div class="label">Miles This Week</div>
                </div>
            </div>

            <!-- Admin Section (only shown for admins) -->
            <div id="simpleAdminSection" class="admin-section" style="display: none;">
                <div class="admin-section-header">
                    <span>‚öôÔ∏è</span>
                    <span>Admin Tools</span>
                </div>
                <button class="simple-big-button" onclick="showView('adminDashboardView')">
                    <span class="btn-icon">üë§</span>
                    <div class="btn-text">
                        <div class="btn-title">Admin Dashboard</div>
                        <div class="btn-subtitle">Manage users, view all entries</div>
                    </div>
                    <span class="btn-arrow">‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SIMPLE ADD ENTRY VIEW (Wizard) -->
    <div id="simpleAddView" class="container">
        <div class="wizard-container">
            <!-- Progress Dots -->
            <div class="wizard-progress">
                <div class="wizard-step-dot active" id="wizardDot1"></div>
                <div class="wizard-step-dot" id="wizardDot2"></div>
                <div class="wizard-step-dot" id="wizardDot3"></div>
                <div class="wizard-step-dot" id="wizardDot4"></div>
                <div class="wizard-step-dot" id="wizardDot5"></div>
            </div>

            <!-- Step 1: Pick Client -->
            <div class="wizard-step active" id="wizardStep1">
                <div class="wizard-title">
                    <h3>Who did you see?</h3>
                    <p>Select the client you visited</p>
                </div>
                <div class="wizard-input-group">
                    <input type="text" class="wizard-input" id="wizardClientSearch" placeholder="Type to search clients..." oninput="filterWizardClients()">
                </div>
                <div class="wizard-options" id="wizardClientList">
                    <!-- Clients will be populated here -->
                </div>
                <div class="wizard-buttons">
                    <button class="wizard-btn back" onclick="showSimpleView('home')">Cancel</button>
                    <button class="wizard-btn next" onclick="wizardNext()" id="wizardNext1" disabled>Next</button>
                </div>
            </div>

            <!-- Step 2: Pick Service Type -->
            <div class="wizard-step" id="wizardStep2">
                <div class="wizard-title">
                    <h3>What did you do?</h3>
                    <p>Select the type of service</p>
                </div>
                <div class="wizard-options">
                    <div class="wizard-option" onclick="selectWizardService('IHFS')">
                        <div class="option-icon">üè†</div>
                        <div class="option-text">
                            <div class="option-title">IHFS</div>
                            <div class="option-desc">In Home Family Support</div>
                        </div>
                    </div>
                    <div class="wizard-option" onclick="selectWizardService('OHFS')">
                        <div class="option-icon">üè¢</div>
                        <div class="option-text">
                            <div class="option-title">OHFS</div>
                            <div class="option-desc">Out of Home Family Support</div>
                        </div>
                    </div>
                    <div class="wizard-option" onclick="selectWizardService('PTSV')">
                        <div class="option-icon">üéØ</div>
                        <div class="option-text">
                            <div class="option-title">PTSV</div>
                            <div class="option-desc">Parenting Time Supervised Visitation</div>
                        </div>
                    </div>
                    <div class="wizard-option" onclick="selectWizardService('PTSV-C')">
                        <div class="option-icon">üß≠</div>
                        <div class="option-text">
                            <div class="option-title">PTSV-C</div>
                            <div class="option-desc">Parenting Time with Coaching</div>
                        </div>
                    </div>
                    <div class="wizard-option" onclick="selectWizardService('DT.Urine')">
                        <div class="option-icon">üß™</div>
                        <div class="option-text">
                            <div class="option-title">Drug Testing</div>
                            <div class="option-desc">Select the right testing type</div>
                        </div>
                    </div>
                </div>
                <div class="wizard-buttons">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn next" onclick="wizardNext()" id="wizardNext2" disabled>Next</button>
                </div>
            </div>

            <!-- Step 3: Date and Time -->
            <div class="wizard-step" id="wizardStep3">
                <div class="wizard-title">
                    <h3>When was it?</h3>
                    <p>Enter the date and times</p>
                </div>
                <div class="wizard-input-group">
                    <label>Date</label>
                    <input type="date" class="wizard-input" id="wizardDate">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="wizard-input-group">
                        <label>Start Time</label>
                        <input type="time" class="wizard-input" id="wizardTimeIn">
                    </div>
                    <div class="wizard-input-group">
                        <label>End Time</label>
                        <input type="time" class="wizard-input" id="wizardTimeOut">
                    </div>
                </div>
                <div class="wizard-input-group">
                    <label>Hours Worked</label>
                    <input type="text" class="wizard-input" id="wizardHours" readonly style="background: #f0f0f0; font-size: 24px; text-align: center; font-weight: bold; color: #28a745;">
                </div>
                <div class="wizard-buttons">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn next" onclick="wizardNext()">Next</button>
                </div>
            </div>

            <!-- Step 4: Travel/Miles -->
            <div class="wizard-step" id="wizardStep4">
                <div class="wizard-title">
                    <h3>How far did you travel?</h3>
                    <p>Enter your mileage</p>
                </div>
                <div class="wizard-input-group">
                    <label>Miles Driven (round trip)</label>
                    <input type="number" class="wizard-input" id="wizardMiles" placeholder="Enter total miles" step="0.1" style="font-size: 24px; text-align: center;">
                </div>
                <div style="background: #e8f5e9; padding: 16px; border-radius: 12px; text-align: center; margin-top: 12px;">
                    <div style="font-size: 14px; color: #666;">Estimated Reimbursement</div>
                    <div style="font-size: 28px; font-weight: 700; color: #28a745;" id="wizardReimbursement">$0.00</div>
                    <div style="font-size: 12px; color: #999;">at $0.70 per mile</div>
                </div>
                <div class="wizard-buttons">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn next" onclick="wizardNext()">Next</button>
                </div>
            </div>

            <!-- Step 5: Review & Submit -->
            <div class="wizard-step" id="wizardStep5">
                <div class="wizard-title">
                    <h3>Review & Save</h3>
                    <p>Make sure everything looks correct</p>
                </div>
                <div class="simple-entry-card">
                    <div class="simple-entry-header">
                        <div class="simple-entry-client" id="wizardReviewClient">Client Name</div>
                        <div class="simple-entry-date" id="wizardReviewDate">Date</div>
                    </div>
                    <div style="margin-bottom: 12px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                        <span style="font-weight: 600;" id="wizardReviewService">Service Type</span>
                    </div>
                    <div class="simple-entry-details">
                        <div class="simple-entry-stat">
                            <div class="value" id="wizardReviewHours">0</div>
                            <div class="label">Hours</div>
                        </div>
                        <div class="simple-entry-stat">
                            <div class="value" id="wizardReviewMiles">0</div>
                            <div class="label">Miles</div>
                        </div>
                        <div class="simple-entry-stat">
                            <div class="value" id="wizardReviewReimb">$0</div>
                            <div class="label">Reimb.</div>
                        </div>
                    </div>
                </div>
                <div class="wizard-input-group">
                    <label>Notes (optional)</label>
                    <textarea class="wizard-input" id="wizardNotes" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
                <div class="wizard-buttons">
                    <button class="wizard-btn back" onclick="wizardBack()">Back</button>
                    <button class="wizard-btn submit" onclick="wizardSubmit()">Save Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIMPLE HISTORY VIEW -->
    <div id="simpleHistoryView" class="container">
        <div class="simple-dashboard">
            <h2 style="margin-bottom: 20px; color: #333;">My Entries</h2>

            <!-- Quick Stats -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="simple-entry-stat">
                    <div class="value" id="historyTotalEntries">0</div>
                    <div class="label">Total Entries</div>
                </div>
                <div class="simple-entry-stat">
                    <div class="value" id="historyTotalHours">0</div>
                    <div class="label">Total Hours</div>
                </div>
                <div class="simple-entry-stat">
                    <div class="value" id="historyTotalMiles">0</div>
                    <div class="label">Total Miles</div>
                </div>
            </div>

            <!-- Entry List -->
            <div id="simpleEntryList">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
                    <div>No entries yet</div>
                    <button class="simple-big-button primary" onclick="showSimpleView('add')" style="margin-top: 20px;">
                        <span class="btn-icon">‚ûï</span>
                        <div class="btn-text">
                            <div class="btn-title">Add Your First Entry</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================
         END SIMPLIFIED UI VIEWS
         ============================================= -->

    <!-- STAFF DASHBOARD VIEW (Original - for advanced mode) -->
    <div id="dashboardView" class="container">
        <div class="dashboard-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Draft Invoices</div>
                    <div class="stat-value" id="draftCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Submitted</div>
                    <div class="stat-value" id="submittedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week Hours</div>
                    <div class="stat-value" id="weekHours">0.0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Month Hours</div>
                    <div class="stat-value" id="monthHours">0.0</div>
                </div>
            </div>

            <div class="quick-actions">
                <h3>Staff Members</h3>
                <div id="staffMembersList" class="action-buttons"></div>
            </div>

            <div class="quick-actions" style="margin-top: 15px;">
                <h3>Account Settings</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="showView('passwordChangeView')">
                        <span>Change Password</span>
                        <span>‚Üí</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MY INVOICES VIEW -->
    <div id="myInvoicesView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>My Invoices</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">View and manage your submitted invoices</p>
            </div>
            <div class="filter-tabs" style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button class="filter-tab active" data-filter="all" onclick="filterMyInvoices('all')">All</button>
                <button class="filter-tab" data-filter="daily" onclick="filterMyInvoices('daily')">Today</button>
                <button class="filter-tab" data-filter="weekly" onclick="filterMyInvoices('weekly')">This Week</button>
                <button class="filter-tab" data-filter="monthly" onclick="filterMyInvoices('monthly')">This Month</button>
            </div>
            <div id="myInvoicesList"></div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD VIEW -->
    <div id="adminDashboardView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>Admin Dashboard</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">Manage staff and invoices</p>
            </div>

            <!-- Admin Stats -->
            <div class="stats-grid" id="adminStats">
                <div class="stat-card">
                    <div class="stat-label">Pending Review</div>
                    <div class="stat-value" id="adminPendingCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="adminUserCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Approved (Month)</div>
                    <div class="stat-value" id="adminApprovedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-value" id="adminClientCount">0</div>
                </div>
            </div>

            <div class="quick-actions">
                <h3>Admin Tools</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="showView('adminAllInvoicesView')">
                        <span>All Invoices</span>
                        <span>‚Üí</span>
                    </button>
                    <button class="action-btn" onclick="showView('adminUserManagementView')">
                        <span>User Management</span>
                        <span>‚Üí</span>
                    </button>
                    <button class="action-btn" onclick="showView('travelLogGeneratorView')" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                        <span>Travel Log Generator</span>
                        <span>‚Üí</span>
                    </button>
                    <a href="prf-generator.html" class="action-btn" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); text-decoration: none; display: flex;">
                        <span>PRF Generator</span>
                        <span>‚Üí</span>
                    </a>
                </div>
            </div>

            <div class="quick-actions" style="margin-top: 15px;">
                <h3>Staff Members</h3>
            </div>
            <div id="adminStaffList" class="staff-list"></div>
        </div>
    </div>

    <!-- ADMIN STAFF DETAIL VIEW -->
    <div id="adminStaffDetailView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <button onclick="showView('adminDashboardView')" style="background: #2c5aa0; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 10px; cursor: pointer;">‚Üê Back to Admin</button>
                <h2 id="staffDetailName"></h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;" id="staffDetailEmail"></p>
            </div>
            <div id="staffInvoicesList"></div>
        </div>
    </div>

    <!-- ADMIN USER MANAGEMENT VIEW -->
    <div id="adminUserManagementView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>User Management</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">Manage user accounts and permissions</p>
            </div>
            <div class="quick-actions" style="margin-bottom: 15px;">
                <button class="action-btn" onclick="showAddUserForm()" style="width: 100%;">
                    <span>+ Add New User</span>
                    <span>‚Üí</span>
                </button>
            </div>
            <div id="addUserFormContainer" style="display: none; background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h3 style="color: #2c5aa0; margin-bottom: 15px; font-size: 14px;">Add New User</h3>
                <form id="addUserForm" onsubmit="handleAddUser(event)">
                    <div class="auth-form-group">
                        <label>Full Name</label>
                        <input type="text" id="newUserName" required placeholder="John Doe">
                    </div>
                    <div class="auth-form-group">
                        <label>Email</label>
                        <input type="email" id="newUserEmail" required placeholder="john@example.com">
                    </div>
                    <div class="auth-form-group">
                        <label>Temporary Password</label>
                        <input type="text" id="newUserPassword" required placeholder="Temp123!@#" value="TempPass123!">
                    </div>
                    <div class="auth-form-group">
                        <label>Role</label>
                        <select id="newUserRole">
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-success" style="flex: 1;">Create User</button>
                        <button type="button" class="btn-secondary" onclick="hideAddUserForm()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
            <div id="userManagementList"></div>
        </div>
    </div>

    <!-- ADMIN CLIENT MANAGEMENT VIEW -->
    <div id="adminClientManagementView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>Client Management</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">Manage clients, addresses, and master case numbers</p>
            </div>
            <div class="quick-actions" style="margin-bottom: 15px;">
                <button class="action-btn" onclick="showAddClientForm()" style="width: 100%;">
                    <span>+ Add New Client</span>
                    <span>‚Üí</span>
                </button>
            </div>
            <div id="addClientFormContainer" style="display: none; background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h3 style="color: #2c5aa0; margin-bottom: 15px; font-size: 14px;">Add New Client</h3>
                <form id="addClientForm" onsubmit="handleAddClient(event)">
                    <div class="auth-form-group">
                        <label>Client Name (Last, First)</label>
                        <input type="text" id="newClientName" required placeholder="Doe, John">
                    </div>
                    <div class="auth-form-group">
                        <label>Master Case Number</label>
                        <input type="text" id="newClientMasterCase" required placeholder="MC-12345">
                    </div>
                    <div class="auth-form-group">
                        <label>Primary Address (from referral)</label>
                        <input type="text" id="newClientAddress" placeholder="123 Main St, City, State ZIP">
                    </div>
                    <div id="additionalAddresses"></div>
                    <button type="button" onclick="addAddressField()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; cursor: pointer;">
                        + Add Another Address
                    </button>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-success" style="flex: 1;">Add Client</button>
                        <button type="button" class="btn-secondary" onclick="hideAddClientForm()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
            <div id="clientManagementList"></div>
        </div>
    </div>

    <!-- CLIENT DETAIL VIEW -->
    <div id="clientDetailView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <button onclick="showView('adminClientManagementView')" style="background: #2c5aa0; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 10px; cursor: pointer;">‚Üê Back to Clients</button>
                <h2 id="clientDetailName"></h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;" id="clientDetailMasterCase"></p>
            </div>
            <div class="quick-actions" style="margin-bottom: 15px;">
                <h3>Addresses</h3>
                <button class="action-btn" onclick="showAddAddressToClientForm()" style="width: 100%; margin-top: 10px;">
                    <span>+ Add Address</span>
                    <span>‚Üí</span>
                </button>
            </div>
            <div id="addAddressToClientContainer" style="display: none; background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h3 style="color: #2c5aa0; margin-bottom: 15px; font-size: 14px;">Add Address</h3>
                <form id="addAddressToClientForm" onsubmit="handleAddAddressToClient(event)">
                    <div class="auth-form-group">
                        <label>Address Label</label>
                        <input type="text" id="addressLabel" required placeholder="Home, Work, School, etc.">
                    </div>
                    <div class="auth-form-group">
                        <label>Full Address</label>
                        <input type="text" id="addressFull" required placeholder="123 Main St, City, State ZIP">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-success" style="flex: 1;">Add Address</button>
                        <button type="button" class="btn-secondary" onclick="hideAddAddressToClientForm()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
            <div id="clientAddressList"></div>
        </div>
    </div>

    <!-- ADMIN ALL INVOICES VIEW -->
    <div id="adminAllInvoicesView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>All Invoices</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">View and manage all staff invoices</p>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 11px;">Status Filter</label>
                        <select id="invoiceStatusFilter" onchange="loadAllInvoices()">
                            <option value="all">All Statuses</option>
                            <option value="submitted">Submitted (Pending)</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 11px;">Date Range</label>
                        <select id="invoiceDateFilter" onchange="loadAllInvoices()">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="allInvoicesList"></div>
        </div>
    </div>

    <!-- FORM VIEW -->
    <div id="formView" class="container active">
        <form id="invoiceForm">
            <!-- Back Button -->
            <div class="form-section" style="padding: 10px 15px; border-bottom: none;">
                <button type="button" onclick="goBackFromForm()" style="background: #2c5aa0; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    ‚Üê Back to Dashboard
                </button>
            </div>

            <!-- Staff & Month Info -->
            <div class="form-section">
                <div class="section-title">Staff & Invoice Period</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Staff Name <span class="required">*</span></label>
                        <select name="staffName" id="staffNameSelect" required>
                            <option value="">-- Select Staff Member --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Invoice Month <span class="required">*</span></label>
                        <input type="month" id="invoiceMonth" name="invoiceMonth" required onchange="updateMonthBadge()">
                    </div>
                </div>
            </div>

            <!-- Service Instances -->
            <div class="form-section">
                <div class="section-title">Service Instances</div>
                <div class="form-grid">
                    <div id="instancesContainer">
                        <!-- Service instances will be added here -->
                    </div>
                    <button type="button" class="add-instance-btn" onclick="openExcelImport()" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); margin-bottom: 10px;">
                        <span>üìä</span> Import from Excel/CSV
                    </button>
                    <button type="button" class="add-instance-btn" onclick="copyLastServiceInstance()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); margin-bottom: 10px;">
                        <span>‚éò</span> Copy Last Entry
                    </button>
                    <button type="button" class="add-instance-btn" onclick="addServiceInstance()">
                        <span>+</span> Add Service Instance
                    </button>
                </div>
            </div>

            <!-- Timesheet Summary -->
            <div class="form-section" id="timesheetSummarySection" style="display: none;">
                <div class="section-title">üìã Timesheet Summary</div>
                <div style="overflow-x: auto;">
                    <table id="timesheetTable" style="width: 100%; border-collapse: collapse; font-size: 11px; background: white;">
                        <thead>
                            <tr style="background: #2c5aa0; color: white;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Date</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Client</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Service</th>
                                <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">Time</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Hours</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Miles</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Reimb</th>
                            </tr>
                        </thead>
                        <tbody id="timesheetTableBody">
                            <!-- Rows will be populated dynamically -->
                        </tbody>
                        <tfoot id="timesheetTableFoot" style="background: #e9ecef; font-weight: 600;">
                            <!-- Totals will be populated dynamically -->
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Saved Events History -->
            <div class="form-section" id="savedEventsSection">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üìÇ Saved Events History</span>
                    <button type="button" onclick="refreshEventHistory()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="savedEventsContainer" style="max-height: 400px; overflow-y: auto;">
                    <div style="color: #6c757d; font-size: 12px; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 6px;">
                        No saved events yet. Complete and save service events to see them here.
                    </div>
                </div>
            </div>

            <!-- Monthly Totals -->
            <div class="form-section">
                <div class="section-title">Monthly Totals</div>
                <div class="summary-grid">
                    <div class="summary-box">
                        <label>Billable Hours</label>
                        <div class="value" id="totalBillableHours">0.00</div>
                    </div>
                    <div class="summary-box">
                        <label>Drive Time (hrs)</label>
                        <div class="value" id="totalDriveTime">0.00</div>
                    </div>
                    <div class="summary-box">
                        <label>Total Mileage</label>
                        <div class="value" id="totalMileage">0.0 mi</div>
                    </div>
                    <div class="summary-box">
                        <label>Mileage Reimbursement</label>
                        <div class="value" id="totalReimbursement">$0.00</div>
                    </div>
                </div>
            </div>

            <!-- Generate PRF Section -->
            <div class="form-section" id="prfGeneratorSection">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üìÑ Personal Reimbursement Form (PRF)</span>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
                        Generate an official PRF document from your saved service events. This will create a printable form with all travel entries grouped by date.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" onclick="generatePRF()" class="btn-primary" style="padding: 12px 20px; font-size: 14px; font-weight: 600; background: linear-gradient(135deg, #2c5aa0, #1e3d6e);">
                            üìÑ Generate PRF
                        </button>
                        <button type="button" onclick="generatePRFFromHistory()" style="padding: 12px 20px; font-size: 14px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìÇ Generate from Saved Events
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save & Review Button -->
            <div class="form-section" style="padding-top: 0;">
                <button type="button" onclick="saveAndReviewInvoice()" class="btn-success" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                    Save & Review Invoice
                </button>
            </div>
        </form>
    </div>

    <!-- PRF OUTPUT VIEW -->
    <div id="prfOutputView" class="container">
        <div class="no-print" style="margin-bottom: 15px;">
            <button onclick="showView('formView')" style="background: #2c5aa0; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-right: 10px;">‚Üê Back to Form</button>
            <button onclick="window.print()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer;">üñ®Ô∏è Print PRF</button>
        </div>
        <div id="prfContent" class="prf-document">
            <!-- PRF content will be generated here -->
        </div>
    </div>

    <!-- INVOICE SUMMARY VIEW -->
    <div id="invoiceSummaryView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <button onclick="showView('formView')" style="background: #2c5aa0; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 10px; cursor: pointer;">‚Üê Back to Edit</button>
                <h2>Invoice Summary</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;" id="summaryWeekRange"></p>
            </div>

            <!-- Staff Info -->
            <div class="entry-card" style="margin-bottom: 15px;">
                <div class="entry-header">
                    <div>
                        <div class="entry-title" id="summaryStaffName"></div>
                        <div class="entry-date" id="summaryWeekDates"></div>
                    </div>
                    <div id="summaryStatus" style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                        DRAFT
                    </div>
                </div>
            </div>

            <!-- Totals Summary -->
            <div class="stats-grid" style="margin-bottom: 15px;">
                <div class="stat-card">
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-value" id="summaryTotalHours">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Miles</div>
                    <div class="stat-value" id="summaryTotalMiles">0.0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Mileage Pay</div>
                    <div class="stat-value" style="color: white;" id="summaryMileagePay">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Instances</div>
                    <div class="stat-value" id="summaryInstanceCount">0</div>
                </div>
            </div>

            <!-- Mileage Calculation Breakdown -->
            <div class="entry-card" style="margin-bottom: 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                <div class="entry-header">
                    <div>
                        <div class="entry-title" style="color: #2e7d32;">Mileage Reimbursement</div>
                        <div class="entry-date" style="color: #558b2f;">$0.70 per mile</div>
                    </div>
                </div>
                <div class="entry-details" style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                        <span>Total Miles:</span>
                        <strong id="summaryMilesBreakdown">0.0 mi</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                        <span>Rate:</span>
                        <strong>$0.70/mile</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 16px; color: #2e7d32;">
                        <span>Total Reimbursement:</span>
                        <strong id="summaryTotalReimbursement">$0.00</strong>
                    </div>
                </div>
            </div>

            <!-- Service Instances List -->
            <div class="quick-actions" style="margin-bottom: 10px;">
                <h3>Service Instances</h3>
            </div>
            <div id="summaryInstancesList"></div>

            <!-- Action Buttons -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button type="button" onclick="showView('formView')" class="btn-secondary" style="padding: 12px;">
                    Edit Invoice
                </button>
                <button type="button" onclick="submitInvoiceForApproval()" class="btn-success" style="padding: 12px;">
                    Submit for Approval
                </button>
            </div>
            <button type="button" onclick="printInvoiceSummary()" class="btn-primary" style="width: 100%; margin-top: 10px; padding: 12px;">
                Print Invoice
            </button>
        </div>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="container">
        <div class="entries-list" id="entriesList">
            <!-- Entries will be populated here -->
        </div>
    </div>

    <!-- Fixed Bottom Buttons (Only for List View) -->
    <div class="fixed-bottom" id="listViewButtons">
        <div class="button-grid">
            <button type="button" class="btn-primary" onclick="exportAll()">Export All</button>
            <button type="button" class="btn-danger" onclick="clearAllDrafts()">Clear All</button>
        </div>
    </div>

    <div class="autosave-indicator" id="autosaveIndicator">Auto-saved</div>

    <!-- Excel Import Modal -->
    <div id="excelImportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);" onclick="closeExcelImport()"></div>
        <div style="position: relative; background: white; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; max-height: 85vh; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #2c5aa0 0%, #1e3f75 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px;">üìä Import from Excel/CSV</h3>
                <button onclick="closeExcelImport()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div id="excelUploadStep">
                    <div id="excelDropZone" style="border: 3px dashed #2c5aa0; border-radius: 8px; padding: 40px 20px; text-align: center; background: #f8f9fa; cursor: pointer;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <h4>Drop Excel/CSV File Here</h4>
                        <p style="color: #666; font-size: 12px;">or click to browse files</p>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        <button onclick="document.getElementById('excelFileInput').click()" style="background: #2c5aa0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">Choose File</button>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #dee2e6; margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 14px;">Expected Columns:</h5>
                        <p style="font-size: 11px; color: #666; margin: 0;">
                            Client Name, Master Case, Service Type, Date, Time In, Time Out, Travel From, Travel To, Miles, Comments
                        </p>
                    </div>
                </div>
                <div id="excelPreviewStep" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #dee2e6;">
                        <h4 style="margin: 0;">Data Preview</h4>
                        <div style="display: flex; gap: 10px; font-size: 12px;">
                            <span id="excelRowCount" style="background: #d4edda; padding: 4px 8px; border-radius: 4px;">Rows: 0</span>
                            <span id="excelErrorCount" style="background: #f8d7da; padding: 4px 8px; border-radius: 4px;">Errors: 0</span>
                        </div>
                    </div>
                    <div id="excelErrors" style="display: none; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;"></div>
                    <div id="excelPreviewTable" style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            <div style="background: #f8f9fa; padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #dee2e6;">
                <button id="excelBackBtn" onclick="showExcelUploadStep()" style="display: none; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Back</button>
                <button id="excelImportBtn" onclick="importExcelData()" style="display: none; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Import Data</button>
            </div>
        </div>
    </div>

    <!-- TRAVEL LOG GENERATOR VIEW -->
    <div id="travelLogGeneratorView" class="container">
        <div class="dashboard-container">
            <div class="admin-header">
                <h2>DHHS Travel Log Generator</h2>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">Upload timesheets to generate official travel logs</p>
            </div>

            <!-- Upload Area -->
            <div style="border: 3px dashed #2c5aa0; padding: 30px; text-align: center; border-radius: 8px; background: #f8fafc; cursor: pointer; margin: 15px 0;" id="travelLogUploadArea">
                <div style="font-size: 40px;">üìÅ</div>
                <h3 style="margin: 10px 0;">Drop Excel Timesheets Here</h3>
                <p style="color: #666; margin-bottom: 15px;">Supports multiple files (.xlsx, .xls, .csv)</p>
                <input type="file" id="travelLogFileInput" accept=".xlsx,.xls,.csv" multiple style="display: none;">
                <button class="btn-primary" onclick="event.stopPropagation(); document.getElementById('travelLogFileInput').click();" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 6px; cursor: pointer;">Choose Files</button>
            </div>

            <!-- File List -->
            <div id="travelLogFileList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;"></div>

            <!-- Settings -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Month</label>
                    <select id="travelLogMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Year</label>
                    <input type="number" id="travelLogYear" value="2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">Contractor</label>
                    <input type="text" id="travelLogContractor" value="Epworth Village" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="travelLogProcessBtn" onclick="processTimesheets()" style="display: none; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin: 5px;">
                    Generate from Files
                </button>
                <button id="travelLogClearBtn" onclick="clearTravelLogFiles()" style="display: none; padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin: 5px;">
                    Clear All
                </button>
            </div>

            <!-- Saved Events Option -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #a5d6a7;">
                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">Or Generate from Saved Service Events</h4>
                <p style="color: #666; font-size: 12px; margin-bottom: 15px;">Use service events saved in the main Invoice System instead of uploading Excel files.</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="generateTravelLogsFromSavedEvents()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Generate from Saved Events
                    </button>
                    <span id="savedEventsCount" style="color: #666; font-size: 12px;"></span>
                </div>
            </div>

            <!-- Results Preview -->
            <div id="travelLogPreview" style="display: none;">
                <div style="background: #2c5aa0; color: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="travelLogPreviewTitle" style="margin: 0;">Preview</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="printTravelLogs('logs')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Print Travel Logs</button>
                        <button onclick="printTravelLogs('summary')" style="padding: 10px 20px; background: #ffc107; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Print Summaries</button>
                        <button onclick="printTravelLogs('all')" style="padding: 10px 20px; background: white; color: #2c5aa0; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Print All</button>
                    </div>
                </div>
                <div id="travelLogPrintArea" style="background: white; padding: 20px; border: 1px solid #ddd; border-top: none; max-height: 600px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Supabase and App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="firestore-service.js"></script>

    <script>
        /**
         * CONFIGURATION
         */
        const MILEAGE_RATE = 0.70; // $0.70 per mile
        const GOOGLE_MAPS_API_KEY = 'YOUR_API_KEY_HERE'; // Replace with your API key
        const LOCAL_DRAFT_KEY = 'timesheetLocalDraft';

        /**
         * CLIENT DATABASE
         * Add your clients here with their master case numbers
         */
        const CLIENT_DATABASE = {
            "Doe, John": "MC-12345",
            "Smith, Jane": "MC-67890",
            "Johnson, Mike": "MC-54321",
            "Williams, Sarah": "MC-98765",
            "Brown, David": "MC-11111"
            // Add more clients as needed
        };

        const SERVICE_TYPE_OPTIONS = [
            { value: 'OHFS', label: 'OHFS - Out of Home Family Support' },
            { value: 'IHFS', label: 'IHFS - In Home Family Support' },
            { value: 'PTSV', label: 'PTSV - Parenting Time Supervised Visitation' },
            { value: 'PTSV-C', label: 'PTSV-C - Parenting Time Supervision with Coaching' },
            { value: 'DT.Breath', label: 'Drug Testing - Breath' },
            { value: 'DT.Swab', label: 'Drug Testing - Swab' },
            { value: 'DT.Urine', label: 'Drug Testing - Urine' },
            { value: 'DT.Patch', label: 'Drug Testing - Patch' },
            { value: 'DT.Sweat', label: 'Drug Testing - Sweat' }
        ];

        const SERVICE_CODE_MAP = {
            'PTSV': { code: '8873', travel: '9789', travelKids: '3773' },
            'PTSV-C': { code: '8873', travel: '9789', travelKids: '3773' },
            'OHFS': { code: '7443', travel: '2178' },
            'IHFS': { code: '7171', travel: '2178' },
            'PT': { code: '8873', travel: '9789', travelKids: '3773' }, // legacy support
            'FS.OH': { code: '7443', travel: '2178' }, // legacy support
            'FS.IH': { code: '7171', travel: '2178' }  // legacy support
        };

        /**
         * STATE MANAGEMENT
         */
        let currentEditId = null;
        let autoSaveTimeout = null;
        let serviceInstances = [];
        let instanceIdCounter = 0;
        let selectedStaffId = null;

        /**
         * DATE HELPERS
         */
        function parseTimestamp(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (typeof value === 'object' && typeof value.toDate === 'function') {
                try {
                    return value.toDate();
                } catch (error) {
                    console.warn('Timestamp conversion error:', error);
                }
            }
            const parsed = new Date(value);
            return isNaN(parsed) ? null : parsed;
        }

        function formatDateDisplay(value, includeTime = false) {
            const date = parseTimestamp(value);
            if (!date) return 'N/A';
            return includeTime ? date.toLocaleString() : date.toLocaleDateString();
        }

        /**
         * HELPER FUNCTIONS - Toast Messages
         */
        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showPasswordWarning(message) {
            showToast(message, 'warning');
        }

        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * VIEW MANAGEMENT
         */
        let currentViewId = null;

        function showView(viewId, pushState = true) {
            // Don't push duplicate states
            if (pushState && viewId !== currentViewId) {
                history.pushState({ viewId: viewId }, '', `#${viewId}`);
            }
            currentViewId = viewId;

            // Hide all views
            document.querySelectorAll('.container').forEach(view => {
                view.classList.remove('active');
            });

            // Show requested view
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Update header visibility
            const authViews = ['loginView', 'passwordChangeView', 'signupView'];
            const showHeader = !authViews.includes(viewId);
            document.querySelector('.header').style.display = showHeader ? 'block' : 'none';

            // Show nav bar for all logged-in views (not auth views)
            const navBar = document.getElementById('navBar');
            const simpleNav = document.getElementById('simpleNav');
            const weekBadge = document.getElementById('weekBadge');
            const userHeader = document.getElementById('userHeader');

            // Determine if this is a simplified view
            const simpleViews = ['simpleHomeView', 'simpleAddView', 'simpleHistoryView'];
            const isSimpleView = simpleViews.includes(viewId);

            if (showHeader && currentUser) {
                weekBadge.style.display = 'none';
                userHeader.style.display = 'flex';

                // Show simplified nav for simple views, old nav for admin views
                if (isSimpleView) {
                    simpleNav.style.display = 'grid';
                    navBar.style.display = 'none';
                } else {
                    simpleNav.style.display = 'none';
                    navBar.style.display = 'block';
                    // Show admin tab for admin users
                    const adminTab = document.getElementById('tabAdmin');
                    if (adminTab) {
                        adminTab.style.display = currentUserData?.role === 'admin' ? 'block' : 'none';
                    }
                }

                // Update active tab based on current view
                updateActiveTab(viewId);
            } else {
                navBar.style.display = 'none';
                simpleNav.style.display = 'none';
                weekBadge.style.display = 'none';
                userHeader.style.display = 'none';
            }

            // Load data for specific views
            if (viewId === 'dashboardView') {
                loadUserDashboard();
            } else if (viewId === 'myInvoicesView') {
                loadMyInvoicesWithFilter();
            } else if (viewId === 'adminDashboardView') {
                loadAdminDashboard();
            } else if (viewId === 'adminUserManagementView') {
                loadUserManagement();
            } else if (viewId === 'adminClientManagementView') {
                loadClientManagement();
            } else if (viewId === 'adminAllInvoicesView') {
                loadAllInvoices();
            } else if (viewId === 'travelLogGeneratorView') {
                initTravelLogGenerator();
            } else if (viewId === 'formView') {
                // Re-render service instances to ensure clients are loaded
                renderServiceInstances();
            } else if (viewId === 'simpleHomeView') {
                loadSimpleHome();
            } else if (viewId === 'simpleAddView') {
                initWizard();
            } else if (viewId === 'simpleHistoryView') {
                loadSimpleHistory();
            }
        }

        // =============================================
        // SIMPLIFIED UI FUNCTIONS
        // =============================================

        // Wizard state
        let wizardStep = 1;
        let wizardData = {
            client: null,
            clientName: '',
            serviceType: '',
            date: '',
            timeIn: '',
            timeOut: '',
            hours: 0,
            miles: 0,
            notes: ''
        };

        // Show simplified view
        function showSimpleView(view) {
            // Update nav button states
            document.querySelectorAll('.simple-nav-btn').forEach(btn => btn.classList.remove('active'));
            const viewMap = {
                'home': 'simpleHomeView',
                'add': 'simpleAddView',
                'history': 'simpleHistoryView'
            };
            const tabMap = {
                'home': 'simpleTabHome',
                'add': 'simpleTabAdd',
                'history': 'simpleTabHistory'
            };
            const tabBtn = document.getElementById(tabMap[view]);
            if (tabBtn) tabBtn.classList.add('active');

            showView(viewMap[view]);
        }

        // Load Simple Home
        function loadSimpleHome() {
            // Update greeting
            const userName = currentUserData?.displayName || 'there';
            document.getElementById('simpleUserGreeting').textContent = `Hi ${userName.split(' ')[0]}! Ready to log your work?`;

            // Load stats from saved events
            const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());

            let weekHours = 0;
            let weekMiles = 0;

            savedEvents.forEach(event => {
                const eventDate = new Date(event.date || event.serviceDate);
                if (eventDate >= weekStart) {
                    weekHours += parseFloat(event.serviceBillableHours) || 0;
                    weekMiles += parseFloat(event.travelTo?.miles) || 0;
                    weekMiles += parseFloat(event.travelFrom?.miles) || 0;
                }
            });

            document.getElementById('simpleHoursThisWeek').textContent = weekHours.toFixed(1);
            document.getElementById('simpleMilesThisWeek').textContent = Math.round(weekMiles);
            document.getElementById('simpleEntryCount').textContent = `${savedEvents.length} entries total`;

            // Show admin section if admin
            const adminSection = document.getElementById('simpleAdminSection');
            if (adminSection) {
                adminSection.style.display = currentUserData?.role === 'admin' ? 'block' : 'none';
            }
        }

        // Load Simple History
        function loadSimpleHistory() {
            const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
            const container = document.getElementById('simpleEntryList');

            // Calculate totals
            let totalHours = 0;
            let totalMiles = 0;
            savedEvents.forEach(event => {
                totalHours += parseFloat(event.serviceBillableHours) || 0;
                totalMiles += parseFloat(event.travelTo?.miles) || 0;
                totalMiles += parseFloat(event.travelFrom?.miles) || 0;
            });

            document.getElementById('historyTotalEntries').textContent = savedEvents.length;
            document.getElementById('historyTotalHours').textContent = totalHours.toFixed(1);
            document.getElementById('historyTotalMiles').textContent = Math.round(totalMiles);

            if (savedEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
                        <div>No entries yet</div>
                        <button class="simple-big-button primary" onclick="showSimpleView('add')" style="margin-top: 20px;">
                            <span class="btn-icon">‚ûï</span>
                            <div class="btn-text">
                                <div class="btn-title">Add Your First Entry</div>
                            </div>
                        </button>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            const sortedEvents = [...savedEvents].sort((a, b) => {
                const dateA = new Date(a.date || a.serviceDate);
                const dateB = new Date(b.date || b.serviceDate);
                return dateB - dateA;
            });

            container.innerHTML = sortedEvents.map(event => {
                const date = new Date(event.date || event.serviceDate);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const hours = parseFloat(event.serviceBillableHours) || 0;
                const miles = (parseFloat(event.travelTo?.miles) || 0) + (parseFloat(event.travelFrom?.miles) || 0);
                const reimb = miles * 0.70;

                const serviceLabels = {
                    'IHFS': 'IHFS - In Home Family Support',
                    'OHFS': 'OHFS - Out of Home Family Support',
                    'PTSV': 'PTSV - Supervised Visitation',
                    'PTSV-C': 'PTSV-C - Supervision with Coaching',
                    'DT.Urine': 'Drug Testing',
                    'DT.Breath': 'Drug Testing',
                    'DT.Swab': 'Drug Testing',
                    'DT.Patch': 'Drug Testing',
                    'DT.Sweat': 'Drug Testing'
                };

                return `
                    <div class="simple-entry-card">
                        <div class="simple-entry-header">
                            <div class="simple-entry-client">${event.clientName || 'Unknown Client'}</div>
                            <div class="simple-entry-date">${formattedDate}</div>
                        </div>
                        <div style="margin-bottom: 12px; padding: 8px 12px; background: #f0f0f0; border-radius: 8px; font-size: 13px;">
                            ${serviceLabels[event.serviceType] || event.serviceType || 'Service'}
                        </div>
                        <div class="simple-entry-details">
                            <div class="simple-entry-stat">
                                <div class="value">${hours.toFixed(1)}</div>
                                <div class="label">Hours</div>
                            </div>
                            <div class="simple-entry-stat">
                                <div class="value">${Math.round(miles)}</div>
                                <div class="label">Miles</div>
                            </div>
                            <div class="simple-entry-stat">
                                <div class="value">$${reimb.toFixed(0)}</div>
                                <div class="label">Reimb.</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize Wizard
        function initWizard() {
            wizardStep = 1;
            wizardData = {
                client: null,
                clientName: '',
                serviceType: '',
                date: '',
                timeIn: '',
                timeOut: '',
                hours: 0,
                miles: 0,
                notes: ''
            };

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('wizardDate').value = today;

            // Reset wizard steps
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`wizardStep${i}`).classList.remove('active');
                document.getElementById(`wizardDot${i}`).classList.remove('active', 'completed');
            }
            document.getElementById('wizardStep1').classList.add('active');
            document.getElementById('wizardDot1').classList.add('active');

            // Populate client list
            populateWizardClients();

            // Reset selections
            document.querySelectorAll('.wizard-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('wizardNext1').disabled = true;
            document.getElementById('wizardNext2').disabled = true;

            // Add time change listeners
            document.getElementById('wizardTimeIn').addEventListener('change', updateWizardHours);
            document.getElementById('wizardTimeOut').addEventListener('change', updateWizardHours);
            document.getElementById('wizardMiles').addEventListener('input', updateWizardReimbursement);
        }

        // Populate client list for wizard
        function populateWizardClients() {
            const container = document.getElementById('wizardClientList');
            const clients = clientsWithAddresses || SAMPLE_CLIENTS;

            container.innerHTML = clients.slice(0, 8).map(client => `
                <div class="wizard-option" onclick="selectWizardClient('${client.name}', '${client.id || ''}')">
                    <div class="option-icon">üë§</div>
                    <div class="option-text">
                        <div class="option-title">${client.name}</div>
                        <div class="option-desc">${client.masterCase || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // Filter clients in wizard
        function filterWizardClients() {
            const search = document.getElementById('wizardClientSearch').value.toLowerCase();
            const container = document.getElementById('wizardClientList');
            const clients = clientsWithAddresses || SAMPLE_CLIENTS;

            const filtered = clients.filter(c => c.name.toLowerCase().includes(search));

            container.innerHTML = filtered.slice(0, 8).map(client => `
                <div class="wizard-option" onclick="selectWizardClient('${client.name}', '${client.id || ''}')">
                    <div class="option-icon">üë§</div>
                    <div class="option-text">
                        <div class="option-title">${client.name}</div>
                        <div class="option-desc">${client.masterCase || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // Select client
        function selectWizardClient(name, id) {
            wizardData.clientName = name;
            wizardData.client = id;

            // Update visual selection
            document.querySelectorAll('#wizardClientList .wizard-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector('.option-title').textContent === name) {
                    opt.classList.add('selected');
                }
            });

            document.getElementById('wizardNext1').disabled = false;
        }

        // Select service type
        function selectWizardService(type) {
            wizardData.serviceType = normalizeServiceType(type);

            // Update visual selection
            document.querySelectorAll('#wizardStep2 .wizard-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            document.getElementById('wizardNext2').disabled = false;
        }

        // Update hours calculation
        function updateWizardHours() {
            const timeIn = document.getElementById('wizardTimeIn').value;
            const timeOut = document.getElementById('wizardTimeOut').value;

            if (timeIn && timeOut) {
                const [inH, inM] = timeIn.split(':').map(Number);
                const [outH, outM] = timeOut.split(':').map(Number);
                const inMins = inH * 60 + inM;
                const outMins = outH * 60 + outM;
                const diffMins = outMins - inMins;
                const hours = diffMins / 60;

                if (hours > 0) {
                    wizardData.hours = hours;
                    document.getElementById('wizardHours').value = hours.toFixed(2) + ' hours';
                } else {
                    document.getElementById('wizardHours').value = '';
                }
            }
        }

        // Update reimbursement calculation
        function updateWizardReimbursement() {
            const miles = parseFloat(document.getElementById('wizardMiles').value) || 0;
            wizardData.miles = miles;
            const reimb = miles * 0.70;
            document.getElementById('wizardReimbursement').textContent = '$' + reimb.toFixed(2);
        }

        // Navigate wizard forward
        function wizardNext() {
            if (wizardStep >= 5) return;

            // Mark current step as completed
            document.getElementById(`wizardDot${wizardStep}`).classList.remove('active');
            document.getElementById(`wizardDot${wizardStep}`).classList.add('completed');
            document.getElementById(`wizardStep${wizardStep}`).classList.remove('active');

            wizardStep++;

            // Show next step
            document.getElementById(`wizardDot${wizardStep}`).classList.add('active');
            document.getElementById(`wizardStep${wizardStep}`).classList.add('active');

            // If going to review, populate review
            if (wizardStep === 5) {
                populateWizardReview();
            }
        }

        // Navigate wizard backward
        function wizardBack() {
            if (wizardStep <= 1) {
                showSimpleView('home');
                return;
            }

            document.getElementById(`wizardDot${wizardStep}`).classList.remove('active');
            document.getElementById(`wizardStep${wizardStep}`).classList.remove('active');

            wizardStep--;

            document.getElementById(`wizardDot${wizardStep}`).classList.remove('completed');
            document.getElementById(`wizardDot${wizardStep}`).classList.add('active');
            document.getElementById(`wizardStep${wizardStep}`).classList.add('active');
        }

        // Populate review screen
        function populateWizardReview() {
            const date = document.getElementById('wizardDate').value;
            wizardData.date = date;
            wizardData.timeIn = document.getElementById('wizardTimeIn').value;
            wizardData.timeOut = document.getElementById('wizardTimeOut').value;
            wizardData.miles = parseFloat(document.getElementById('wizardMiles').value) || 0;

            const serviceLabels = {
                'IHFS': 'IHFS - In Home Family Support',
                'OHFS': 'OHFS - Out of Home Family Support',
                'PTSV': 'PTSV - Supervised Visitation',
                'PTSV-C': 'PTSV-C - With Coaching',
                'DT.Urine': 'Drug Testing',
                'DT.Breath': 'Drug Testing',
                'DT.Swab': 'Drug Testing',
                'DT.Patch': 'Drug Testing',
                'DT.Sweat': 'Drug Testing'
            };

            const formattedDate = date ? new Date(date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';

            document.getElementById('wizardReviewClient').textContent = wizardData.clientName;
            document.getElementById('wizardReviewDate').textContent = formattedDate;
            document.getElementById('wizardReviewService').textContent = serviceLabels[wizardData.serviceType] || wizardData.serviceType;
            document.getElementById('wizardReviewHours').textContent = wizardData.hours.toFixed(1);
            document.getElementById('wizardReviewMiles').textContent = Math.round(wizardData.miles);
            document.getElementById('wizardReviewReimb').textContent = '$' + (wizardData.miles * 0.70).toFixed(0);
        }

        // Submit wizard entry
        function wizardSubmit() {
            wizardData.notes = document.getElementById('wizardNotes').value;

            // Create event object
            const newEvent = {
                id: Date.now(),
                savedAt: new Date().toISOString(),
                staffName: currentUserData?.displayName || 'Staff Member',
                invoiceMonth: wizardData.date.substring(0, 7),
                serviceType: wizardData.serviceType,
                clientName: wizardData.clientName,
                clientId: wizardData.client,
                date: wizardData.date,
                serviceTimeIn: wizardData.timeIn,
                serviceTimeOut: wizardData.timeOut,
                serviceBillableHours: wizardData.hours,
                travelTo: {
                    miles: wizardData.miles / 2,
                    travelTime: 30
                },
                travelFrom: {
                    miles: wizardData.miles / 2,
                    travelTime: 30
                },
                comments: wizardData.notes,
                status: 'saved'
            };

            // Save to localStorage
            const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
            savedEvents.push(newEvent);
            localStorage.setItem('savedServiceEvents', JSON.stringify(savedEvents));

            // Show success and go to history
            showSuccess('Entry saved successfully!');
            showSimpleView('history');
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.viewId) {
                showView(event.state.viewId, false);
            } else {
                // Default to dashboard or login based on auth state
                if (currentUser) {
                    showView(currentUserData?.role === 'admin' ? 'adminDashboardView' : 'dashboardView', false);
                } else {
                    showView('loginView', false);
                }
            }
        });

        /**
         * Show main view based on tab selection
         * Maps tab names to actual view IDs
         */
        function showMainView(tabName) {
            // Map tab names to actual view IDs
            const tabViewMap = {
                'home': currentUserData?.role === 'admin' ? 'adminDashboardView' : 'dashboardView',
                'newInvoice': 'formView',
                'myInvoices': 'myInvoicesView',
                'clients': 'adminClientManagementView',
                'admin': 'adminDashboardView'
            };

            const viewId = tabViewMap[tabName];
            if (viewId) {
                showView(viewId);
            }

            // Update tab active states
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        /**
         * Update active tab based on current view ID
         */
        function updateActiveTab(viewId) {
            // Map view IDs back to tab names
            const viewTabMap = {
                'dashboardView': 'Home',
                'adminDashboardView': currentUserData?.role === 'admin' ? 'Admin' : 'Home',
                'formView': 'NewInvoice',
                'myInvoicesView': 'MyInvoices',
                'adminClientManagementView': 'Clients',
                'adminUserManagementView': 'Admin',
                'adminAllInvoicesView': 'Admin',
                'travelLogGeneratorView': 'Admin'
            };

            // Clear all active states
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Set active tab
            const tabName = viewTabMap[viewId];
            if (tabName) {
                const activeTab = document.getElementById('tab' + tabName);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
        }

        /**
         * AUTHENTICATION HANDLERS
         */
        async function handleEmailLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Use local auth if enabled
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    await localLogin(email, password);
                    showSuccess('Login successful!');

                    // Navigate to simplified home (for all users)
                    // Admins can access admin dashboard from the home screen
                    showView('simpleHomeView');
                    updateUserHeader();
                } else {
                    await login(email, password);
                    showSuccess('Login successful!');
                }
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please check your credentials.';
                const normalized = (error?.message || '').toLowerCase();
                if (normalized.includes('invalid login credentials')) {
                    errorMessage = 'Email or password is incorrect.';
                } else if (normalized.includes('email not confirmed')) {
                    errorMessage = 'Please confirm your email before signing in.';
                } else if (normalized.includes('too many requests')) {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                } else if (error?.message) {
                    errorMessage = error.message;
                }
                showError(errorMessage);
            }
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }

            // Skip validation for local auth (simpler passwords allowed)
            if (typeof USE_LOCAL_AUTH === 'undefined' || !USE_LOCAL_AUTH) {
                const validation = validatePassword(newPassword);
                if (!validation.valid) {
                    showError(validation.errors.join('. '));
                    return;
                }
            }

            try {
                // Use local auth if enabled
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    await localChangePassword(currentPassword, newPassword);
                } else {
                    await changePassword(currentPassword, newPassword);
                }
                showSuccess('Password changed successfully!');
                document.getElementById('passwordChangeForm').reset();

                // Redirect based on role
                if (currentUserData.role === 'admin') {
                    showView('adminDashboardView');
                } else {
                    showView('dashboardView');
                }
            } catch (error) {
                console.error('Password change error:', error);
                let errorMessage = 'Failed to change password.';
                const normalized = (error?.message || '').toLowerCase();
                if (normalized.includes('invalid login credentials') || normalized.includes('current password')) {
                    errorMessage = 'Current password is incorrect.';
                } else if (normalized.includes('password should be at least')) {
                    errorMessage = 'New password is too weak.';
                } else if (error?.message) {
                    errorMessage = error.message;
                }
                showError(errorMessage);
            }
        }

        async function handleForgotPassword() {
            const email = prompt('Enter your email address:');
            if (!email) return;

            try {
                await sendPasswordResetEmail(email);
                showSuccess('Password reset email sent! Check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                showError('Failed to send password reset email.');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            const validation = validatePassword(password);
            if (!validation.valid) {
                showError(validation.errors.join('. '));
                return;
            }

            try {
                await signup(email, password, name);
                showSuccess('Account created! Please check your email to confirm your account.');
                document.getElementById('signupForm').reset();
                showView('loginView');
            } catch (error) {
                console.error('Signup error:', error);
                let errorMessage = 'Failed to create account.';
                const normalized = (error?.message || '').toLowerCase();
                if (normalized.includes('already registered')) {
                    errorMessage = 'An account with this email already exists.';
                } else if (normalized.includes('invalid email')) {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error?.message) {
                    errorMessage = error.message;
                }
                showError(errorMessage);
            }
        }

        /**
         * DASHBOARD FUNCTIONS
         */
        async function loadUserDashboard() {
            try {
                let invoices = [];

                // Check if using local auth
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    // Use local invoices data
                    invoices = JSON.parse(localStorage.getItem('local_invoices') || '[]');
                    // Filter to current user's invoices
                    invoices = invoices.filter(inv => inv.userId === currentUser?.id);
                } else {
                    invoices = await getUserInvoices();
                }

                const drafts = invoices.filter(inv => inv.status === 'draft');
                const submitted = invoices.filter(inv => inv.status === 'submitted' || inv.status === 'approved');

                document.getElementById('draftCount').textContent = drafts.length;
                document.getElementById('submittedCount').textContent = submitted.length;

                // Calculate this week's hours
                const today = new Date();
                const sunday = new Date(today);
                sunday.setDate(today.getDate() - today.getDay());

                const weekInvoices = invoices.filter(inv => {
                    const weekStart = parseTimestamp(inv.weekStartDate);
                    return weekStart && weekStart >= sunday;
                });

                const weekHours = weekInvoices.reduce((sum, inv) => sum + (inv.totalBillableHours || 0), 0);
                document.getElementById('weekHours').textContent = weekHours.toFixed(1);

                // Calculate this month's hours
                const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthInvoices = invoices.filter(inv => {
                    const weekStart = parseTimestamp(inv.weekStartDate);
                    return weekStart && weekStart >= firstOfMonth;
                });

                const monthHours = monthInvoices.reduce((sum, inv) => sum + (inv.totalBillableHours || 0), 0);
                document.getElementById('monthHours').textContent = monthHours.toFixed(1);

                // Populate staff members list
                populateStaffMembersList();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data');
            }
        }

        function populateStaffMembersList() {
            const container = document.getElementById('staffMembersList');
            if (!container) return;

            // Use local users if in local auth mode, otherwise use sample staff
            let staffList = SAMPLE_STAFF;
            if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                const localUsers = getLocalUsers();
                if (localUsers.length > 0) {
                    staffList = localUsers.map(u => ({
                        name: u.displayName,
                        email: u.email,
                        role: u.role
                    }));
                }
            }

            container.innerHTML = staffList.map(staff => `
                <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${staff.name || staff.displayName}</div>
                        <div style="font-size: 12px; color: #666;">${staff.email}</div>
                    </div>
                    <span style="background: ${staff.role === 'admin' ? '#dc3545' : '#2c5aa0'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${staff.role}</span>
                </div>
            `).join('');
        }

        async function loadMyInvoices() {
            try {
                const invoices = await getUserInvoices();
                const container = document.getElementById('myInvoicesList');

                if (invoices.length === 0) {
                    container.innerHTML = `
                        <div class="no-entries">
                            <div style="font-size: 14px; font-weight: 600;">No invoices found</div>
                            <div style="font-size: 12px; margin-top: 5px;">Create your first invoice</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = invoices.map(invoice => {
                    const statusColor = {
                        'draft': '#6c757d',
                        'submitted': '#ffc107',
                        'approved': '#28a745',
                        'rejected': '#dc3545'
                    }[invoice.status] || '#6c757d';

                    return `
                        <div class="entry-card">
                            <div class="entry-header">
                                <div>
                                    <div class="entry-title">Week of ${formatDateDisplay(invoice.weekStartDate)}</div>
                                    <div class="entry-date">Updated: ${formatDateDisplay(invoice.updatedAt, true)}</div>
                                </div>
                                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                    ${invoice.status.toUpperCase()}
                                </div>
                            </div>
                            <div class="entry-details">
                                <div><strong>Instances:</strong> ${invoice.serviceInstances?.length || 0}</div>
                                <div><strong>Total Hours:</strong> ${invoice.totalBillableHours?.toFixed(2) || '0.00'}</div>
                                <div><strong>Mileage:</strong> ${invoice.totalMileage?.toFixed(1) || '0.0'} mi</div>
                                <div><strong>Reimbursement:</strong> $${invoice.totalReimbursement?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="btn-primary" onclick="loadRemoteInvoice('${invoice.id}')">View</button>
                                ${invoice.status === 'draft' ? `
                                    <button class="btn-success" onclick="submitRemoteInvoice('${invoice.id}')">Submit</button>
                                    <button class="btn-danger" onclick="deleteRemoteInvoice('${invoice.id}')">Delete</button>
                                ` : `
                                    <button class="btn-secondary" onclick="printRemoteInvoice('${invoice.id}')">Print</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading invoices:', error);
                showError('Failed to load invoices');
            }
        }

        // Store all invoices for filtering
        let allMyInvoices = [];
        let currentInvoiceFilter = 'all';

        async function loadMyInvoicesWithFilter() {
            try {
                allMyInvoices = await getUserInvoices();
                filterMyInvoices(currentInvoiceFilter);
            } catch (error) {
                console.error('Error loading invoices:', error);
                showError('Failed to load invoices');
            }
        }

        function filterMyInvoices(filter) {
            currentInvoiceFilter = filter;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(startOfToday);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            let filteredInvoices = allMyInvoices;

            if (filter === 'daily') {
                filteredInvoices = allMyInvoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.updatedAt || invoice.createdAt);
                    return invoiceDate >= startOfToday;
                });
            } else if (filter === 'weekly') {
                filteredInvoices = allMyInvoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.updatedAt || invoice.createdAt);
                    return invoiceDate >= startOfWeek;
                });
            } else if (filter === 'monthly') {
                filteredInvoices = allMyInvoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.updatedAt || invoice.createdAt);
                    return invoiceDate >= startOfMonth;
                });
            }

            renderMyInvoices(filteredInvoices);
        }

        function renderMyInvoices(invoices) {
            const container = document.getElementById('myInvoicesList');

            if (invoices.length === 0) {
                container.innerHTML = `
                    <div class="no-entries">
                        <div style="font-size: 14px; font-weight: 600;">No invoices found</div>
                        <div style="font-size: 12px; margin-top: 5px;">${currentInvoiceFilter === 'all' ? 'Create your first invoice' : 'No invoices for this time period'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = invoices.map(invoice => {
                const statusColor = {
                    'draft': '#6c757d',
                    'submitted': '#ffc107',
                    'approved': '#28a745',
                    'rejected': '#dc3545'
                }[invoice.status] || '#6c757d';

                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div>
                                <div class="entry-title">Week of ${formatDateDisplay(invoice.weekStartDate)}</div>
                                <div class="entry-date">Updated: ${formatDateDisplay(invoice.updatedAt, true)}</div>
                            </div>
                            <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                ${invoice.status.toUpperCase()}
                            </div>
                        </div>
                        <div class="entry-details">
                            <div><strong>Instances:</strong> ${invoice.serviceInstances?.length || 0}</div>
                            <div><strong>Total Hours:</strong> ${invoice.totalBillableHours?.toFixed(2) || '0.00'}</div>
                            <div><strong>Mileage:</strong> ${invoice.totalMileage?.toFixed(1) || '0.0'} mi</div>
                            <div><strong>Reimbursement:</strong> $${invoice.totalReimbursement?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="entry-actions">
                            <button class="btn-primary" onclick="loadRemoteInvoice('${invoice.id}')">View</button>
                            ${invoice.status === 'draft' ? `
                                <button class="btn-success" onclick="submitRemoteInvoice('${invoice.id}')">Submit</button>
                                <button class="btn-danger" onclick="deleteRemoteInvoice('${invoice.id}')">Delete</button>
                            ` : `
                                <button class="btn-secondary" onclick="printRemoteInvoice('${invoice.id}')">Print</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * ADMIN FUNCTIONS
         */
        async function loadStaffList() {
            const container = document.getElementById('adminStaffList');
            if (!container) return;

            // Use local users if in local auth mode, otherwise use sample staff
            let staff = SAMPLE_STAFF;
            if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                const localUsers = getLocalUsers();
                if (localUsers.length > 0) {
                    staff = localUsers.map(u => ({
                        id: u.id,
                        name: u.displayName,
                        email: u.email,
                        role: u.role
                    }));
                }
            }

            if (staff.length === 0) {
                container.innerHTML = '<div class="no-entries">No staff members found</div>';
                return;
            }

            container.innerHTML = staff.map((member, index) => `
                <div class="staff-item" onclick="viewStaffDetail('${member.id || 'local-' + index}', '${member.name || member.displayName}', '${member.email}')" style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${member.name || member.displayName}</div>
                        <div style="font-size: 12px; color: #666;">${member.email}</div>
                    </div>
                    <span style="background: ${member.role === 'admin' ? '#dc3545' : '#2c5aa0'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${member.role}</span>
                </div>
            `).join('');
        }

        async function viewStaffDetail(staffId, staffName, staffEmail) {
            selectedStaffId = staffId;
            document.getElementById('staffDetailName').textContent = staffName;
            document.getElementById('staffDetailEmail').textContent = staffEmail;

            showView('adminStaffDetailView');
            await loadStaffInvoices(staffId);
        }

        async function loadStaffInvoices(staffId) {
            try {
                const invoices = await getStaffInvoices(staffId);
                const container = document.getElementById('staffInvoicesList');

                if (invoices.length === 0) {
                    container.innerHTML = `
                        <div class="no-entries">
                            <div style="font-size: 14px; font-weight: 600;">No invoices found</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = invoices.map(invoice => {
                    const statusColor = {
                        'draft': '#6c757d',
                        'submitted': '#ffc107',
                        'approved': '#28a745',
                        'rejected': '#dc3545'
                    }[invoice.status] || '#6c757d';

                    return `
                        <div class="entry-card">
                            <div class="entry-header">
                                <div>
                                    <div class="entry-title">Week of ${formatDateDisplay(invoice.weekStartDate)}</div>
                                    <div class="entry-date">Updated: ${formatDateDisplay(invoice.updatedAt, true)}</div>
                                </div>
                                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                    ${invoice.status.toUpperCase()}
                                </div>
                            </div>
                            <div class="entry-details">
                                <div><strong>Instances:</strong> ${invoice.serviceInstances?.length || 0}</div>
                                <div><strong>Total Hours:</strong> ${invoice.totalBillableHours?.toFixed(2) || '0.00'}</div>
                                <div><strong>Mileage:</strong> ${invoice.totalMileage?.toFixed(1) || '0.0'} mi</div>
                                <div><strong>Reimbursement:</strong> $${invoice.totalReimbursement?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="entry-actions">
                                ${invoice.status === 'submitted' ? `
                                    <button class="btn-success" onclick="handleApproveInvoice('${invoice.id}')">Approve</button>
                                    <button class="btn-danger" onclick="handleRejectInvoice('${invoice.id}')">Reject</button>
                                ` : `
                                    <button class="btn-secondary" onclick="printRemoteInvoice('${invoice.id}')">Print</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading staff invoices:', error);
                showError('Failed to load invoices');
            }
        }

        async function handleApproveInvoice(invoiceId) {
            if (!confirm('Approve this invoice?')) return;

            try {
                await approveInvoice(invoiceId);
                showSuccess('Invoice approved!');
                await loadStaffInvoices(selectedStaffId);
            } catch (error) {
                console.error('Error approving invoice:', error);
                showError('Failed to approve invoice');
            }
        }

        async function handleRejectInvoice(invoiceId) {
            const reason = prompt('Enter reason for rejection:');
            if (!reason) return;

            try {
                await rejectInvoice(invoiceId, reason);
                showSuccess('Invoice rejected');
                await loadStaffInvoices(selectedStaffId);
            } catch (error) {
                console.error('Error rejecting invoice:', error);
                showError('Failed to reject invoice');
            }
        }

        async function loadUserManagement() {
            try {
                const users = await getAllUsers();
                const container = document.getElementById('userManagementList');

                if (users.length === 0) {
                    container.innerHTML = '<div class="no-entries">No users found</div>';
                    return;
                }

                container.innerHTML = users.map(user => {
                    const roleColor = user.role === 'admin' ? '#dc3545' : '#ffc107';
                    const isCurrentUser = user.id === currentUser?.id;
                    return `
                        <div class="entry-card">
                            <div class="entry-header">
                                <div>
                                    <div class="entry-title">${user.displayName} ${isCurrentUser ? '(You)' : ''}</div>
                                    <div class="entry-date">${user.email}</div>
                                </div>
                                <div style="background: ${roleColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                    ${user.role.toUpperCase()}
                                </div>
                            </div>
                            <div class="entry-details">
                                <div><strong>Last Login:</strong> ${user.lastLogin ? formatDateDisplay(user.lastLogin, true) : 'Never'}</div>
                                <div><strong>Password Changed:</strong> ${user.lastPasswordChange ? formatDateDisplay(user.lastPasswordChange) : 'Never'}</div>
                                ${user.passwordChangeRequired ? '<div style="color: #dc3545;"><strong>Password Change Required</strong></div>' : ''}
                            </div>
                            <div class="entry-actions">
                                ${!isCurrentUser ? `
                                    <button class="btn-primary" onclick="toggleUserRole('${user.id}', '${user.role}')">
                                        ${user.role === 'admin' ? 'Make Staff' : 'Make Admin'}
                                    </button>
                                    <button class="btn-secondary" onclick="forcePasswordReset('${user.id}')">Reset Password</button>
                                    ${typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH ? `
                                        <button class="delete" onclick="deleteUser('${user.id}')" style="background: #fee2e2; color: #dc2626;">Delete</button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users');
            }
        }

        // Admin Dashboard loader
        async function loadAdminDashboard() {
            try {
                // Check if using local auth
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    // Use local/sample data
                    const users = getLocalUsers();
                    const invoices = JSON.parse(localStorage.getItem('local_invoices') || '[]');

                    // Count pending invoices
                    const pending = invoices.filter(i => i.status === 'submitted').length;
                    document.getElementById('adminPendingCount').textContent = pending;

                    // Count users
                    document.getElementById('adminUserCount').textContent = users.length;

                    // Count approved this month
                    const firstOfMonth = new Date();
                    firstOfMonth.setDate(1);
                    firstOfMonth.setHours(0, 0, 0, 0);
                    const approved = invoices.filter(i => {
                        if (i.status !== 'approved') return false;
                        const approvedAt = parseTimestamp(i.approvedAt);
                        return approvedAt && approvedAt >= firstOfMonth;
                    }).length;
                    document.getElementById('adminApprovedCount').textContent = approved;

                    // Count clients from sample data
                    document.getElementById('adminClientCount').textContent = SAMPLE_CLIENTS.length;

                    // Load staff list
                    await loadStaffList();
                    return;
                }

                // Original Supabase flow
                const [users, invoices, clientsData] = await Promise.all([
                    getAllUsers(),
                    getAllInvoicesAdmin(),
                    getClientsFromDB()
                ]);

                // Count pending invoices
                const pending = invoices.filter(i => i.status === 'submitted').length;
                document.getElementById('adminPendingCount').textContent = pending;

                // Count users
                document.getElementById('adminUserCount').textContent = users.length;

                // Count approved this month
                const firstOfMonth = new Date();
                firstOfMonth.setDate(1);
                firstOfMonth.setHours(0, 0, 0, 0);
                const approved = invoices.filter(i => {
                    if (i.status !== 'approved') return false;
                    const approvedAt = parseTimestamp(i.approvedAt);
                    return approvedAt && approvedAt >= firstOfMonth;
                }).length;
                document.getElementById('adminApprovedCount').textContent = approved;

                // Count clients
                document.getElementById('adminClientCount').textContent = Object.keys(clientsData).length;

                // Load staff list
                await loadStaffList();
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        // Show/hide add user form
        function showAddUserForm() {
            document.getElementById('addUserFormContainer').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('addUserFormContainer').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        // Handle add user
        async function handleAddUser(event) {
            event.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            try {
                // Use local auth if enabled
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    await localSignup(email, password, name, role);
                    showSuccess(`User ${name} created successfully!`);
                    hideAddUserForm();
                    loadUserManagement();
                } else {
                    // Create auth user via admin invite
                    const user = await adminCreateUser(email, password, name, role);
                    showSuccess(`User ${name} created successfully!`);
                    hideAddUserForm();
                    loadUserManagement();
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showError(error.message || 'Failed to create user');
            }
        }

        // Toggle user role
        async function toggleUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'staff' : 'admin';
            if (!confirm(`Change this user's role to ${newRole}?`)) return;

            try {
                await updateUser(userId, { role: newRole });
                showSuccess(`User role updated to ${newRole}`);
                loadUserManagement();
            } catch (error) {
                console.error('Error updating user role:', error);
                showError('Failed to update user role');
            }
        }

        // Force password reset
        async function forcePasswordReset(userId) {
            if (!confirm('Force this user to change their password on next login?')) return;

            try {
                await updateUser(userId, { passwordChangeRequired: true });
                showSuccess('Password reset required on next login');
                loadUserManagement();
            } catch (error) {
                console.error('Error forcing password reset:', error);
                showError('Failed to set password reset');
            }
        }

        // Delete user (local auth only)
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;

            try {
                if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                    await deleteLocalUser(userId);
                    showSuccess('User deleted successfully');
                    loadUserManagement();
                } else {
                    showError('Delete user is only available in local auth mode');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
            }
        }

        // Client Management
        let clientsWithAddresses = [];
        let selectedClientId = null;
        let addressFieldCounter = 0;

        // Staff members data - available locally for testing
        const SAMPLE_STAFF = [
            { name: 'Crystal Kuklish', email: 'ckuklish@epworthfamilyresources.org', role: 'staff' },
            { name: 'Martha Burgess', email: 'mburgess@epworthfamilyresources.org', role: 'staff' },
            { name: 'Amanda Schropfer', email: 'aschropfer@epworthfamilyresources.org', role: 'staff' },
            { name: 'Raquel Dean', email: 'rdean@epworthfamilyresources.org', role: 'staff' },
            { name: 'Brandon Hinrichs', email: 'bhinrichs@epworthfamilyresources.org', role: 'admin' }
        ];

        const SERVICE_CHOICE_OPTIONS = [
            'Prep - Advance Cancel',
            'Prep - Enroute Cancel',
            'Prep - No Show',
            'Virtual',
            'Complete'
        ];

        // Master address list data - available locally for testing
        const SAMPLE_CLIENTS = [
                {
                    name: 'Caroon, Aindrea',
                    masterCase: '554231',
                    addresses: [
                        { label: 'Home', address: '1026 F St, Fairbury, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Address 3', address: '612 J St, Fairbury, NE' }
                    ]
                },
                {
                    name: 'Connelly, Courtney',
                    masterCase: '485231',
                    addresses: [
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Clarks', address: '309 E Barton St, Clarks, NE' },
                        { label: 'GI Josh', address: '326 Josh Ave, Grand Island, NE' },
                        { label: 'GI Stolley', address: '690 E Stolley Park Rd, Grand Island, NE' }
                    ]
                },
                {
                    name: 'Daleness, Jamie',
                    masterCase: '314228',
                    addresses: []
                },
                {
                    name: 'Devor, Christina',
                    masterCase: '190820',
                    addresses: [
                        { label: 'Scott St', address: '1800 Scott St #72, Beatrice, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Eastridge', address: '325 Eastridge, Beatrice, NE' },
                        { label: '20th St', address: '926 N 20th St, Beatrice, NE' },
                        { label: 'Wymore 12th', address: '417 S 12th St, Wymore, NE' },
                        { label: 'Wymore 134th', address: '41065 134th Road, Wymore, NE' },
                        { label: 'Lincoln', address: '5561 S 48th St, Lincoln, NE' },
                        { label: '6th St', address: '1220 N 6th St, Beatrice, NE' }
                    ]
                },
                {
                    name: 'Frerichs, Justin',
                    masterCase: '540990',
                    addresses: [
                        { label: 'Tecumseh', address: '164 Greeley St, Tecumseh, NE' },
                        { label: 'Syracuse', address: '188 N 30th Rd, Syracuse, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Nebr City', address: '218 N 14th St, Nebraska City, NE' }
                    ]
                },
                {
                    name: 'Hawkins, Hazey',
                    masterCase: '631992',
                    addresses: [
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Home', address: '405 S 10th St, Beatrice, NE' }
                    ]
                },
                {
                    name: 'Kazadi',
                    masterCase: 'N/A',
                    addresses: [
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'York Grant', address: '419 N Grant Ave, York, NE' },
                        { label: 'Lincoln', address: '1111 Old Chaney Rd, Lincoln, NE' },
                        { label: 'York Fairview', address: '18 Fairview Dr, York, NE' },
                        { label: 'Grand Island', address: '3207 E Seedling Mile Rd, Grand Island, NE' }
                    ]
                },
                {
                    name: 'Schellhorn, Terran',
                    masterCase: '507906',
                    addresses: [
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Fairbury', address: '601 7th St, Fairbury, NE' }
                    ]
                },
                {
                    name: 'Shupe, Austi',
                    masterCase: '671791',
                    addresses: [
                        { label: 'Court 1001', address: '1001 Court St, Beatrice, NE' },
                        { label: 'Fairbury', address: '105 W 5th St #104, Fairbury, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Irving St', address: '527 Irving St, Beatrice, NE' },
                        { label: 'Irving #118', address: '527 Irving St #118, Beatrice, NE' }
                    ]
                },
                {
                    name: 'Spencer, Sidney',
                    masterCase: '745749',
                    addresses: [
                        { label: 'Crete', address: '1880 W 12th, Crete, NE' },
                        { label: 'York 7th', address: '309 E 7th St, York, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'York 6th', address: '903 6th St, York, NE' }
                    ]
                },
                {
                    name: 'Spunaugle, Cheyenne',
                    masterCase: '836898',
                    addresses: [
                        { label: 'Court 1001', address: '1001 Court St, Beatrice, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Blue Springs', address: '215 S Walnut, Blue Springs, NE' }
                    ]
                },
                {
                    name: 'Whitehurst, Christopher',
                    masterCase: '127458',
                    addresses: [
                        { label: 'Crete Forest', address: '1233 Forest Ave, Crete, NE' },
                        { label: 'Crete 12th', address: '1880 W 12th, Crete, NE' },
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'York', address: '309 E 7th St, York, NE' }
                    ]
                },
                {
                    name: 'Wilson, Amber',
                    masterCase: '466399',
                    addresses: [
                        { label: 'Office', address: '2006 Court St, Beatrice, NE' },
                        { label: 'Fairbury', address: '2831 State Hwy 15, Fairbury, NE' },
                        { label: 'Hebron', address: '915 Lincoln Ave Apt 12, Hebron, NE' }
                ]
            }
        ];

        // Office address for travel starting point
        const OFFICE_ADDRESS = '2006 Court St, Beatrice, NE';

        // Load sample data into local storage for testing (bypasses database)
        function populateSampleData() {
            // Add unique IDs to sample clients for local use
            clientsWithAddresses = SAMPLE_CLIENTS.map((client, index) => ({
                ...client,
                id: `local-${index}`,
                addresses: client.addresses.map((addr, addrIndex) => ({
                    ...addr,
                    id: `addr-${index}-${addrIndex}`
                }))
            }));

            // Update the client management list display
            const container = document.getElementById('clientManagementList');
            if (container) {
                container.innerHTML = clientsWithAddresses.map(client => `
                    <div class="entry-card" onclick="viewClientDetail('${client.id}')" style="cursor: pointer;">
                        <div class="entry-header">
                            <div>
                                <div class="entry-title">${client.name}</div>
                                <div class="entry-date">Master Case: ${client.masterCase}</div>
                            </div>
                            <div style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                ${client.addresses?.length || 0} Addresses (Local)
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Also update the client dropdown in service entry form
            loadClientsForFormLocal();

            alert(`Loaded ${clientsWithAddresses.length} clients with addresses for testing!`);
        }

        // Load clients into the service entry form dropdown (local data)
        function loadClientsForFormLocal() {
            const select = document.getElementById('clientName');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select Client --</option>';
            clientsWithAddresses.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (MC: ${client.masterCase})`;
                select.appendChild(option);
            });
        }

        async function loadClientManagement() {
            const container = document.getElementById('clientManagementList');

            // Use local data (already loaded on init)
            if (clientsWithAddresses.length === 0) {
                // Try to fetch from database as fallback
                try {
                    clientsWithAddresses = await getClientsWithAddresses();
                } catch (error) {
                    console.log('Using local sample data');
                }
            }

            if (clientsWithAddresses.length === 0) {
                container.innerHTML = '<div class="no-entries">No clients found. Add your first client above.</div>';
                return;
            }

            container.innerHTML = clientsWithAddresses.map(client => `
                <div class="entry-card" onclick="viewClientDetail('${client.id}')" style="cursor: pointer;">
                    <div class="entry-header">
                        <div>
                            <div class="entry-title">${client.name}</div>
                            <div class="entry-date">Master Case: ${client.masterCase}</div>
                        </div>
                        <div style="background: #2c5aa0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                            ${client.addresses?.length || 0} Addresses
                        </div>
                    </div>
                    ${client.addresses && client.addresses.length > 0 ? `
                        <div class="entry-details">
                            ${client.addresses.slice(0, 2).map(addr => `
                                <div><strong>${addr.label}:</strong> ${addr.address}</div>
                            `).join('')}
                            ${client.addresses.length > 2 ? `<div style="color: #666;">+ ${client.addresses.length - 2} more...</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function showAddClientForm() {
            document.getElementById('addClientFormContainer').style.display = 'block';
            document.getElementById('additionalAddresses').innerHTML = '';
            addressFieldCounter = 0;
        }

        function hideAddClientForm() {
            document.getElementById('addClientFormContainer').style.display = 'none';
            document.getElementById('addClientForm').reset();
            document.getElementById('additionalAddresses').innerHTML = '';
            addressFieldCounter = 0;
        }

        function addAddressField() {
            addressFieldCounter++;
            const container = document.getElementById('additionalAddresses');
            const div = document.createElement('div');
            div.className = 'auth-form-group';
            div.id = `addressField${addressFieldCounter}`;
            div.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label>Additional Address ${addressFieldCounter}</label>
                        <input type="text" class="additional-address" placeholder="123 Main St, City, State ZIP">
                    </div>
                    <button type="button" onclick="removeAddressField(${addressFieldCounter})" style="background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeAddressField(id) {
            document.getElementById(`addressField${id}`)?.remove();
        }

        async function handleAddClient(event) {
            event.preventDefault();

            const name = document.getElementById('newClientName').value.trim();
            const masterCase = document.getElementById('newClientMasterCase').value.trim();
            const primaryAddress = document.getElementById('newClientAddress').value.trim();

            // Collect all addresses
            const addresses = [];
            if (primaryAddress) {
                addresses.push({ label: 'Primary', address: primaryAddress });
            }

            document.querySelectorAll('.additional-address').forEach((input, index) => {
                if (input.value.trim()) {
                    addresses.push({ label: `Address ${index + 2}`, address: input.value.trim() });
                }
            });

            try {
                await addClient(name, masterCase, addresses);
                showSuccess(`Client ${name} added successfully!`);
                hideAddClientForm();
                loadClientManagement();
                // Update local client database
                CLIENT_DATABASE[name] = masterCase;
            } catch (error) {
                console.error('Error adding client:', error);
                showError('Failed to add client');
            }
        }

        // View client detail with addresses
        async function viewClientDetail(clientId) {
            selectedClientId = clientId;
            const client = clientsWithAddresses.find(c => c.id === clientId);

            if (!client) {
                showError('Client not found');
                return;
            }

            document.getElementById('clientDetailName').textContent = client.name;
            document.getElementById('clientDetailMasterCase').textContent = `Master Case: ${client.masterCase}`;

            showView('clientDetailView');
            await loadClientAddresses(clientId);
        }

        async function loadClientAddresses(clientId) {
            try {
                const addresses = await getClientAddresses(clientId);
                const container = document.getElementById('clientAddressList');

                if (addresses.length === 0) {
                    container.innerHTML = '<div class="no-entries">No addresses for this client. Add one above.</div>';
                    return;
                }

                container.innerHTML = addresses.map(addr => `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div>
                                <div class="entry-title">${addr.label} ${addr.is_primary ? '(Primary)' : ''}</div>
                                <div class="entry-date">${addr.address}</div>
                            </div>
                        </div>
                        <div class="entry-actions">
                            <button class="btn-danger" onclick="handleDeleteAddress('${addr.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading addresses:', error);
                showError('Failed to load addresses');
            }
        }

        function showAddAddressToClientForm() {
            document.getElementById('addAddressToClientContainer').style.display = 'block';
        }

        function hideAddAddressToClientForm() {
            document.getElementById('addAddressToClientContainer').style.display = 'none';
            document.getElementById('addAddressToClientForm').reset();
        }

        async function handleAddAddressToClient(event) {
            event.preventDefault();

            const label = document.getElementById('addressLabel').value.trim();
            const address = document.getElementById('addressFull').value.trim();

            try {
                await addClientAddress(selectedClientId, label, address);
                showSuccess('Address added successfully!');
                hideAddAddressToClientForm();
                loadClientAddresses(selectedClientId);
                // Refresh the client list (preserve sample data if db is empty)
                const dbClients = await getClientsWithAddresses();
                if (dbClients && dbClients.length > 0) {
                    clientsWithAddresses = dbClients;
                }
            } catch (error) {
                console.error('Error adding address:', error);
                showError('Failed to add address');
            }
        }

        async function handleDeleteAddress(addressId) {
            if (!confirm('Delete this address?')) return;

            try {
                await deleteClientAddress(addressId);
                showSuccess('Address deleted');
                loadClientAddresses(selectedClientId);
                // Refresh the client list (preserve sample data if db is empty)
                const dbDeleteClients = await getClientsWithAddresses();
                if (dbDeleteClients && dbDeleteClients.length > 0) {
                    clientsWithAddresses = dbDeleteClients;
                }
            } catch (error) {
                console.error('Error deleting address:', error);
                showError('Failed to delete address');
            }
        }

        // Get clients from database (simple version for backward compatibility)
        async function getClientsFromDB() {
            try {
                return await getClients();
            } catch (error) {
                console.error('Error fetching clients:', error);
                return CLIENT_DATABASE; // Fallback to local
            }
        }

        // Load clients for service instance form (called on login)
        async function loadClientsForForm() {
            try {
                // If sample data is already loaded, use it instead of fetching from database
                if (clientsWithAddresses.length > 0) {
                    console.log('Using existing client data:', clientsWithAddresses.length, 'clients');
                    // Update CLIENT_DATABASE for backward compatibility
                    clientsWithAddresses.forEach(client => {
                        CLIENT_DATABASE[client.name] = client.masterCase;
                    });
                    // Re-render service instances if any exist
                    if (serviceInstances.length > 0) {
                        renderServiceInstances();
                    }
                    return;
                }

                // Fallback to database if no sample data
                const dbClients = await getClientsWithAddresses();
                if (dbClients && dbClients.length > 0) {
                    clientsWithAddresses = dbClients;
                    clientsWithAddresses.forEach(client => {
                        CLIENT_DATABASE[client.name] = client.masterCase;
                    });
                    if (serviceInstances.length > 0) {
                        renderServiceInstances();
                    }
                }
            } catch (error) {
                console.error('Error loading clients for form:', error);
            }
        }

        // All Invoices View
        async function loadAllInvoices() {
            try {
                const statusFilter = document.getElementById('invoiceStatusFilter')?.value || 'all';
                const dateFilter = document.getElementById('invoiceDateFilter')?.value || 'all';

                let invoices = await getAllInvoicesAdmin();

                // Apply status filter
                if (statusFilter !== 'all') {
                    invoices = invoices.filter(i => i.status === statusFilter);
                }

                // Apply date filter
                if (dateFilter !== 'all') {
                    const now = new Date();
                    let startDate;

                    if (dateFilter === 'week') {
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 7);
                    } else if (dateFilter === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    } else if (dateFilter === 'quarter') {
                        startDate = new Date(now);
                        startDate.setMonth(now.getMonth() - 3);
                    }

                    if (startDate) {
                        invoices = invoices.filter(i => {
                            const weekStart = parseTimestamp(i.weekStartDate);
                            return weekStart && weekStart >= startDate;
                        });
                    }
                }

                const container = document.getElementById('allInvoicesList');

                if (invoices.length === 0) {
                    container.innerHTML = '<div class="no-entries">No invoices found matching filters</div>';
                    return;
                }

                container.innerHTML = invoices.map(invoice => {
                    const statusColor = {
                        'draft': '#6c757d',
                        'submitted': '#ffc107',
                        'approved': '#28a745',
                        'rejected': '#dc3545'
                    }[invoice.status] || '#6c757d';

                    return `
                        <div class="entry-card">
                            <div class="entry-header">
                                <div>
                                    <div class="entry-title">${invoice.staffName || 'Unknown Staff'}</div>
                                    <div class="entry-date">Week of ${formatDateDisplay(invoice.weekStartDate)}</div>
                                </div>
                                <div style="background: ${statusColor}; color: ${invoice.status === 'submitted' ? '#000' : 'white'}; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                    ${invoice.status.toUpperCase()}
                                </div>
                            </div>
                            <div class="entry-details">
                                <div><strong>Instances:</strong> ${invoice.serviceInstances?.length || 0}</div>
                                <div><strong>Total Hours:</strong> ${invoice.totalBillableHours?.toFixed(2) || '0.00'}</div>
                                <div><strong>Mileage:</strong> ${invoice.totalMileage?.toFixed(1) || '0.0'} mi</div>
                                <div><strong>Reimbursement:</strong> $${invoice.totalReimbursement?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="btn-primary" onclick="loadRemoteInvoice('${invoice.id}')">View</button>
                                ${invoice.status === 'submitted' ? `
                                    <button class="btn-success" onclick="handleApproveInvoice('${invoice.id}'); loadAllInvoices();">Approve</button>
                                    <button class="btn-danger" onclick="handleRejectInvoice('${invoice.id}'); loadAllInvoices();">Reject</button>
                                ` : `
                                    <button class="btn-secondary" onclick="printRemoteInvoice('${invoice.id}')">Print</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading all invoices:', error);
                showError('Failed to load invoices');
            }
        }

        /**
         * REMOTE INVOICE OPERATIONS
         */
        async function loadRemoteInvoice(invoiceId) {
            try {
                const invoice = await getInvoice(invoiceId);
                if (!invoice) {
                    showError('Invoice not found');
                    return;
                }

                // Load invoice data into form
                document.querySelector('[name="staffName"]').value = invoice.staffName || '';

                // Handle invoice month - either from invoiceMonth field or derive from weekStartDate
                if (invoice.invoiceMonth) {
                    document.getElementById('invoiceMonth').value = invoice.invoiceMonth;
                } else {
                    // Backward compatibility: derive month from weekStartDate
                    const weekStart = parseTimestamp(invoice.weekStartDate);
                    if (weekStart) {
                        const monthStr = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}`;
                        document.getElementById('invoiceMonth').value = monthStr;
                    }
                }

                // Migrate old service instances to new format if needed
                serviceInstances = (invoice.serviceInstances || []).map(instance => {
                    // If instance has old format (timeIn/timeOut), migrate to new format
                    if (instance.timeIn && !instance.serviceTimeIn) {
                        return {
                            ...instance,
                            serviceTimeIn: instance.timeIn,
                            serviceTimeOut: instance.timeOut,
                            serviceBillableHours: instance.billableHours || 0,
                            totalBillableHours: instance.billableHours || 0,
                            travelToMiles: instance.miles || 0,
                            travelBackMiles: 0,
                            totalMiles: instance.miles || 0,
                            travelToFrom: instance.driveFrom || '',
                            travelToDestination: instance.driveTo || instance.serviceAddress || '',
                            travelBackFrom: instance.driveTo || instance.serviceAddress || '',
                            travelBackDestination: ''
                        };
                    }
                    return instance;
                });

                instanceIdCounter = Math.max(...serviceInstances.map(s => s.id || 0), 0) + 1;

                renderServiceInstances();
                calculateMonthlyTotals();
                updateMonthBadge();

                currentEditId = invoiceId;
                showView('formView');
            } catch (error) {
                console.error('Error loading invoice:', error);
                showError('Failed to load invoice');
            }
        }

        async function deleteRemoteInvoice(invoiceId) {
            if (!confirm('Delete this invoice?')) return;

            try {
                await deleteInvoice(invoiceId);
                showSuccess('Invoice deleted');
                loadMyInvoicesWithFilter();
            } catch (error) {
                console.error('Error deleting invoice:', error);
                showError('Failed to delete invoice');
            }
        }

        async function submitRemoteInvoice(invoiceId) {
            if (!confirm('Submit this invoice for approval?')) return;

            try {
                await submitInvoice(invoiceId);
                showSuccess('Invoice submitted!');
                loadMyInvoicesWithFilter();
            } catch (error) {
                console.error('Error submitting invoice:', error);
                showError('Failed to submit invoice');
            }
        }

        async function printRemoteInvoice(invoiceId) {
            await loadRemoteInvoice(invoiceId);
            setTimeout(() => window.print(), 100);
        }

        /**
         * UPDATE USER HEADER
         */
        function updateUserHeader() {
            const header = document.getElementById('userHeader');
            if (currentUser && currentUserData) {
                const initials = (currentUserData.displayName || '')
                    .split(' ')
                    .filter(Boolean)
                    .map(n => n[0])
                    .join('')
                    .toUpperCase() || '?';

                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = currentUserData.displayName || currentUser.email || 'User';
                document.getElementById('userRole').textContent = currentUserData.role === 'admin' ? 'Administrator' : 'Staff Member';
                header.style.display = 'flex';
            } else {
                header.style.display = 'none';
            }
        }

        /**
         * EXCEL IMPORT FUNCTIONS
         */
        let parsedExcelData = [];

        function openExcelImport() {
            document.getElementById('excelImportModal').style.display = 'block';
            showExcelUploadStep();
            setupExcelDropZone();
        }

        function closeExcelImport() {
            document.getElementById('excelImportModal').style.display = 'none';
            parsedExcelData = [];
        }

        function showExcelUploadStep() {
            document.getElementById('excelUploadStep').style.display = 'block';
            document.getElementById('excelPreviewStep').style.display = 'none';
            document.getElementById('excelBackBtn').style.display = 'none';
            document.getElementById('excelImportBtn').style.display = 'none';
        }

        function showExcelPreviewStep() {
            document.getElementById('excelUploadStep').style.display = 'none';
            document.getElementById('excelPreviewStep').style.display = 'block';
            document.getElementById('excelBackBtn').style.display = 'inline-block';
            document.getElementById('excelImportBtn').style.display = 'inline-block';
        }

        function setupExcelDropZone() {
            const dropZone = document.getElementById('excelDropZone');
            const fileInput = document.getElementById('excelFileInput');

            dropZone.onclick = () => fileInput.click();
            fileInput.onchange = (e) => {
                if (e.target.files[0]) processExcelFile(e.target.files[0]);
            };

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#28a745';
                dropZone.style.background = '#d4edda';
            };
            dropZone.ondragleave = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#2c5aa0';
                dropZone.style.background = '#f8f9fa';
            };
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#2c5aa0';
                dropZone.style.background = '#f8f9fa';
                if (e.dataTransfer.files[0]) processExcelFile(e.dataTransfer.files[0]);
            };
        }

        async function processExcelFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                if (jsonData.length < 2) {
                    showError('File must have at least a header row and one data row');
                    return;
                }

                // Auto-detect header row by looking for common column names
                let headerRowIndex = 0;
                const headerKeywords = ['client', 'name', 'date', 'time', 'service', 'staff', 'hours'];

                for (let i = 0; i < Math.min(jsonData.length, 20); i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    const rowText = row.map(cell => String(cell || '').toLowerCase()).join(' ');
                    const matchCount = headerKeywords.filter(kw => rowText.includes(kw)).length;

                    if (matchCount >= 2) {
                        headerRowIndex = i;
                        console.log(`Found header row at index ${i}:`, row);
                        break;
                    }
                }

                const headers = jsonData[headerRowIndex].map(h => String(h || '').toLowerCase().trim());
                const rows = jsonData.slice(headerRowIndex + 1).filter(row => row.some(cell => cell));

                console.log('Using headers from row', headerRowIndex + 1, ':', headers);

                parsedExcelData = [];
                const errors = [];

                // Column mapping (with null safety and more flexible matching)
                const findCol = (test) => headers.findIndex(h => h && test(h));
                const colMap = {
                    clientName: findCol(h => h.includes('client') || (h.includes('name') && !h.includes('staff'))),
                    masterCase: findCol(h => h.includes('master') || h.includes('case') || h.includes('mc')),
                    serviceType: findCol(h => h.includes('service') || h.includes('type') || h.includes('code')),
                    date: findCol(h => h.includes('date')),
                    timeIn: findCol(h => h.includes('time in') || h.includes('start') || h.includes('begin') || h === 'in'),
                    timeOut: findCol(h => h.includes('time out') || h.includes('end') || h.includes('stop') || h === 'out'),
                    travelFrom: findCol(h => h.includes('from') || h.includes('origin') || h.includes('depart')),
                    travelTo: findCol(h => h.includes('to') || h.includes('destination') || h.includes('address')),
                    miles: findCol(h => h.includes('mile') || h.includes('distance')),
                    comments: findCol(h => h.includes('comment') || h.includes('note') || h.includes('description'))
                };
                console.log('Detected columns:', colMap);

                rows.forEach((row, i) => {
                    try {
                        const getValue = (col) => col >= 0 && row[col] ? String(row[col]).trim() : '';
                        const clientName = getValue(colMap.clientName);
                        const serviceType = getValue(colMap.serviceType) || 'PT';
                        const dateVal = colMap.date >= 0 ? row[colMap.date] : '';
                        const timeIn = parseExcelTime(colMap.timeIn >= 0 ? row[colMap.timeIn] : '');
                        const timeOut = parseExcelTime(colMap.timeOut >= 0 ? row[colMap.timeOut] : '');

                        if (!clientName) {
                            errors.push(`Row ${i + 2}: Missing client name`);
                            return;
                        }

                        const instance = {
                            id: Date.now() + i,
                            serviceType: serviceType,
                            clientName: clientName,
                            clientId: null,
                            masterCase: getValue(colMap.masterCase),
                            serviceAddress: getValue(colMap.travelTo),
                            date: parseExcelDate(dateVal),
                            serviceTimeIn: timeIn,
                            serviceTimeOut: timeOut,
                            serviceBillableHours: calculateHours(timeIn, timeOut),
                            travelToFrom: getValue(colMap.travelFrom),
                            travelToDestination: getValue(colMap.travelTo),
                            travelToMiles: parseFloat(getValue(colMap.miles)) || 0,
                            travelToTime: 0,
                            travelToTimeIn: '',
                            travelToTimeOut: '',
                            travelBackFrom: '',
                            travelBackDestination: '',
                            travelBackMiles: 0,
                            travelBackTime: 0,
                            travelBackTimeIn: '',
                            travelBackTimeOut: '',
                            totalBillableHours: calculateHours(timeIn, timeOut),
                            totalMiles: parseFloat(getValue(colMap.miles)) || 0,
                            comments: getValue(colMap.comments)
                        };
                        parsedExcelData.push(instance);
                    } catch (e) {
                        errors.push(`Row ${i + 2}: ${e.message}`);
                    }
                });

                // Show preview
                document.getElementById('excelRowCount').textContent = `Rows: ${parsedExcelData.length}`;
                document.getElementById('excelErrorCount').textContent = `Errors: ${errors.length}`;

                const errorsDiv = document.getElementById('excelErrors');
                if (errors.length > 0) {
                    errorsDiv.innerHTML = errors.slice(0, 5).join('<br>') + (errors.length > 5 ? `<br>...and ${errors.length - 5} more` : '');
                    errorsDiv.style.display = 'block';
                } else {
                    errorsDiv.style.display = 'none';
                }

                // Build preview table
                const tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Client</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Type</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Time</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Hours</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Miles</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${parsedExcelData.slice(0, 20).map(d => `
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 6px 8px;">${d.clientName}</td>
                                    <td style="padding: 6px 8px;">${d.serviceType}</td>
                                    <td style="padding: 6px 8px;">${d.date}</td>
                                    <td style="padding: 6px 8px;">${d.serviceTimeIn} - ${d.serviceTimeOut}</td>
                                    <td style="padding: 6px 8px;">${d.serviceBillableHours.toFixed(2)}</td>
                                    <td style="padding: 6px 8px;">${d.totalMiles}</td>
                                </tr>
                            `).join('')}
                            ${parsedExcelData.length > 20 ? `<tr><td colspan="6" style="padding: 8px; text-align: center; color: #666;">...and ${parsedExcelData.length - 20} more rows</td></tr>` : ''}
                        </tbody>
                    </table>
                `;
                document.getElementById('excelPreviewTable').innerHTML = tableHtml;
                showExcelPreviewStep();

            } catch (error) {
                console.error('Excel parse error:', error);
                showError('Error parsing file: ' + error.message);
            }
        }

        function parseExcelDate(value) {
            if (!value) return '';
            if (typeof value === 'number') {
                const date = XLSX.SSF.parse_date_code(value);
                if (date) return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
            }
            const d = new Date(value);
            if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            return '';
        }

        function parseExcelTime(value) {
            if (!value) return '';
            if (typeof value === 'number') {
                const hours = Math.floor(value * 24);
                const minutes = Math.round((value * 24 - hours) * 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            const str = String(value).trim();
            if (/^\d{1,2}:\d{2}/.test(str)) return str.substring(0, 5);
            return '';
        }

        function calculateHours(timeIn, timeOut) {
            if (!timeIn || !timeOut) return 0;
            const [inH, inM] = timeIn.split(':').map(Number);
            const [outH, outM] = timeOut.split(':').map(Number);
            let mins = (outH * 60 + outM) - (inH * 60 + inM);
            if (mins < 0) mins += 24 * 60;
            return Math.round((mins / 60) * 100) / 100;
        }

        function importExcelData() {
            if (parsedExcelData.length === 0) {
                showError('No data to import');
                return;
            }

            // Add each parsed instance to state, then render once.
            parsedExcelData.forEach(raw => {
                const normalized = {
                    serviceType: raw.serviceType || '',
                    clientName: raw.clientName || '',
                    clientId: null,
                    serviceAddress: raw.serviceAddress || raw.travelToDestination || raw.travelBackFrom || '',
                    masterCase: raw.masterCase || '',
                    date: raw.date || '',
                    serviceTimeIn: raw.serviceTimeIn || '',
                    serviceTimeOut: raw.serviceTimeOut || '',
                    serviceBillableHours: Number(raw.serviceBillableHours) || 0,
                    travelToFrom: raw.travelToFrom || '',
                    travelToDestination: raw.travelToDestination || raw.serviceAddress || '',
                    travelToMiles: Number(raw.travelToMiles) || 0,
                    travelToTime: Number(raw.travelToTime) || 0,
                    travelToTimeIn: raw.travelToTimeIn || '',
                    travelToTimeOut: raw.travelToTimeOut || '',
                    travelBackFrom: raw.travelBackFrom || raw.serviceAddress || '',
                    travelBackDestination: raw.travelBackDestination || '',
                    travelBackMiles: Number(raw.travelBackMiles) || 0,
                    travelBackTime: Number(raw.travelBackTime) || 0,
                    travelBackTimeIn: raw.travelBackTimeIn || '',
                    travelBackTimeOut: raw.travelBackTimeOut || '',
                    totalBillableHours: Number(raw.totalBillableHours) || 0,
                    totalMiles: Number(raw.totalMiles) || 0,
                    comments: raw.comments || ''
                };

                if (!normalized.serviceBillableHours && normalized.serviceTimeIn && normalized.serviceTimeOut) {
                    normalized.serviceBillableHours = calculateHours(normalized.serviceTimeIn, normalized.serviceTimeOut);
                }

                if (!normalized.totalMiles) {
                    normalized.totalMiles = (normalized.travelToMiles || 0) + (normalized.travelBackMiles || 0);
                }

                if (!normalized.totalBillableHours) {
                    const hasTravel = normalized.serviceType &&
                        (normalized.serviceType.includes('Travel') || normalized.serviceType.includes('travel'));
                    normalized.totalBillableHours = hasTravel
                        ? (normalized.serviceBillableHours || 0) + (normalized.travelToTime || 0) + (normalized.travelBackTime || 0)
                        : (normalized.serviceBillableHours || 0);
                }

                if (normalized.clientName) {
                    const client = clientsWithAddresses.find(c => c.name === normalized.clientName);
                    normalized.clientId = client?.id || null;
                    if (!normalized.masterCase) {
                        normalized.masterCase = client?.masterCase || CLIENT_DATABASE[normalized.clientName] || '';
                    }
                }

                addServiceInstance(normalized, { skipRender: true });
            });

            renderServiceInstances();
            triggerAutosave();

            showSuccess(`Imported ${parsedExcelData.length} service instances`);
            closeExcelImport();
            calculateMonthlyTotals();
        }

        /**
         * INITIALIZATION
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize form defaults
            const today = new Date();
            // Set invoice month to current month
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('invoiceMonth').value = monthStr;
            updateMonthBadge();

            // Auto-load sample clients and staff data
            initializeSampleData();

            // Populate staff dropdown
            populateStaffDropdown();
            const staffSelect = document.getElementById('staffNameSelect');
            if (staffSelect) {
                staffSelect.addEventListener('change', () => {
                    const initials = getCurrentStaffInitials();
                    serviceInstances.forEach(inst => { inst.staffInitials = initials; });
                    renderServiceInstances();
                    triggerAutosave();
                });
            }

            // Restore any saved draft before creating a new entry
            const restoredDraft = maybeRestoreLocalDraftOnLoad();

            // Add initial service instance when nothing to restore
            if (!restoredDraft) {
                addServiceInstance();
            }

            if (typeof initializeSupabaseAuth === 'function') {
                initializeSupabaseAuth();
            } else {
                console.error('Supabase auth initialization function not found');
            }

            // Hide/show auth links based on local auth mode
            if (typeof USE_LOCAL_AUTH !== 'undefined' && USE_LOCAL_AUTH) {
                document.getElementById('signupLink').style.display = 'none';
                document.getElementById('forgotPasswordLink').style.display = 'none';
                document.getElementById('localAuthInfo').style.display = 'block';
            }
        });

        // Initialize sample data automatically on app load
        function initializeSampleData() {
            // Load clients with addresses
            clientsWithAddresses = SAMPLE_CLIENTS.map((client, index) => ({
                ...client,
                id: `local-${index}`,
                addresses: client.addresses.map((addr, addrIndex) => ({
                    ...addr,
                    id: `addr-${index}-${addrIndex}`
                }))
            }));
            console.log('Loaded', clientsWithAddresses.length, 'clients automatically');

            // Load sample service events for testing Travel Log and PRF generators
            loadSampleServiceEvents();
        }

        // Load sample service events for testing
        function loadSampleServiceEvents() {
            // Check if sample data already exists
            const existingEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
            if (existingEvents.length > 0) {
                console.log('Sample service events already exist:', existingEvents.length);
                return;
            }

            // Create sample service events with travel data
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

            const sampleEvents = [
                {
                    id: 1001,
                    savedAt: new Date().toISOString(),
                    staffName: 'Brandon Hinrichs',
                    invoiceNumber: 'INV-2026-001',
                    invoiceMonth: currentMonth,
                    serviceType: 'IHFS',
                    clientName: 'Caroon, Aindrea',
                    clientId: 'local-0',
                    serviceAddress: '1026 F St, Fairbury, NE',
                    masterCase: '554231',
                    serviceState: 'NE',
                    date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-02`,
                    serviceTimeIn: '09:00',
                    serviceTimeOut: '11:30',
                    serviceBillableHours: 2.5,
                    travelTo: {
                        from: '2119 N Cotner Blvd, Lincoln, NE',
                        to: '1026 F St, Fairbury, NE',
                        departTime: '08:00',
                        arriveTime: '09:00',
                        miles: 42.5,
                        travelTime: 60
                    },
                    travelFrom: {
                        from: '1026 F St, Fairbury, NE',
                        to: '2119 N Cotner Blvd, Lincoln, NE',
                        departTime: '11:30',
                        arriveTime: '12:30',
                        miles: 42.5,
                        travelTime: 60
                    },
                    additionalTravel: [],
                    travelEntries: [],
                    comments: 'In-home family services visit',
                    status: 'saved'
                },
                {
                    id: 1002,
                    savedAt: new Date().toISOString(),
                    staffName: 'Brandon Hinrichs',
                    invoiceNumber: 'INV-2026-001',
                    invoiceMonth: currentMonth,
                    serviceType: 'PT',
                    clientName: 'Connelly, Courtney',
                    clientId: 'local-1',
                    serviceAddress: '309 E Barton St, Clarks, NE',
                    masterCase: '485231',
                    serviceState: 'NE',
                    date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-03`,
                    serviceTimeIn: '10:00',
                    serviceTimeOut: '12:00',
                    serviceBillableHours: 2.0,
                    travelTo: {
                        from: '2119 N Cotner Blvd, Lincoln, NE',
                        to: '309 E Barton St, Clarks, NE',
                        departTime: '08:30',
                        arriveTime: '10:00',
                        miles: 65.0,
                        travelTime: 90
                    },
                    travelFrom: {
                        from: '309 E Barton St, Clarks, NE',
                        to: '2119 N Cotner Blvd, Lincoln, NE',
                        departTime: '12:00',
                        arriveTime: '13:30',
                        miles: 65.0,
                        travelTime: 90
                    },
                    additionalTravel: [],
                    travelEntries: [],
                    comments: 'Physical therapy session',
                    status: 'saved'
                },
                {
                    id: 1003,
                    savedAt: new Date().toISOString(),
                    staffName: 'Brandon Hinrichs',
                    invoiceNumber: 'INV-2026-001',
                    invoiceMonth: currentMonth,
                    serviceType: 'OHFS',
                    clientName: 'Devor, Christina',
                    clientId: 'local-3',
                    serviceAddress: '1800 Scott St #72, Beatrice, NE',
                    masterCase: '190820',
                    serviceState: 'NE',
                    date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-04`,
                    serviceTimeIn: '13:00',
                    serviceTimeOut: '15:30',
                    serviceBillableHours: 2.5,
                    travelTo: {
                        from: '2119 N Cotner Blvd, Lincoln, NE',
                        to: '1800 Scott St #72, Beatrice, NE',
                        departTime: '12:00',
                        arriveTime: '13:00',
                        miles: 38.0,
                        travelTime: 60
                    },
                    travelFrom: {
                        from: '1800 Scott St #72, Beatrice, NE',
                        to: '2119 N Cotner Blvd, Lincoln, NE',
                        departTime: '15:30',
                        arriveTime: '16:30',
                        miles: 38.0,
                        travelTime: 60
                    },
                    additionalTravel: [
                        {
                            from: '1800 Scott St #72, Beatrice, NE',
                            to: '2006 Court St, Beatrice, NE',
                            departTime: '14:00',
                            arriveTime: '14:15',
                            miles: 3.5,
                            travelTime: 15
                        }
                    ],
                    travelEntries: [],
                    comments: 'Out-of-home family services with additional travel to office',
                    status: 'saved'
                },
                {
                    id: 1004,
                    savedAt: new Date().toISOString(),
                    staffName: 'Brandon Hinrichs',
                    invoiceNumber: 'INV-2026-001',
                    invoiceMonth: currentMonth,
                    serviceType: 'PTSV',
                    clientName: 'Flint, Cassie',
                    clientId: 'local-4',
                    serviceAddress: '8415 S Highway 14, Aurora, NE',
                    masterCase: '195920',
                    serviceState: 'NE',
                    date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-05`,
                    serviceTimeIn: '09:30',
                    serviceTimeOut: '11:00',
                    serviceBillableHours: 1.5,
                    travelTo: {
                        from: '2119 N Cotner Blvd, Lincoln, NE',
                        to: '8415 S Highway 14, Aurora, NE',
                        departTime: '08:00',
                        arriveTime: '09:30',
                        miles: 75.0,
                        travelTime: 90
                    },
                    travelFrom: {
                        from: '8415 S Highway 14, Aurora, NE',
                        to: '2119 N Cotner Blvd, Lincoln, NE',
                        departTime: '11:00',
                        arriveTime: '12:30',
                        miles: 75.0,
                        travelTime: 90
                    },
                    additionalTravel: [],
                    travelEntries: [],
                    comments: 'Travel PT session',
                    status: 'saved'
                },
                {
                    id: 1005,
                    savedAt: new Date().toISOString(),
                    staffName: 'Brandon Hinrichs',
                    invoiceNumber: 'INV-2026-001',
                    invoiceMonth: currentMonth,
                    serviceType: 'DT.Urine',
                    clientName: 'Gray, Kimberly',
                    clientId: 'local-5',
                    serviceAddress: '4401 N 52nd St, Lincoln, NE',
                    masterCase: '194820',
                    serviceState: 'NE',
                    date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-06`,
                    serviceTimeIn: '14:00',
                    serviceTimeOut: '14:30',
                    serviceBillableHours: 0.5,
                    travelTo: {
                        from: '2119 N Cotner Blvd, Lincoln, NE',
                        to: '4401 N 52nd St, Lincoln, NE',
                        departTime: '13:30',
                        arriveTime: '14:00',
                        miles: 8.5,
                        travelTime: 30
                    },
                    travelFrom: {
                        from: '4401 N 52nd St, Lincoln, NE',
                        to: '2119 N Cotner Blvd, Lincoln, NE',
                        departTime: '14:30',
                        arriveTime: '15:00',
                        miles: 8.5,
                        travelTime: 30
                    },
                    additionalTravel: [],
                    travelEntries: [],
                    comments: 'Drug testing - urinalysis',
                    status: 'saved'
                }
            ];

            localStorage.setItem('savedServiceEvents', JSON.stringify(sampleEvents));
            console.log('Loaded', sampleEvents.length, 'sample service events for testing');
        }

        // Function to clear and reload sample data (for testing)
        function reloadSampleData() {
            localStorage.removeItem('savedServiceEvents');
            loadSampleServiceEvents();
            refreshEventHistory();
            showSuccess('Sample service events reloaded!');
        }

        function populateStaffDropdown() {
            console.log('populateStaffDropdown called');
            console.log('SAMPLE_STAFF:', SAMPLE_STAFF);
            const select = document.getElementById('staffNameSelect');
            console.log('Staff select element:', select);
            if (!select) {
                console.error('Staff select element not found!');
                return;
            }

            select.innerHTML = '<option value="">-- Select Staff Member --</option>';
            SAMPLE_STAFF.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                select.appendChild(option);
            });
            console.log('Staff dropdown populated with', SAMPLE_STAFF.length, 'members');
        }

        /**
         * MONTH BADGE UPDATE
         */
        function updateMonthBadge() {
            const monthInput = document.getElementById('invoiceMonth');
            if (!monthInput || !monthInput.value) return;

            const [year, month] = monthInput.value.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[parseInt(month) - 1];

            document.getElementById('weekBadge').textContent = `${monthName} ${year}`;
        }

        // Legacy function for backward compatibility
        function updateWeekBadge() {
            updateMonthBadge();
        }

        /**
         * BACK BUTTON FUNCTION
         */
        function goBackFromForm() {
            if (serviceInstances.some(i => i.clientName || i.serviceType || i.date)) {
                if (!confirm('You have unsaved changes. Go back anyway?')) {
                    return;
                }
            }
            if (currentUserData?.role === 'admin') {
                showView('adminDashboardView');
            } else {
                showView('dashboardView');
            }
        }

        /**
         * AUTOSAVE FUNCTIONALITY
         */
        function triggerAutosave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveLocalDraft();

                // Only attempt remote draft save when authenticated
                if (typeof currentUser !== 'undefined' && currentUser) {
                    saveDraft(true);
                }
            }, 800);
        }

        function saveLocalDraft() {
            try {
                const staffName = document.querySelector('[name="staffName"]')?.value || '';
                const invoiceMonth = document.getElementById('invoiceMonth')?.value || '';

                const payload = {
                    staffName,
                    invoiceMonth,
                    serviceInstances,
                    savedAt: new Date().toISOString()
                };

                localStorage.setItem(LOCAL_DRAFT_KEY, JSON.stringify(payload));
                showAutoSaveIndicator();
            } catch (error) {
                console.warn('Local draft save failed:', error);
            }
        }

        function getSavedDraftMeta() {
            const raw = localStorage.getItem(LOCAL_DRAFT_KEY);
            if (!raw) return null;
            try {
                const parsed = JSON.parse(raw);
                return parsed && parsed.serviceInstances ? parsed : null;
            } catch (error) {
                console.warn('Failed to parse saved draft:', error);
                return null;
            }
        }

        function restoreLocalDraft() {
            const saved = getSavedDraftMeta();
            if (!saved) return false;

            serviceInstances = saved.serviceInstances || [];

            // Ensure IDs stay unique
            const maxId = serviceInstances.reduce((max, inst) => Math.max(max, inst.id || 0), 0);
            instanceIdCounter = maxId + 1;

            // Restore staff and month
            if (saved.staffName) {
                const staffField = document.querySelector('[name="staffName"]');
                if (staffField) staffField.value = saved.staffName;
            }
            if (saved.invoiceMonth) {
                const invoiceMonth = document.getElementById('invoiceMonth');
                if (invoiceMonth) invoiceMonth.value = saved.invoiceMonth;
                updateMonthBadge();
            }

            renderServiceInstances();
            calculateMonthlyTotals();

            const savedAt = saved.savedAt ? new Date(saved.savedAt).toLocaleString() : 'earlier';
            showSuccess(`Restored your last draft from ${savedAt}`);
            return true;
        }

        function clearLocalDraft() {
            localStorage.removeItem(LOCAL_DRAFT_KEY);
        }

        function maybeRestoreLocalDraftOnLoad() {
            const saved = getSavedDraftMeta();
            if (!saved) return false;

            // Avoid overwriting active work
            const hasActiveWork = serviceInstances.some(i => i.clientName || i.serviceType || i.date);
            if (hasActiveWork) return false;

            const savedAt = saved.savedAt ? new Date(saved.savedAt).toLocaleString() : 'a previous session';
            if (confirm(`We found a saved draft from ${savedAt}. Restore it?`)) {
                return restoreLocalDraft();
            }
            return false;
        }

        /**
         * SAVE CURRENT INSTANCE
         */
        async function saveCurrentInstance(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) {
                showError('Instance not found');
                return;
            }

            // Validate required fields
            if (!instance.clientName) {
                showError('Please select a client');
                return;
            }
            if (!instance.serviceType) {
                showError('Please select a service type');
                return;
            }
            if (!instance.date) {
                showError('Please enter a service date');
                return;
            }
            if (!instance.serviceTimeIn || !instance.serviceTimeOut) {
                showError('Please enter service time in and out');
                return;
            }

            // Calculate totals before saving
            calculateInstanceTotals(instanceId);

            // Save locally (avoid database calls when not authenticated)
            try {
                // Save to localStorage for persistence
                const data = getInvoiceData();
                data.status = 'draft';
                data.id = currentEditId || `local-${Date.now()}`;
                currentEditId = data.id;

                // Store in localStorage
                const savedInvoices = JSON.parse(localStorage.getItem('staffInvoices') || '[]');
                const existingIndex = savedInvoices.findIndex(inv => inv.id === data.id);
                if (existingIndex >= 0) {
                    savedInvoices[existingIndex] = data;
                } else {
                    savedInvoices.push(data);
                }
                localStorage.setItem('staffInvoices', JSON.stringify(savedInvoices));

                showSuccess('Event saved locally!');

                // Also save individual event to history
                saveEventToHistory(instance);

                // Refresh the history display
                refreshEventHistory();

                // Reset the instance to blank for the next entry
                resetInstanceToBlank(instanceId);

            } catch (error) {
                console.error('Error saving instance:', error);
                showError('Failed to save event');
            }
        }

        /**
         * Reset an instance to blank values after saving
         */
        function resetInstanceToBlank(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) return;

            // Reset all fields to blank/default values
            instance.serviceType = '';
            instance.clientName = '';
            instance.clientId = null;
            instance.serviceAddress = '';
            instance.masterCase = '';
            instance.serviceState = 'NE';
            instance.date = '';
            // Service Time
            instance.serviceTimeIn = '';
            instance.serviceTimeOut = '';
            instance.serviceBillableHours = 0;
            // Travel TO
            instance.travelTo = null;
            instance.travelToFrom = '';
            instance.travelToDestination = '';
            instance.travelToMiles = 0;
            instance.travelToTime = 0;
            instance.travelToTimeIn = '';
            instance.travelToTimeOut = '';
            // Travel FROM
            instance.travelFrom = null;
            instance.travelBackFrom = '';
            instance.travelBackDestination = '';
            instance.travelBackMiles = 0;
            instance.travelBackTime = 0;
            instance.travelBackTimeIn = '';
            instance.travelBackTimeOut = '';
            // Additional travel
            instance.additionalTravel = [];
            instance.travelEntries = [];
            // Totals
            instance.totalBillableHours = 0;
            instance.totalMiles = 0;
            instance.comments = '';
            instance.serviceChoice = '';
            instance.travelComments = '';
            instance.travelDuringVisit = false;
            instance.travelServiceType = '';
            instance.travelServiceCode = '';
            instance.serviceCode = '';
            instance.children = [];
            instance.transportBillHours = 0;

            // Re-render the form with blank fields
            renderServiceInstances();
        }

        // ============================================
        // SAVED EVENTS HISTORY MANAGEMENT
        // ============================================

        // Save an individual event to history
        function saveEventToHistory(instance) {
            try {
                const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');

                // Create a history entry with all relevant data
                const eventEntry = {
                    id: instance.id,
                    savedAt: new Date().toISOString(),
                    staffName: document.querySelector('[name="staffName"]')?.value || '',
                    invoiceNumber: document.getElementById('invoiceNumber')?.value || '',
                    invoiceMonth: document.getElementById('invoiceMonth')?.value || '',
                    // Event details
                    serviceType: instance.serviceType,
                    clientName: instance.clientName,
                    clientId: instance.clientId,
                    serviceAddress: instance.serviceAddress,
                    masterCase: instance.masterCase,
                    serviceState: instance.serviceState || 'NE',
                    date: instance.date,
                    travelDuringVisit: instance.travelDuringVisit || false,
                    travelServiceType: instance.travelServiceType || '',
                    travelServiceCode: instance.travelServiceCode || '',
                    serviceCode: instance.serviceCode || '',
                    serviceChoice: instance.serviceChoice || '',
                    travelComments: instance.travelComments || '',
                    children: instance.children || [],
                    transportBillHours: instance.transportBillHours || 0,
                    staffInitials: instance.staffInitials || '',
                    // Service time
                    serviceTimeIn: instance.serviceTimeIn,
                    serviceTimeOut: instance.serviceTimeOut,
                    serviceBillableHours: instance.serviceBillableHours || 0,
                    // Travel
                    travelTo: instance.travelTo || null,
                    travelFrom: instance.travelFrom || null,
                    additionalTravel: instance.additionalTravel || [],
                    // Legacy travel
                    travelEntries: instance.travelEntries || [],
                    // Comments
                    comments: instance.comments || '',
                    // Status
                    status: 'saved'
                };

                // Check if this event already exists (update) or is new
                const existingIndex = savedEvents.findIndex(e => e.id === instance.id);
                if (existingIndex >= 0) {
                    savedEvents[existingIndex] = eventEntry;
                } else {
                    savedEvents.push(eventEntry);
                }

                localStorage.setItem('savedServiceEvents', JSON.stringify(savedEvents));
            } catch (error) {
                console.error('Error saving event to history:', error);
            }
        }

        // Refresh and display the event history
        function refreshEventHistory() {
            const container = document.getElementById('savedEventsContainer');
            if (!container) return;

            try {
                const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');

                if (savedEvents.length === 0) {
                    container.innerHTML = `
                        <div style="color: #6c757d; font-size: 12px; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 6px;">
                            No saved events yet. Complete and save service events to see them here.
                        </div>
                    `;
                    return;
                }

                // Sort by date (most recent first)
                savedEvents.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

                container.innerHTML = savedEvents.map((event, index) => {
                    const eventDate = event.date ? new Date(event.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No date';
                    const timeRange = event.serviceTimeIn && event.serviceTimeOut ?
                        `${formatTime12h(event.serviceTimeIn)} - ${formatTime12h(event.serviceTimeOut)}` : '-';

                    // Calculate total miles
                    let totalMiles = 0;
                    totalMiles += parseFloat(event.travelTo?.miles) || 0;
                    totalMiles += parseFloat(event.travelFrom?.miles) || 0;
                    if (event.additionalTravel) {
                        totalMiles += event.additionalTravel.reduce((sum, t) => sum + (parseFloat(t.miles) || 0), 0);
                    }
                    if (totalMiles === 0 && event.travelEntries) {
                        totalMiles = event.travelEntries.reduce((sum, t) => sum + (parseFloat(t.miles) || 0), 0);
                    }

                    const reimbursement = totalMiles * MILEAGE_RATE;
                    const hours = event.serviceBillableHours || 0;

                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    const savedDate = new Date(event.savedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

                    return `
                        <div class="event-history-card" style="background: ${rowBg}; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: #2c5aa0; font-size: 13px;">${event.clientName || 'Unknown Client'}</div>
                                    <div style="font-size: 11px; color: #666;">${event.serviceType || '-'} | ${eventDate}</div>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button type="button" onclick="editSavedEvent(${event.id})" style="background: #17a2b8; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="Edit this event">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button type="button" onclick="deleteSavedEvent(${event.id})" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;" title="Delete this event">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 11px;">
                                <div style="background: #e8f5e9; padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #666; font-size: 9px;">Time</div>
                                    <div style="font-weight: 600; color: #2e7d32;">${timeRange}</div>
                                </div>
                                <div style="background: #e3f2fd; padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #666; font-size: 9px;">Hours</div>
                                    <div style="font-weight: 600; color: #1565c0;">${hours.toFixed(2)}</div>
                                </div>
                                <div style="background: #fff3e0; padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #666; font-size: 9px;">Miles</div>
                                    <div style="font-weight: 600; color: #e65100;">${totalMiles.toFixed(1)}</div>
                                </div>
                                <div style="background: #f3e5f5; padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #666; font-size: 9px;">Reimb</div>
                                    <div style="font-weight: 600; color: #7b1fa2;">$${reimbursement.toFixed(2)}</div>
                                </div>
                            </div>
                            ${event.serviceAddress ? `<div style="font-size: 10px; color: #888; margin-top: 6px;">üìç ${event.serviceAddress}</div>` : ''}
                            <div style="font-size: 9px; color: #aaa; margin-top: 4px;">Saved: ${savedDate}</div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error refreshing event history:', error);
                container.innerHTML = `
                    <div style="color: #dc3545; font-size: 12px; padding: 20px; text-align: center;">
                        Error loading saved events. Please refresh the page.
                    </div>
                `;
            }
        }

        // Edit a saved event - load it back into the form
        function editSavedEvent(eventId) {
            try {
                const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
                const event = savedEvents.find(e => e.id === eventId);

                if (!event) {
                    showError('Event not found');
                    return;
                }

                // Find or create an instance to edit
                let instance = serviceInstances.find(i => i.id === eventId);

                if (!instance) {
                    // Create a new instance with the saved event's ID
                    instance = {
                        id: eventId,
                        serviceType: event.serviceType || '',
                        clientName: event.clientName || '',
                        clientId: event.clientId || null,
                        serviceAddress: event.serviceAddress || '',
                        masterCase: event.masterCase || '',
                        serviceState: event.serviceState || 'NE',
                        date: event.date || '',
                        serviceTimeIn: event.serviceTimeIn || '',
                        serviceTimeOut: event.serviceTimeOut || '',
                        serviceBillableHours: event.serviceBillableHours || 0,
                        travelTo: event.travelTo || { from: OFFICE_ADDRESS, to: '', departTime: '', arriveTime: '', miles: 0, travelTime: 0 },
                        travelFrom: event.travelFrom || { from: '', to: OFFICE_ADDRESS, departTime: '', arriveTime: '', miles: 0, travelTime: 0 },
                        additionalTravel: event.additionalTravel || [],
                        travelEntries: event.travelEntries || [],
                        comments: event.comments || ''
                    };

                    // Clear existing instances and add this one
                    serviceInstances = [instance];

                    // Update the counter to avoid ID conflicts
                    if (eventId >= instanceIdCounter) {
                        instanceIdCounter = eventId + 1;
                    }
                } else {
                    // Update existing instance with saved data
                    Object.assign(instance, {
                        serviceType: event.serviceType || instance.serviceType,
                        clientName: event.clientName || instance.clientName,
                        clientId: event.clientId || instance.clientId,
                        serviceAddress: event.serviceAddress || instance.serviceAddress,
                        masterCase: event.masterCase || instance.masterCase,
                        serviceState: event.serviceState || instance.serviceState || 'NE',
                        date: event.date || instance.date,
                        serviceTimeIn: event.serviceTimeIn || instance.serviceTimeIn,
                        serviceTimeOut: event.serviceTimeOut || instance.serviceTimeOut,
                        serviceBillableHours: event.serviceBillableHours || instance.serviceBillableHours,
                        travelTo: event.travelTo || instance.travelTo,
                        travelFrom: event.travelFrom || instance.travelFrom,
                        additionalTravel: event.additionalTravel || instance.additionalTravel,
                        comments: event.comments || instance.comments
                    });
                }

                // Restore staff info if available
                if (event.staffName) {
                    const staffSelect = document.querySelector('[name="staffName"]');
                    if (staffSelect) staffSelect.value = event.staffName;
                }
                if (event.invoiceNumber) {
                    const invoiceNumInput = document.getElementById('invoiceNumber');
                    if (invoiceNumInput) invoiceNumInput.value = event.invoiceNumber;
                }
                if (event.invoiceMonth) {
                    const invoiceMonthInput = document.getElementById('invoiceMonth');
                    if (invoiceMonthInput) invoiceMonthInput.value = event.invoiceMonth;
                }

                // Re-render the form
                renderServiceInstances();
                calculateMonthlyTotals();

                // Scroll to the form
                document.getElementById('instancesContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });

                showSuccess(`Editing event for ${event.clientName}`);

            } catch (error) {
                console.error('Error editing saved event:', error);
                showError('Failed to load event for editing');
            }
        }

        // Delete a saved event
        function deleteSavedEvent(eventId) {
            if (!confirm('Are you sure you want to delete this saved event? This cannot be undone.')) {
                return;
            }

            try {
                const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
                const eventIndex = savedEvents.findIndex(e => e.id === eventId);

                if (eventIndex === -1) {
                    showError('Event not found');
                    return;
                }

                const eventName = savedEvents[eventIndex].clientName || 'Event';
                savedEvents.splice(eventIndex, 1);
                localStorage.setItem('savedServiceEvents', JSON.stringify(savedEvents));

                // Refresh the display
                refreshEventHistory();
                showSuccess(`Deleted event for ${eventName}`);

            } catch (error) {
                console.error('Error deleting saved event:', error);
                showError('Failed to delete event');
            }
        }

        // Clear all saved events (for admin use)
        function clearAllSavedEvents() {
            if (!confirm('Are you sure you want to delete ALL saved events? This cannot be undone!')) {
                return;
            }

            try {
                localStorage.removeItem('savedServiceEvents');
                refreshEventHistory();
                showSuccess('All saved events cleared');
            } catch (error) {
                console.error('Error clearing events:', error);
                showError('Failed to clear events');
            }
        }

        // Initialize event history on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Delay slightly to ensure DOM is ready
            setTimeout(refreshEventHistory, 500);
        });

        // ============================================
        // PRF (PERSONAL REIMBURSEMENT FORM) GENERATION
        // ============================================

        // Generate PRF from current service instances
        function generatePRF() {
            // Collect travel data from current service instances
            const travelEntries = collectTravelEntries(serviceInstances);

            if (travelEntries.length === 0) {
                showError('No travel entries found. Please add service events with travel data first.');
                return;
            }

            // Get staff name and month
            const staffName = document.querySelector('[name="staffName"]')?.value || 'Staff Member';
            const invoiceMonth = document.getElementById('invoiceMonth')?.value || '';
            const monthDisplay = invoiceMonth ? formatMonthDisplay(invoiceMonth) : getCurrentMonthDisplay();

            // Generate and display PRF
            displayPRF(travelEntries, staffName, monthDisplay);
        }

        // Generate PRF from saved events history
        function generatePRFFromHistory() {
            try {
                const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');

                if (savedEvents.length === 0) {
                    showError('No saved events found. Please save some service events first.');
                    return;
                }

                // Collect travel data from saved events
                const travelEntries = collectTravelEntries(savedEvents);

                if (travelEntries.length === 0) {
                    showError('No travel entries found in saved events.');
                    return;
                }

                // Get staff name from first event or form
                const staffName = savedEvents[0]?.staffName ||
                                  document.querySelector('[name="staffName"]')?.value ||
                                  'Staff Member';

                // Get month from events or form
                const invoiceMonth = savedEvents[0]?.invoiceMonth ||
                                     document.getElementById('invoiceMonth')?.value || '';
                const monthDisplay = invoiceMonth ? formatMonthDisplay(invoiceMonth) : getCurrentMonthDisplay();

                // Generate and display PRF
                displayPRF(travelEntries, staffName, monthDisplay);

            } catch (error) {
                console.error('Error generating PRF from history:', error);
                showError('Failed to generate PRF from saved events');
            }
        }

        // Collect travel entries from instances/events
        function collectTravelEntries(events) {
            const entries = [];

            events.forEach(event => {
                const baseEntry = {
                    date: event.date || event.serviceDate,
                    clientName: event.clientName || '',
                    serviceType: event.serviceType || ''
                };

                // Travel TO Service
                if (event.travelTo && (event.travelTo.miles > 0 || event.travelTo.from)) {
                    entries.push({
                        ...baseEntry,
                        toFrom: `${event.travelTo.from || 'Office'} to ${event.travelTo.to || event.serviceAddress || 'Service'}`,
                        explanation: `${event.serviceType || 'Service'} - ${event.clientName}`,
                        notes: 'To Service',
                        miles: parseFloat(event.travelTo.miles) || 0
                    });
                }

                // Travel FROM Service
                if (event.travelFrom && (event.travelFrom.miles > 0 || event.travelFrom.from)) {
                    entries.push({
                        ...baseEntry,
                        toFrom: `${event.travelFrom.from || event.serviceAddress || 'Service'} to ${event.travelFrom.to || 'Office'}`,
                        explanation: `${event.serviceType || 'Service'} - ${event.clientName}`,
                        notes: 'From Service',
                        miles: parseFloat(event.travelFrom.miles) || 0
                    });
                }

                // Additional Travel
                if (event.additionalTravel && event.additionalTravel.length > 0) {
                    event.additionalTravel.forEach((travel, idx) => {
                        if (travel.miles > 0 || travel.from) {
                            entries.push({
                                ...baseEntry,
                                toFrom: `${travel.from || ''} to ${travel.to || ''}`,
                                explanation: `${event.serviceType || 'Service'} - ${event.clientName}`,
                                notes: `Extra Trip ${idx + 1}`,
                                miles: parseFloat(travel.miles) || 0
                            });
                        }
                    });
                }

                // Legacy travelEntries support
                if (event.travelEntries && event.travelEntries.length > 0) {
                    event.travelEntries.forEach((travel, idx) => {
                        if (travel.miles > 0 || travel.from) {
                            entries.push({
                                ...baseEntry,
                                toFrom: `${travel.from || ''} to ${travel.to || ''}`,
                                explanation: `${event.serviceType || 'Service'} - ${event.clientName}`,
                                notes: `Trip ${idx + 1}`,
                                miles: parseFloat(travel.miles) || 0
                            });
                        }
                    });
                }
            });

            // Sort by date
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            return entries;
        }

        // Format month from YYYY-MM to display format
        function formatMonthDisplay(monthStr) {
            if (!monthStr) return '';
            const [year, month] = monthStr.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        // Get current month display
        function getCurrentMonthDisplay() {
            const now = new Date();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        }

        // Display the PRF document
        function displayPRF(travelEntries, staffName, monthDisplay) {
            // Calculate totals
            const totalMiles = travelEntries.reduce((sum, e) => sum + (e.miles || 0), 0);
            const totalMileage = totalMiles * MILEAGE_RATE;
            const totalOther = 0; // No other expenses in this version
            const totalReimbursement = totalMileage + totalOther;

            // Build table rows
            const tableRows = travelEntries.map(entry => {
                const dateStr = entry.date ?
                    new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' }) :
                    '';
                const mileageAmount = (entry.miles || 0) * MILEAGE_RATE;

                return `
                    <tr>
                        <td class="date">${dateStr}</td>
                        <td>${entry.toFrom || ''}</td>
                        <td>${entry.explanation || ''}</td>
                        <td class="notes">${entry.notes || ''}</td>
                        <td class="miles">${entry.miles > 0 ? entry.miles.toFixed(1) : ''}</td>
                        <td class="mileage">${mileageAmount > 0 ? '$' + mileageAmount.toFixed(2) : ''}</td>
                        <td class="other"></td>
                    </tr>
                `;
            }).join('');

            // Build PRF HTML
            const prfHTML = `
                <div class="prf-header">
                    <h1>EPWORTH FAMILY RESOURCES</h1>
                    <h2>MONTH: ${monthDisplay}</h2>
                    <h3>PERSONAL REIMBURSEMENT REQUEST</h3>
                </div>

                <div class="prf-meta">
                    <div><strong>Employee:</strong> ${staffName}</div>
                    <div><strong>Rate:</strong> $${MILEAGE_RATE.toFixed(2)}/mile</div>
                </div>

                <table class="prf-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>To / From (Travel Comments)</th>
                            <th>Explanation (Service & Client)</th>
                            <th>Notes</th>
                            <th>Miles</th>
                            <th>Mileage</th>
                            <th>Other</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>TOTALS:</strong></td>
                            <td class="miles"><strong>${totalMiles.toFixed(1)}</strong></td>
                            <td class="mileage"><strong>$${totalMileage.toFixed(2)}</strong></td>
                            <td class="other"><strong>${totalOther > 0 ? '$' + totalOther.toFixed(2) : ''}</strong></td>
                        </tr>
                    </tfoot>
                </table>

                <div class="prf-totals">
                    <div class="prf-totals-row">
                        <span>Total Miles:</span>
                        <strong>${totalMiles.toFixed(1)}</strong>
                    </div>
                    <div class="prf-totals-row">
                        <span>Miles Reimbursement:</span>
                        <strong>$${totalMileage.toFixed(2)}</strong>
                    </div>
                    <div class="prf-totals-row" style="font-size: 14px; border-top: 1px solid #000; padding-top: 5px; margin-top: 5px;">
                        <span>Total Reimbursement:</span>
                        <strong>$${totalReimbursement.toFixed(2)}</strong>
                    </div>
                </div>

                <div class="prf-signatures">
                    <div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">Employee Signature: <strong>${staffName}</strong></div>
                        </div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">Date</div>
                        </div>
                    </div>
                    <div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">FLS Signature</div>
                        </div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">Date</div>
                        </div>
                    </div>
                    <div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">IHS Director Signature</div>
                        </div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">Date</div>
                        </div>
                    </div>
                    <div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">CEO</div>
                        </div>
                        <div class="prf-signature-line">
                            <div class="line"></div>
                            <div class="label">Date</div>
                        </div>
                    </div>
                </div>
            `;

            // Display the PRF
            document.getElementById('prfContent').innerHTML = prfHTML;

            // Show PRF view
            showView('prfOutputView');

            showSuccess('PRF generated successfully! Click Print to create a hard copy.');
        }

        /**
         * SERVICE INSTANCE MANAGEMENT
         * Each instance represents a complete service event with:
         * - Travel TO the client
         * - Service time with the client
         * - Travel BACK from the client
         */
        function addServiceInstance(prefill = null, options = {}) {
            const instanceId = instanceIdCounter++;
            const instance = {
                id: instanceId,
                // Client & Service Info
                serviceType: '',
                serviceChoice: '',
                travelComments: '',
                clientName: '',
                clientId: null,
                serviceAddress: '',
                masterCase: '',
                date: '',
                travelDuringVisit: false,
                travelServiceType: '',
                travelServiceCode: '',
                serviceCode: '',
                transportBillHours: 0,
                staffInitials: '',
                children: [],
                // Service Time
                serviceTimeIn: '',
                serviceTimeOut: '',
                serviceBillableHours: 0,
                // Travel TO client
                travelToFrom: '',
                travelToDestination: '', // Auto-filled from service address
                travelToMiles: 0,
                travelToTime: 0, // in hours
                travelToTimeIn: '',
                travelToTimeOut: '',
                // Travel BACK from client
                travelBackFrom: '', // Auto-filled from service address
                travelBackDestination: '',
                travelBackMiles: 0,
                travelBackTime: 0, // in hours
                travelBackTimeIn: '',
                travelBackTimeOut: '',
                // Totals (calculated)
                totalBillableHours: 0,
                totalMiles: 0,
                comments: ''
            };
            if (prefill && typeof prefill === 'object') {
                Object.assign(instance, prefill);
                instance.id = instanceId;
            }
            serviceInstances.push(instance);
            if (!options.skipRender) {
                renderServiceInstances();
                triggerAutosave();
            }
            return instanceId;
        }

        function removeServiceInstance(instanceId) {
            serviceInstances = serviceInstances.filter(i => i.id !== instanceId);
            renderServiceInstances();
            calculateMonthlyTotals();
            triggerAutosave();
        }

        function normalizeServiceType(value) {
            if (!value) return '';
            const key = value.toString().trim();
            const upper = key.toUpperCase();
            const map = {
                'FS.OH': 'OHFS',
                'FS-OH': 'OHFS',
                'TRAVEL-FS-OH': 'OHFS',
                'TRAVEL-FS.OH': 'OHFS',
                'FSOH': 'OHFS',
                'FS.IH': 'IHFS',
                'FS-IH': 'IHFS',
                'TRAVEL-FS-IH': 'IHFS',
                'TRAVEL-FS.IH': 'IHFS',
                'FSIH': 'IHFS',
                'PT': 'PTSV',
                'PT SERVICES': 'PTSV',
                'TRAVEL-PT': 'PTSV',
                'TRAVEL PT': 'PTSV',
                'TRAVEL-PT-KIDS': 'PTSV',
                'PTSV': 'PTSV',
                'PTSV C': 'PTSV-C',
                'PTSV-C': 'PTSV-C',
                'PT COACHING': 'PTSV-C',
                'DT.BREATH': 'DT.Breath',
                'DT BREATH': 'DT.Breath',
                'DT.SWAB': 'DT.Swab',
                'DT SWAB': 'DT.Swab',
                'DT.UR': 'DT.Urine',
                'DT.URINE': 'DT.Urine',
                'DT URINE': 'DT.Urine',
                'DT.URINALYSIS': 'DT.Urine',
                'DT.PATCH': 'DT.Patch',
                'DT PATCH': 'DT.Patch',
                'DT.SWEAT': 'DT.Sweat',
                'DT SWEAT': 'DT.Sweat'
            };
            return map[upper] || value;
        }

        function renderServiceTypeOptions(selectedValue) {
            const normalized = normalizeServiceType(selectedValue);
            return SERVICE_TYPE_OPTIONS.map(opt =>
                `<option value="${opt.value}" ${normalized === opt.value ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
        }

        function updateTravelBilling(instance) {
            const baseType = normalizeServiceType(instance.serviceType || '');
            instance.serviceCode = SERVICE_CODE_MAP[baseType]?.code || '';

            let travelType = '';
            let travelCode = '';

            if (instance.travelDuringVisit) {
                const isPT = baseType === 'PTSV' || baseType === 'PTSV-C' || baseType === 'PT';
                const hasKids = isPT && instance.children && instance.children.some(c => c.present);

                if (baseType === 'OHFS' || baseType === 'FS.OH') {
                    travelType = 'Travel-FS-OH';
                    travelCode = SERVICE_CODE_MAP['OHFS'].travel;
                } else if (baseType === 'IHFS' || baseType === 'FS.IH') {
                    travelType = 'Travel-FS-IH';
                    travelCode = SERVICE_CODE_MAP['IHFS'].travel;
                } else if (isPT) {
                    travelType = hasKids ? 'Travel-PT-Kids' : 'Travel-PT';
                    travelCode = hasKids
                        ? SERVICE_CODE_MAP['PTSV'].travelKids
                        : SERVICE_CODE_MAP['PTSV'].travel;
                }
            }

            instance.travelServiceType = travelType;
            instance.travelServiceCode = travelCode;
        }

        function setTravelDuringVisit(id, checked) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            instance.travelDuringVisit = checked;
            updateTravelBilling(instance);
            renderServiceInstances();
            triggerAutosave();
        }

        function addChildToInstance(id) {
            const input = document.getElementById(`addChildInput_${id}`);
            if (!input) return;
            const name = input.value.trim();
            if (!name) return;

            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;

            if (!instance.children) instance.children = [];
            instance.children.push({ name, present: true });
            input.value = '';

            updateTravelBilling(instance);
            renderServiceInstances();
            triggerAutosave();
        }

        function toggleChildPresent(id, childIndex, checked) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance || !instance.children || !instance.children[childIndex]) return;
            instance.children[childIndex].present = checked;
            updateTravelBilling(instance);
            renderServiceInstances();
            triggerAutosave();
        }

        function copyLastServiceInstance() {
            if (serviceInstances.length === 0) {
                showError('Add a service event before copying.');
                return;
            }

            const source = JSON.parse(JSON.stringify(serviceInstances[serviceInstances.length - 1]));
            source.id = instanceIdCounter++;

            // Clear time-based fields so the user sets accurate billing data
            source.date = '';
            source.serviceTimeIn = '';
            source.serviceTimeOut = '';
            source.serviceBillableHours = 0;
            source.totalBillableHours = 0;
            source.totalMiles = 0;
            source.comments = '';

            // Reset travel values but keep destinations for convenience
            source.travelToTime = 0;
            source.travelBackTime = 0;
            source.travelToMiles = 0;
            source.travelBackMiles = 0;
            source.travelEntries = [];

            if (source.travelTo) {
                source.travelTo = { ...source.travelTo, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
            }
            if (source.travelFrom) {
                source.travelFrom = { ...source.travelFrom, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
            }
            if (Array.isArray(source.additionalTravel)) {
                source.additionalTravel = source.additionalTravel.map(travel => ({
                    ...travel,
                    departTime: '',
                    arriveTime: '',
                    miles: 0,
                    travelTime: 0
                }));
            }

            serviceInstances.push(source);
            renderServiceInstances();
            triggerAutosave();
            showSuccess('Copied last event. Update date and times before saving.');
        }

        function renderServiceInstances() {
            const container = document.getElementById('instancesContainer');
            if (!container) return;

            const staffInitials = getCurrentStaffInitials();
            const rowsHTML = serviceInstances.map(instance => {
                if (!instance.travelTo) instance.travelTo = { from: OFFICE_ADDRESS, to: '', miles: 0 };
                instance.serviceType = normalizeServiceType(instance.serviceType || '');
                instance.staffInitials = staffInitials;
                updateTravelBilling(instance);
                if (!instance.travelComments) instance.travelComments = getDefaultTravelComment(instance.clientName);
                const miles = parseFloat(instance.travelTo?.miles) || 0;
                instance.transportBillHours = miles > 0 ? parseFloat((miles / 30).toFixed(2)) : 0;
                instance.serviceBillableHours = calculateTimeDiff(instance.serviceTimeIn, instance.serviceTimeOut);
                const travelBadge = instance.travelServiceType
                    ? `<span class="validation-tag ok">${instance.travelServiceType}${instance.travelServiceCode ? ' (' + instance.travelServiceCode + ')' : ''}</span>`
                    : '<span class="validation-tag">No travel</span>';
                return `
                    <tr data-instance-id="${instance.id}">
                        <td>
                            <select class="modern-select" onchange="updateInstanceServiceType(${instance.id}, this.value)">
                                <option value="">Select</option>
                                ${renderServiceTypeOptions(instance.serviceType)}
                            </select>
                            ${instance.serviceCode ? `<div class="tiny-note">Code: ${instance.serviceCode}</div>` : ''}
                            <div style="margin-top:4px;">${travelBadge}</div>
                        </td>
                        <td>
                            <select class="modern-select" onchange="updateServiceChoice(${instance.id}, this.value)">
                                <option value="">Select</option>
                                ${SERVICE_CHOICE_OPTIONS.map(opt => `<option value="${opt}" ${instance.serviceChoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <input type="text" class="modern-input" value="${instance.travelComments || ''}" oninput="updateTravelComments(${instance.id}, this.value)">
                        </td>
                        <td>
                            <select class="modern-select" onchange="updateInstanceClient(${instance.id}, this.value)">
                                <option value="">Select client...</option>
                                ${clientsWithAddresses.length > 0 ?
                                    clientsWithAddresses.map(client =>
                                        `<option value="${client.name}" ${instance.clientName === client.name ? 'selected' : ''}>${client.name}</option>`
                                    ).join('') :
                                    Object.keys(CLIENT_DATABASE).map(client =>
                                        `<option value="${client}" ${instance.clientName === client ? 'selected' : ''}>${client}</option>`
                                    ).join('')
                                }
                            </select>
                            <div class="tiny-note">${instance.masterCase || ''}</div>
                        </td>
                        <td><input type="date" class="modern-input" value="${instance.date || ''}" onchange="updateInstanceDate(${instance.id}, this.value)"></td>
                        <td><input type="time" class="modern-input" value="${instance.serviceTimeIn || ''}" onchange="updateServiceTimeIn(${instance.id}, this.value)"></td>
                        <td><input type="time" class="modern-input" value="${instance.serviceTimeOut || ''}" onchange="updateServiceTimeOut(${instance.id}, this.value)"></td>
                        <td><input type="text" class="modern-input" value="${instance.travelTo?.from || ''}" oninput="updateDriveFromAddress(${instance.id}, this.value)" placeholder="Drive from"></td>
                        <td><input type="text" class="modern-input" value="${instance.travelTo?.to || ''}" oninput="updateDriveToAddress(${instance.id}, this.value)" placeholder="Drive to"></td>
                        <td>
                            <div class="input-with-btn">
                                <input type="number" class="modern-input" value="${miles || ''}" step="0.1" oninput="updateMiles(${instance.id}, this.value)">
                                <button type="button" class="btn-calc" onclick="calcMilesForInstance(${instance.id})" title="Calculate miles">üìç</button>
                            </div>
                        </td>
                        <td><input type="text" class="modern-input readonly" value="${instance.staffInitials || ''}" readonly></td>
                        <td><input type="number" class="modern-input readonly" value="${(instance.transportBillHours || 0).toFixed(2)}" readonly></td>
                        <td>
                            <div style="display:flex; gap:6px;">
                                <button type="button" class="btn-calc orange" onclick="saveCurrentInstance(${instance.id})" title="Save row">üíæ</button>
                                ${serviceInstances.length > 1 ? `<button type="button" class="btn-calc" style="background:#dc3545;" onclick="removeServiceInstance(${instance.id})" title="Remove">‚úï</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="timesheet-grid">
                    <thead>
                        <tr>
                            <th>Service Type</th>
                            <th>Service Choice</th>
                            <th>Travel Comments</th>
                            <th>Client / Case</th>
                            <th>Date</th>
                            <th>Time In</th>
                            <th>Time Out</th>
                            <th>Drive From</th>
                            <th>Drive To</th>
                            <th>Miles</th>
                            <th>Staff Initials</th>
                            <th>Transport Bill Time (hrs)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHTML}</tbody>
                </table>
            `;

            setupAutoSave();
            calculateMonthlyTotals();
            return;
        }

        function getCurrentStaffInitials() {
            const name = document.querySelector('[name="staffName"]')?.value || '';
            return name ? name.split(' ').filter(Boolean).map(part => part[0]).join('').toUpperCase() : '';
        }

        function updateDriveFromAddress(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            if (!instance.travelTo) instance.travelTo = { from: OFFICE_ADDRESS, to: '', miles: 0 };
            instance.travelTo.from = value;
            triggerAutosave();
        }

        function updateDriveToAddress(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            if (!instance.travelTo) instance.travelTo = { from: OFFICE_ADDRESS, to: '', miles: 0 };
            instance.travelTo.to = value;
            triggerAutosave();
        }

        function updateMiles(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            if (!instance.travelTo) instance.travelTo = { from: OFFICE_ADDRESS, to: '', miles: 0 };
            instance.travelTo.miles = parseFloat(value) || 0;
            instance.transportBillHours = instance.travelTo.miles > 0 ? parseFloat((instance.travelTo.miles / 30).toFixed(2)) : 0;
            calculateInstanceTotals(id);
            triggerAutosave();
            renderServiceInstances();
        }

        function calcMilesForInstance(id) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance || !instance.travelTo) return;
            const fromAddress = instance.travelTo.from;
            const toAddress = instance.travelTo.to;
            if (!fromAddress || !toAddress) {
                showError('Please enter both From and To addresses.');
                return;
            }

            if (typeof google === 'undefined' || !google.maps || !google.maps.DistanceMatrixService) {
                showError('Google Maps is not available. Enter miles manually.');
                return;
            }

            const service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [fromAddress],
                destinations: [toAddress],
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status !== 'OK') {
                    showError('Distance lookup failed. Enter miles manually.');
                    return;
                }
                const meters = response.rows[0].elements[0].distance?.value || 0;
                const miles = meters / 1609.34;
                updateMiles(id, miles.toFixed(1));
            });
        }

        function updateTravelComments(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            instance.travelComments = value;
            triggerAutosave();
        }

            // Debug: Log client data availability
            console.log('renderServiceInstances called, clientsWithAddresses:', clientsWithAddresses.length, 'clients');

            container.innerHTML = serviceInstances.map((instance, index) => {
                // Initialize travel structures if not exists
                if (!instance.travelTo) {
                    instance.travelTo = { from: OFFICE_ADDRESS, to: '', departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }
                if (!instance.travelFrom) {
                    instance.travelFrom = { from: '', to: OFFICE_ADDRESS, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }
                if (!instance.additionalTravel) {
                    instance.additionalTravel = [];
                }
                // Backward compatibility - migrate old travelEntries to new structure
                if (instance.travelEntries && instance.travelEntries.length > 0 && !instance._migrated) {
                    instance.additionalTravel = instance.travelEntries;
                    instance._migrated = true;
                }

                // Normalize service type to billing names
                const normalizedType = normalizeServiceType(instance.serviceType || '');
                if (normalizedType && normalizedType !== instance.serviceType) {
                    instance.serviceType = normalizedType;
                }
                updateTravelBilling(instance);

                // Calculate instance totals for display
                const travelToMiles = parseFloat(instance.travelTo?.miles) || 0;
                const travelFromMiles = parseFloat(instance.travelFrom?.miles) || 0;
                const additionalMiles = (instance.additionalTravel || []).reduce((sum, t) => sum + (parseFloat(t.miles) || 0), 0);
                const instanceTotalMiles = travelToMiles + travelFromMiles + additionalMiles;

                const travelToTime = parseFloat(instance.travelTo?.travelTime) || 0;
                const travelFromTime = parseFloat(instance.travelFrom?.travelTime) || 0;
                const additionalTravelTime = (instance.additionalTravel || []).reduce((sum, t) => sum + (parseFloat(t.travelTime) || 0), 0);
                const instanceTravelTime = travelToTime + travelFromTime + additionalTravelTime;

                const instanceMileageReimb = instanceTotalMiles * MILEAGE_RATE;
                const validation = getInstanceValidation(instance);
                const statusBadge = validation.missing.length
                    ? `<span class="validation-tag">‚ö† ${validation.missing.join(', ')} needed</span>`
                    : `<span class="validation-tag ok">${validation.warnings.length ? '‚ö† Check details' : '‚úì Ready'}</span>`;
                const warningMessage = validation.warnings.length
                    ? `<div class="validation-warning">${validation.warnings.join('<br>')}</div>`
                    : '';

                return `
                    <div class="instance-card" data-instance-id="${instance.id}">
                        <div class="instance-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="instance-title">Service Event ${index + 1}</span>
                                ${statusBadge}
                            </div>
                            ${serviceInstances.length > 1 ?
                                `<button type="button" class="remove-instance" onclick="removeServiceInstance(${instance.id})">Remove</button>`
                                : ''}
                        </div>

                        <div class="instance-body">

                        <!-- SECTION 1: SERVICE INFO -->
                        <div class="modern-section service-info">
                            <div class="section-header">
                                <div class="section-icon service-info">üìã</div>
                                <div>
                                    <div class="section-title">Service Information</div>
                                    <div class="section-subtitle">Client and service details</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">Service Type <span class="required">*</span></label>
                                    <select class="modern-select" onchange="updateInstanceServiceType(${instance.id}, this.value)" required>
                                        <option value="">Select service type...</option>
                                        ${renderServiceTypeOptions(instance.serviceType)}
                                    </select>
                                    ${instance.serviceCode ? `<div style="margin-top:6px; font-size:11px; color:#475569;">Billing Code: <strong>${instance.serviceCode}</strong></div>` : ''}
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Service Choice / Prep</label>
                                    <select class="modern-select" onchange="updateServiceChoice(${instance.id}, this.value)">
                                        <option value="">Select choice...</option>
                                        ${SERVICE_CHOICE_OPTIONS.map(opt => `<option value="${opt}" ${instance.serviceChoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">State</label>
                                    <select class="modern-select" onchange="updateInstanceState(${instance.id}, this.value)">
                                        <option value="NE" ${instance.serviceState === 'NE' ? 'selected' : ''}>Nebraska</option>
                                        <option value="KS" ${instance.serviceState === 'KS' ? 'selected' : ''}>Kansas</option>
                                        <option value="IA" ${instance.serviceState === 'IA' ? 'selected' : ''}>Iowa</option>
                                        <option value="MO" ${instance.serviceState === 'MO' ? 'selected' : ''}>Missouri</option>
                                        <option value="CO" ${instance.serviceState === 'CO' ? 'selected' : ''}>Colorado</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">Client <span class="required">*</span></label>
                                    <select id="clientSelect_${instance.id}" class="modern-select" onchange="updateInstanceClient(${instance.id}, this.value)" required>
                                        <option value="">Select client...</option>
                                        ${clientsWithAddresses.length > 0 ?
                                            clientsWithAddresses.map(client =>
                                                `<option value="${client.name}" data-client-id="${client.id}" ${instance.clientName === client.name ? 'selected' : ''}>${client.name}</option>`
                                            ).join('') :
                                            Object.keys(CLIENT_DATABASE).map(client =>
                                                `<option value="${client}" ${instance.clientName === client ? 'selected' : ''}>${client}</option>`
                                            ).join('')
                                        }
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Master Case #</label>
                                    <input type="text" class="modern-input readonly" value="${instance.masterCase || ''}" readonly>
                                </div>
                            </div>

                            <div class="form-row single">
                                <div class="field-group">
                                    <label class="field-label">Service Address</label>
                                    <div class="input-with-btn">
                                        <input type="text" class="modern-input"
                                            id="addressInput_${instance.id}"
                                            list="addressList_${instance.id}"
                                            value="${instance.serviceAddress || ''}"
                                            placeholder="Select or type address..."
                                            onchange="updateInstanceAddressInput(${instance.id}, this.value)"
                                            autocomplete="off">
                                        <datalist id="addressList_${instance.id}">
                                            ${getClientAddressDatalist(instance.clientName)}
                                        </datalist>
                                        <button type="button" class="btn-calc" onclick="showAddAddressInline(${instance.id})" title="Save Address to Client">+ Save</button>
                                    </div>
                                </div>
                            </div>
                            <div id="addAddressInlineForm_${instance.id}" style="display: none; background: #fff; padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid #e2e8f0;">
                                <div class="form-row">
                                    <div class="field-group">
                                        <label class="field-label">Label</label>
                                        <input type="text" class="modern-input" id="newAddressLabel_${instance.id}" placeholder="Home, School, Work...">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Full Address</label>
                                        <input type="text" class="modern-input" id="newAddressValue_${instance.id}" placeholder="123 Main St, City, State ZIP">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 10px;">
                                    <button type="button" onclick="saveInlineAddress(${instance.id})" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">Save to Client</button>
                                    <button type="button" onclick="hideAddAddressInline(${instance.id})" style="flex: 1; background: #e2e8f0; color: #64748b; border: none; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">Cancel</button>
                                </div>
                            </div>

                            <div class="form-row single" style="margin-top: 12px;">
                                <div class="field-group">
                                    <label class="field-label">Service Date <span class="required">*</span></label>
                                    <input type="date" class="modern-input" value="${instance.date}"
                                           onchange="updateInstanceDate(${instance.id}, this.value)" required>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 2: TRAVEL TO SERVICE -->
                        <div class="modern-section travel-to">
                            <div class="section-header">
                                <div class="section-icon travel-to">üöó</div>
                                <div>
                                    <div class="section-title">Travel To Service</div>
                                    <div class="section-subtitle">Starting point to client location</div>
                                </div>
                            </div>

                            <div class="form-row single" style="margin-bottom: 8px;">
                                <div class="field-group">
                                    <label class="field-label">Travel occurred during this visit?</label>
                                    <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
                                        <label style="display:flex; align-items:center; gap:6px; font-size:13px;">
                                            <input type="checkbox" ${instance.travelDuringVisit ? 'checked' : ''} onchange="setTravelDuringVisit(${instance.id}, this.checked)">
                                            <span>Yes, include travel for billing</span>
                                        </label>
                                        ${instance.travelServiceType ? `<span class="validation-tag ok">Travel Category: ${instance.travelServiceType}${instance.travelServiceCode ? ' (' + instance.travelServiceCode + ')' : ''}</span>` : '<span class="validation-tag">Travel code not set</span>'}
                                    </div>
                                </div>
                            </div>

                            ${(instance.serviceType === 'PTSV' || instance.serviceType === 'PTSV-C' || instance.serviceType === 'PT') ? `
                                <div class="form-row single" style="margin-bottom: 8px;">
                                    <div class="field-group">
                                        <label class="field-label">Children present (for Travel-PT-Kids code)</label>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                                            <input type="text" id="addChildInput_${instance.id}" class="modern-input" placeholder="Add child name">
                                            <button type="button" class="btn-calc" style="background:#6366f1;" onclick="addChildToInstance(${instance.id})">Add Child</button>
                                        </div>
                                        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
                                            ${(instance.children && instance.children.length > 0) ? instance.children.map((child, idx) => `
                                                <label style="display:flex; align-items:center; gap:6px; font-size:12px; background:#f8fafc; padding:6px 10px; border-radius:8px; border:1px solid #e2e8f0;">
                                                    <input type="checkbox" ${child.present ? 'checked' : ''} onchange="toggleChildPresent(${instance.id}, ${idx}, this.checked)">
                                                    <span>${child.name}</span>
                                                </label>
                                            `).join('') : '<span style="font-size:12px; color:#64748b;">No children added yet</span>'}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">From</label>
                                    <input type="text" class="modern-input"
                                           id="travelToFrom_${instance.id}"
                                           list="travelAddressList_${instance.id}"
                                           value="${instance.travelTo?.from || OFFICE_ADDRESS}"
                                           placeholder="Starting address..."
                                           onchange="updateTravelTo(${instance.id}, 'from', this.value)"
                                           autocomplete="off">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">To</label>
                                    <input type="text" class="modern-input"
                                           id="travelToTo_${instance.id}"
                                           list="travelAddressList_${instance.id}"
                                           value="${instance.travelTo?.to || instance.serviceAddress || ''}"
                                           placeholder="Service location..."
                                           onchange="updateTravelTo(${instance.id}, 'to', this.value)"
                                           autocomplete="off">
                                </div>
                            </div>
                            <datalist id="travelAddressList_${instance.id}">
                                <option value="${OFFICE_ADDRESS}" label="Office">
                                ${getClientAddressDatalist(instance.clientName)}
                            </datalist>
                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">Depart</label>
                                    <input type="time" class="modern-input" value="${instance.travelTo?.departTime || ''}"
                                           onchange="updateTravelTo(${instance.id}, 'departTime', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Arrive</label>
                                    <input type="time" class="modern-input" value="${instance.travelTo?.arriveTime || ''}"
                                           onchange="updateTravelTo(${instance.id}, 'arriveTime', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">Miles</label>
                                    <div class="input-with-btn">
                                        <input type="number" class="modern-input"
                                               id="travelToMiles_${instance.id}"
                                               value="${instance.travelTo?.miles || ''}"
                                               step="0.1" placeholder="0.0"
                                               onchange="updateTravelTo(${instance.id}, 'miles', this.value)">
                                        <button type="button" class="btn-calc" onclick="calculateTravelToDistance(${instance.id})" title="Calculate miles">üìç Calc</button>
                                    </div>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Travel Time (hrs)</label>
                                    <input type="number" class="modern-input readonly" value="${(instance.travelTo?.travelTime || 0).toFixed(2)}"
                                           step="0.01" readonly>
                                </div>
                            </div>
                            ${travelToMiles > 0 ? `<div class="reimb-badge">üí∞ $${(travelToMiles * MILEAGE_RATE).toFixed(2)}</div>` : ''}
                        </div>

                        <!-- SECTION 3: SERVICE TIME -->
                        <div class="modern-section service-time">
                            <div class="section-header">
                                <div class="section-icon service-time">‚è±Ô∏è</div>
                                <div>
                                    <div class="section-title">Service Time</div>
                                    <div class="section-subtitle">Time spent with client</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="field-group">
                                    <label class="field-label">Time In <span class="required">*</span></label>
                                    <input type="time" class="modern-input" value="${instance.serviceTimeIn || ''}"
                                           onchange="updateServiceTimeIn(${instance.id}, this.value)" required>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Time Out <span class="required">*</span></label>
                                    <input type="time" class="modern-input" value="${instance.serviceTimeOut || ''}"
                                           onchange="updateServiceTimeOut(${instance.id}, this.value)" required>
                                </div>
                            </div>
                            <div class="form-row single">
                                <div class="field-group">
                                    <label class="field-label">Billable Hours</label>
                                    <input type="number" class="modern-input highlight" value="${(instance.serviceBillableHours || 0).toFixed(2)}"
                                           step="0.01" readonly>
                                </div>
                            </div>
                        </div>


        // Update functions for each field
        function updateInstanceServiceType(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceType = normalizeServiceType(value);
                updateTravelBilling(instance);
                renderServiceInstances();
                triggerAutosave();
            }
        }

        function updateInstanceClient(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.clientName = value;
                // Get master case from clients with addresses or fallback to CLIENT_DATABASE
                const client = clientsWithAddresses.find(c => c.name === value);
                instance.masterCase = client?.masterCase || CLIENT_DATABASE[value] || '';
                instance.clientId = client?.id || null;
                instance.serviceAddress = ''; // Reset address when client changes
                if (!instance.travelComments) {
                    instance.travelComments = getDefaultTravelComment(value);
                }

                // Set default state if not already set
                if (!instance.serviceState) {
                    instance.serviceState = 'NE';
                }

                // Initialize travel structures
                if (!instance.travelTo) {
                    instance.travelTo = { from: OFFICE_ADDRESS, to: '', departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }
                if (!instance.travelFrom) {
                    instance.travelFrom = { from: '', to: OFFICE_ADDRESS, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }

                // If client has a primary address, auto-fill it
                if (client?.addresses && client.addresses.length > 0) {
                    const primaryAddress = client.addresses[0].address;
                    instance.serviceAddress = primaryAddress;
                    instance.travelTo.to = primaryAddress;
                    instance.travelFrom.from = primaryAddress;
                }

                renderServiceInstances();
                triggerAutosave();
            }
        }

        function updateInstanceAddress(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                if (value === '__custom__') {
                    // Show custom address input
                    document.getElementById(`customAddressContainer_${id}`).style.display = 'block';
                    instance.serviceAddress = '';
                } else {
                    document.getElementById(`customAddressContainer_${id}`).style.display = 'none';
                    instance.serviceAddress = value;
                    // Auto-fill travel destinations
                    instance.travelToDestination = value;
                    instance.travelBackFrom = value;
                }
                triggerAutosave();
            }
        }

        function updateInstanceCustomAddress(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceAddress = value;
                // Auto-fill travel destinations
                instance.travelToDestination = value;
                instance.travelBackFrom = value;
                triggerAutosave();
            }
        }

        function isKnownAddress(clientName, address) {
            if (!clientName || !address) return false;
            const client = clientsWithAddresses.find(c => c.name === clientName);
            if (!client || !client.addresses) return false;
            return client.addresses.some(addr => addr.address === address);
        }

        function getClientAddressOptions(clientName, selectedAddress) {
            if (!clientName) return '';
            const client = clientsWithAddresses.find(c => c.name === clientName);
            if (!client || !client.addresses || client.addresses.length === 0) {
                return '';
            }
            return client.addresses.map(addr =>
                `<option value="${addr.address}" ${selectedAddress === addr.address ? 'selected' : ''}>${addr.label}: ${addr.address}</option>`
            ).join('');
        }

        function getDefaultTravelComment(clientName) {
            if (!clientName) return '';
            const client = clientsWithAddresses.find(c => c.name === clientName);
            if (client?.travelNote) return client.travelNote;
            if (client?.addresses && client.addresses.length > 0) {
                const primary = client.addresses[0];
                return `Travel to ${primary.label || clientName}`;
            }
            return `Travel to ${clientName}`;
        }

        // Generate datalist options for address autocomplete
        function getClientAddressDatalist(clientName) {
            if (!clientName) return '';
            const client = clientsWithAddresses.find(c => c.name === clientName);
            if (!client || !client.addresses || client.addresses.length === 0) {
                return '';
            }
            return client.addresses.map(addr =>
                `<option value="${addr.address}" label="${addr.label}">`
            ).join('');
        }

        // Handle address input (both typing and selecting from datalist)
        function updateInstanceAddressInput(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceAddress = value;
                // Auto-fill travel TO/FROM addresses when service address is set
                if (value) {
                    // Set Travel TO destination to the service address
                    if (!instance.travelTo) {
                        instance.travelTo = { from: OFFICE_ADDRESS, to: '', departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                    }
                    instance.travelTo.to = value;

                    // Set Travel FROM origin to the service address
                    if (!instance.travelFrom) {
                        instance.travelFrom = { from: '', to: OFFICE_ADDRESS, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                    }
                    instance.travelFrom.from = value;

                    // Legacy fields for backward compatibility
                    instance.travelToDestination = value;
                    instance.travelBackFrom = value;
                    if (!instance.travelComments) {
                        instance.travelComments = getDefaultTravelComment(instance.clientName || '');
                    }
                }
                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Inline address management
        function showAddAddressInline(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.clientName) {
                showError('Please select a client first');
                return;
            }
            document.getElementById(`addAddressInlineForm_${instanceId}`).style.display = 'block';
        }

        function hideAddAddressInline(instanceId) {
            document.getElementById(`addAddressInlineForm_${instanceId}`).style.display = 'none';
            document.getElementById(`newAddressLabel_${instanceId}`).value = '';
            document.getElementById(`newAddressValue_${instanceId}`).value = '';
        }

        async function saveInlineAddress(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.clientId) {
                showError('Please select a client first');
                return;
            }

            const label = document.getElementById(`newAddressLabel_${instanceId}`).value.trim();
            const address = document.getElementById(`newAddressValue_${instanceId}`).value.trim();

            if (!label || !address) {
                showError('Please enter both label and address');
                return;
            }

            try {
                await addClientAddress(instance.clientId, label, address);
                showSuccess('Address saved to client!');

                // Refresh clients list (preserve sample data if db is empty)
                const dbClients = await getClientsWithAddresses();
                if (dbClients && dbClients.length > 0) {
                    clientsWithAddresses = dbClients;
                }

                // Update the instance with the new address
                instance.serviceAddress = address;

                // Hide the form and re-render
                hideAddAddressInline(instanceId);
                renderServiceInstances();
            } catch (error) {
                console.error('Error saving address:', error);
                showError('Failed to save address');
            }
        }

        function updateInstanceDate(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.date = value;
                triggerAutosave();
            }
        }

        // Service Time functions
        function updateServiceTimeIn(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceTimeIn = value;
                calculateServiceHours(id);
                triggerAutosave();
            }
        }

        function updateServiceTimeOut(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceTimeOut = value;
                calculateServiceHours(id);
                triggerAutosave();
            }
        }

        // ============================================
        // TRAVEL ENTRY FUNCTIONS (Multiple travel per event)
        // ============================================

        function addTravelEntry(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance) {
                if (!instance.travelEntries) {
                    instance.travelEntries = [];
                }
                instance.travelEntries.push({
                    from: instance.travelEntries.length === 0 ? OFFICE_ADDRESS : '',
                    to: instance.serviceAddress || '',
                    departTime: '',
                    arriveTime: '',
                    miles: 0,
                    travelTime: 0
                });
                renderServiceInstances();
                triggerAutosave();
            }
        }

        function removeTravelEntry(instanceId, travelIndex) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance && instance.travelEntries) {
                instance.travelEntries.splice(travelIndex, 1);
                renderServiceInstances();
                triggerAutosave();
            }
        }

        function updateTravelEntry(instanceId, travelIndex, field, value) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance && instance.travelEntries && instance.travelEntries[travelIndex]) {
                instance.travelEntries[travelIndex][field] = value;

                // Calculate travel time if both depart and arrive times are set
                const travel = instance.travelEntries[travelIndex];
                if (travel.departTime && travel.arriveTime) {
                    travel.travelTime = calculateTimeDifference(travel.departTime, travel.arriveTime);
                }

                // Update miles to number
                if (field === 'miles') {
                    travel.miles = parseFloat(value) || 0;
                }

                renderServiceInstances();
                triggerAutosave();
            }
        }

        function calculateTimeDifference(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            let startMins = startH * 60 + startM;
            let endMins = endH * 60 + endM;
            if (endMins < startMins) endMins += 24 * 60; // Handle overnight
            return Math.round((endMins - startMins) / 60 * 100) / 100;
        }

        // Calculate travel distance using Google Maps Distance Matrix API
        function calculateTravelDistance(instanceId, travelIndex) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.travelEntries || !instance.travelEntries[travelIndex]) {
                showError('Travel entry not found');
                return;
            }

            const travel = instance.travelEntries[travelIndex];
            const fromAddress = travel.from;
            const toAddress = travel.to;

            if (!fromAddress || !toAddress) {
                showError('Please enter both From and To addresses');
                return;
            }

            // Helper to set miles manually
            function promptManualMiles(reason) {
                const manualMiles = prompt(`${reason}\n\nEnter miles manually for:\n${fromAddress}\n‚Üí ${toAddress}`);
                if (manualMiles && !isNaN(parseFloat(manualMiles))) {
                    travel.miles = parseFloat(manualMiles);
                    const milesInput = document.getElementById(`travelMiles_${instanceId}_${travelIndex}`);
                    if (milesInput) milesInput.value = travel.miles;
                    renderServiceInstances();
                    triggerAutosave();
                    showSuccess(`Miles set to ${travel.miles}`);
                }
            }

            // Check if Google Maps API is available
            if (typeof google === 'undefined' || !google.maps || !google.maps.DistanceMatrixService) {
                promptManualMiles('Google Maps API not available.');
                return;
            }

            // Show loading state
            const calcBtn = event.target;
            const originalText = calcBtn.innerHTML;
            calcBtn.innerHTML = '‚è≥';
            calcBtn.disabled = true;

            try {
                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix({
                    origins: [fromAddress],
                    destinations: [toAddress],
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL
                }, (response, status) => {
                    // Restore button
                    calcBtn.innerHTML = originalText;
                    calcBtn.disabled = false;

                    if (status !== 'OK') {
                        promptManualMiles(`Google Maps error: ${status}`);
                        return;
                    }

                    const result = response.rows[0].elements[0];
                    if (result.status !== 'OK') {
                        promptManualMiles(`Could not find route: ${result.status}`);
                        return;
                    }

                    // Extract miles (Google returns meters, convert to miles)
                    const distanceInMeters = result.distance.value;
                    const distanceInMiles = distanceInMeters / 1609.344;
                    const roundedMiles = Math.round(distanceInMiles * 10) / 10;

                    // Extract travel time in hours
                    const durationInSeconds = result.duration.value;
                    const durationInHours = Math.round((durationInSeconds / 3600) * 100) / 100;

                    // Update the travel entry
                    travel.miles = roundedMiles;
                    travel.calculatedTravelTime = durationInHours;

                    // Update the input field
                    const milesInput = document.getElementById(`travelMiles_${instanceId}_${travelIndex}`);
                    if (milesInput) {
                        milesInput.value = roundedMiles;
                    }

                    // Show success message
                    showSuccess(`Distance: ${roundedMiles} mi (Est. ${result.duration.text})`);

                    // Re-render and save
                    renderServiceInstances();
                    triggerAutosave();
                });
            } catch (error) {
                calcBtn.innerHTML = originalText;
                calcBtn.disabled = false;
                promptManualMiles(`Error: ${error.message}`);
            }
        }

        // ============================================
        // NEW TRAVEL STRUCTURE FUNCTIONS
        // ============================================

        // Update service state
        function updateInstanceState(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.serviceState = value;
                triggerAutosave();
            }
        }

        // Update Travel TO Service fields
        function updateTravelTo(id, field, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                if (!instance.travelTo) {
                    instance.travelTo = { from: OFFICE_ADDRESS, to: '', departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }
                instance.travelTo[field] = value;

                // Calculate travel time if both depart and arrive times are set
                if (instance.travelTo.departTime && instance.travelTo.arriveTime) {
                    instance.travelTo.travelTime = calculateTimeDifference(instance.travelTo.departTime, instance.travelTo.arriveTime);
                }

                // Update miles to number
                if (field === 'miles') {
                    instance.travelTo.miles = parseFloat(value) || 0;
                }

                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Update Travel FROM Service fields
        function updateTravelFrom(id, field, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                if (!instance.travelFrom) {
                    instance.travelFrom = { from: '', to: OFFICE_ADDRESS, departTime: '', arriveTime: '', miles: 0, travelTime: 0 };
                }
                instance.travelFrom[field] = value;

                // Calculate travel time if both depart and arrive times are set
                if (instance.travelFrom.departTime && instance.travelFrom.arriveTime) {
                    instance.travelFrom.travelTime = calculateTimeDifference(instance.travelFrom.departTime, instance.travelFrom.arriveTime);
                }

                // Update miles to number
                if (field === 'miles') {
                    instance.travelFrom.miles = parseFloat(value) || 0;
                }

                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Add additional travel entry
        function addAdditionalTravel(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance) {
                if (!instance.additionalTravel) {
                    instance.additionalTravel = [];
                }
                instance.additionalTravel.push({
                    from: '',
                    to: '',
                    departTime: '',
                    arriveTime: '',
                    miles: 0,
                    travelTime: 0
                });
                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Remove additional travel entry
        function removeAdditionalTravel(instanceId, travelIndex) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance && instance.additionalTravel) {
                instance.additionalTravel.splice(travelIndex, 1);
                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Update additional travel entry fields
        function updateAdditionalTravel(instanceId, travelIndex, field, value) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (instance && instance.additionalTravel && instance.additionalTravel[travelIndex]) {
                instance.additionalTravel[travelIndex][field] = value;

                // Calculate travel time if both depart and arrive times are set
                const travel = instance.additionalTravel[travelIndex];
                if (travel.departTime && travel.arriveTime) {
                    travel.travelTime = calculateTimeDifference(travel.departTime, travel.arriveTime);
                }

                // Update miles to number
                if (field === 'miles') {
                    travel.miles = parseFloat(value) || 0;
                }

                renderServiceInstances();
                triggerAutosave();
            }
        }

        // Calculate distance for Travel TO Service
        function calculateTravelToDistance(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.travelTo) {
                showError('Travel data not found');
                return;
            }

            const fromAddress = instance.travelTo.from;
            const toAddress = instance.travelTo.to;

            if (!fromAddress || !toAddress) {
                showError('Please enter both From and To addresses');
                return;
            }

            calculateDistanceGeneric(fromAddress, toAddress, (miles, duration) => {
                instance.travelTo.miles = miles;
                const milesInput = document.getElementById(`travelToMiles_${instanceId}`);
                if (milesInput) milesInput.value = miles;
                showSuccess(`Distance: ${miles} mi (Est. ${duration})`);
                renderServiceInstances();
                triggerAutosave();
            });
        }

        // Calculate distance for Travel FROM Service
        function calculateTravelFromDistance(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.travelFrom) {
                showError('Travel data not found');
                return;
            }

            const fromAddress = instance.travelFrom.from;
            const toAddress = instance.travelFrom.to;

            if (!fromAddress || !toAddress) {
                showError('Please enter both From and To addresses');
                return;
            }

            calculateDistanceGeneric(fromAddress, toAddress, (miles, duration) => {
                instance.travelFrom.miles = miles;
                const milesInput = document.getElementById(`travelFromMiles_${instanceId}`);
                if (milesInput) milesInput.value = miles;
                showSuccess(`Distance: ${miles} mi (Est. ${duration})`);
                renderServiceInstances();
                triggerAutosave();
            });
        }

        // Calculate distance for Additional Travel
        function calculateAdditionalTravelDistance(instanceId, travelIndex) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance || !instance.additionalTravel || !instance.additionalTravel[travelIndex]) {
                showError('Travel entry not found');
                return;
            }

            const travel = instance.additionalTravel[travelIndex];
            const fromAddress = travel.from;
            const toAddress = travel.to;

            if (!fromAddress || !toAddress) {
                showError('Please enter both From and To addresses');
                return;
            }

            calculateDistanceGeneric(fromAddress, toAddress, (miles, duration) => {
                travel.miles = miles;
                const milesInput = document.getElementById(`additionalMiles_${instanceId}_${travelIndex}`);
                if (milesInput) milesInput.value = miles;
                showSuccess(`Distance: ${miles} mi (Est. ${duration})`);
                renderServiceInstances();
                triggerAutosave();
            });
        }

        // Generic distance calculation helper
        function calculateDistanceGeneric(fromAddress, toAddress, onSuccess) {
            // Helper to set miles manually
            function promptManualMiles(reason) {
                const manualMiles = prompt(`${reason}\n\nEnter miles manually for:\n${fromAddress}\n‚Üí ${toAddress}`);
                if (manualMiles && !isNaN(parseFloat(manualMiles))) {
                    const miles = parseFloat(manualMiles);
                    onSuccess(miles, 'manual entry');
                }
            }

            // Check if Google Maps API is available
            if (typeof google === 'undefined' || !google.maps || !google.maps.DistanceMatrixService) {
                promptManualMiles('Google Maps API not available.');
                return;
            }

            try {
                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix({
                    origins: [fromAddress],
                    destinations: [toAddress],
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL
                }, (response, status) => {
                    if (status !== 'OK') {
                        promptManualMiles(`Google Maps error: ${status}`);
                        return;
                    }

                    const result = response.rows[0].elements[0];
                    if (result.status !== 'OK') {
                        promptManualMiles(`Could not find route: ${result.status}`);
                        return;
                    }

                    // Extract miles (Google returns meters, convert to miles)
                    const distanceInMeters = result.distance.value;
                    const distanceInMiles = distanceInMeters / 1609.344;
                    const roundedMiles = Math.round(distanceInMiles * 10) / 10;

                    onSuccess(roundedMiles, result.duration.text);
                });
            } catch (error) {
                promptManualMiles(`Error: ${error.message}`);
            }
        }

        // Travel TO functions (legacy - kept for backwards compatibility)
        function updateTravelToTimeIn(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelToTimeIn = value;
                calculateTravelToTime(id);
                triggerAutosave();
            }
        }

        function updateTravelToTimeOut(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelToTimeOut = value;
                calculateTravelToTime(id);
                triggerAutosave();
            }
        }

        function updateTravelToFrom(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelToFrom = value;
                triggerAutosave();
            }
        }

        function updateTravelToMiles(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelToMiles = parseFloat(value) || 0;
                calculateInstanceTotals(id);
                triggerAutosave();
            }
        }

        // Travel BACK functions
        function updateTravelBackTimeIn(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelBackTimeIn = value;
                calculateTravelBackTime(id);
                triggerAutosave();
            }
        }

        function updateTravelBackTimeOut(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelBackTimeOut = value;
                calculateTravelBackTime(id);
                triggerAutosave();
            }
        }

        function updateTravelBackDestination(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelBackDestination = value;
                triggerAutosave();
            }
        }

        function updateTravelBackMiles(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.travelBackMiles = parseFloat(value) || 0;
                calculateInstanceTotals(id);
                triggerAutosave();
            }
        }

        function updateInstanceComments(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (instance) {
                instance.comments = value;
                triggerAutosave();
            }
        }

        function updateServiceChoice(id, value) {
            const instance = serviceInstances.find(i => i.id === id);
            if (!instance) return;
            instance.serviceChoice = value;
            triggerAutosave();
        }

        /**
         * CALCULATIONS
         */

        // Calculate time difference in hours
        function calculateTimeDiff(timeIn, timeOut) {
            if (!timeIn || !timeOut) return 0;
            const [inH, inM] = timeIn.split(':').map(Number);
            const [outH, outM] = timeOut.split(':').map(Number);
            const start = inH + inM/60;
            const end = outH + outM/60;
            return end > start ? end - start : (24 - start) + end;
        }

        // Calculate service hours
        function calculateServiceHours(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) return;

            instance.serviceBillableHours = calculateTimeDiff(instance.serviceTimeIn, instance.serviceTimeOut);
            calculateInstanceTotals(instanceId);
            renderServiceInstances();
        }

        // Calculate travel TO time
        function calculateTravelToTime(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) return;

            instance.travelToTime = calculateTimeDiff(instance.travelToTimeIn, instance.travelToTimeOut);
            calculateInstanceTotals(instanceId);
            renderServiceInstances();
        }

        // Calculate travel BACK time
        function calculateTravelBackTime(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) return;

            instance.travelBackTime = calculateTimeDiff(instance.travelBackTimeIn, instance.travelBackTimeOut);
            calculateInstanceTotals(instanceId);
            renderServiceInstances();
        }

        // Calculate instance totals (service + travel)
        function calculateInstanceTotals(instanceId) {
            const instance = serviceInstances.find(i => i.id === instanceId);
            if (!instance) return;

            // Total billable hours = service time + travel time (if travel type)
            const hasTravel = instance.serviceType &&
                (instance.serviceType.includes('Travel') || instance.serviceType.includes('travel'));

            if (hasTravel) {
                instance.totalBillableHours = (instance.serviceBillableHours || 0) +
                                               (instance.travelToTime || 0) +
                                               (instance.travelBackTime || 0);
            } else {
                instance.totalBillableHours = instance.serviceBillableHours || 0;
            }

            // Total miles
            const travelToMiles = (instance.travelToMiles || parseFloat(instance.travelTo?.miles) || 0);
            const travelBackMiles = (instance.travelBackMiles || parseFloat(instance.travelFrom?.miles) || 0);
            instance.totalMiles = travelToMiles + travelBackMiles;

            calculateMonthlyTotals();
        }

        function getInstanceValidation(instance) {
            const missing = [];
            if (!instance.serviceType) missing.push('Service');
            if (!instance.clientName) missing.push('Client');
            if (!instance.date) missing.push('Date');
            if (!instance.serviceTimeIn || !instance.serviceTimeOut) missing.push('Times');

            const warnings = [];
            if (instance.serviceTimeIn && instance.serviceTimeOut) {
                const diff = calculateTimeDiff(instance.serviceTimeIn, instance.serviceTimeOut);
                if (diff === 0) {
                    warnings.push('Time in and out match ‚Äî confirm duration.');
                }
                if (diff > 12) {
                    warnings.push('Service time exceeds 12 hours ‚Äî confirm overnight entry.');
                }
            }

            const travelMiles = (parseFloat(instance.travelTo?.miles) || 0) +
                                (parseFloat(instance.travelFrom?.miles) || 0);
            if (travelMiles === 0 && (
                (instance.travelTo?.from || instance.travelTo?.to || instance.travelFrom?.from || instance.travelFrom?.to)
            )) {
                warnings.push('Travel addresses are set but miles are zero.');
            }

            return { missing, warnings };
        }

        // Calculate monthly totals
        function calculateMonthlyTotals() {
            let totalBillable = 0;
            let totalDrive = 0;
            let totalMiles = 0;

            serviceInstances.forEach(instance => {
                totalBillable += instance.serviceBillableHours || 0;

                // Calculate travel from travelEntries array
                if (instance.travelEntries && instance.travelEntries.length > 0) {
                    instance.travelEntries.forEach(travel => {
                        totalDrive += parseFloat(travel.travelTime) || 0;
                        totalMiles += parseFloat(travel.miles) || 0;
                    });
                } else {
                    // Fallback for legacy data structure
                    totalDrive += (instance.travelToTime || 0) + (instance.travelBackTime || 0);
                    totalMiles += (instance.travelToMiles || 0) + (instance.travelBackMiles || 0);
                }
            });

            const totalReimb = totalMiles * MILEAGE_RATE;

            document.getElementById('totalBillableHours').textContent = totalBillable.toFixed(2);
            document.getElementById('totalDriveTime').textContent = totalDrive.toFixed(2);
            document.getElementById('totalMileage').textContent = totalMiles.toFixed(1) + ' mi';
            document.getElementById('totalReimbursement').textContent = '$' + totalReimb.toFixed(2);

            // Update timesheet summary table
            updateTimesheetSummary();
        }

        // Update the timesheet summary table with all service instances
        function updateTimesheetSummary() {
            const section = document.getElementById('timesheetSummarySection');
            const tbody = document.getElementById('timesheetTableBody');
            const tfoot = document.getElementById('timesheetTableFoot');

            // Filter instances that have at least a date and client
            // Support both 'date' and 'serviceDate' for compatibility
            const validInstances = serviceInstances.filter(i => (i.date || i.serviceDate) && i.clientName);

            if (validInstances.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Sort by date
            validInstances.sort((a, b) => new Date(a.date || a.serviceDate) - new Date(b.date || b.serviceDate));

            let totalHours = 0;
            let totalMiles = 0;

            // Build table rows
            tbody.innerHTML = validInstances.map((instance, idx) => {
                const dateVal = instance.date || instance.serviceDate;
                const date = dateVal ? new Date(dateVal + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-';
                const timeRange = instance.serviceTimeIn && instance.serviceTimeOut ?
                    `${formatTime12h(instance.serviceTimeIn)} - ${formatTime12h(instance.serviceTimeOut)}` : '-';
                const hours = instance.serviceBillableHours || 0;

                // Calculate total miles from new travel structure
                let miles = 0;

                // Travel TO miles
                miles += parseFloat(instance.travelTo?.miles) || 0;

                // Travel FROM miles
                miles += parseFloat(instance.travelFrom?.miles) || 0;

                // Additional travel miles
                if (instance.additionalTravel && instance.additionalTravel.length > 0) {
                    miles += instance.additionalTravel.reduce((sum, t) => sum + (parseFloat(t.miles) || 0), 0);
                }

                // Fallback to legacy structures
                if (miles === 0) {
                    if (instance.travelEntries && instance.travelEntries.length > 0) {
                        miles = instance.travelEntries.reduce((sum, t) => sum + (parseFloat(t.miles) || 0), 0);
                    } else {
                        miles = (instance.travelToMiles || 0) + (instance.travelBackMiles || 0);
                    }
                }

                const reimb = miles * MILEAGE_RATE;

                totalHours += hours;
                totalMiles += miles;

                const rowBg = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';

                return `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${date}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${instance.clientName || '-'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6;">${instance.serviceType || '-'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: center;">${timeRange}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: right;">${hours.toFixed(2)}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: right;">${miles > 0 ? miles.toFixed(1) : '-'}</td>
                        <td style="padding: 6px 8px; border: 1px solid #dee2e6; text-align: right; color: #28a745;">${reimb > 0 ? '$' + reimb.toFixed(2) : '-'}</td>
                    </tr>
                `;
            }).join('');

            // Build totals footer
            const totalReimb = totalMiles * MILEAGE_RATE;
            tfoot.innerHTML = `
                <tr>
                    <td colspan="4" style="padding: 8px; border: 1px solid #dee2e6; text-align: right;"><strong>TOTALS:</strong></td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;"><strong>${totalHours.toFixed(2)}</strong></td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;"><strong>${totalMiles.toFixed(1)}</strong></td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: #28a745;"><strong>$${totalReimb.toFixed(2)}</strong></td>
                </tr>
            `;
        }

        // Helper function to format time to 12-hour format
        function formatTime12h(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':').map(Number);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;
            return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        }

        // Legacy function for backward compatibility
        function calculateWeeklyTotals() {
            calculateMonthlyTotals();
        }

        /**
         * INVOICE SUMMARY FUNCTIONS
         */
        async function saveAndReviewInvoice() {
            // Validate required fields
            const staffName = document.querySelector('[name="staffName"]').value.trim();
            const invoiceMonth = document.getElementById('invoiceMonth').value;

            if (!staffName) {
                showError('Please select a staff member');
                return;
            }

            if (!invoiceMonth) {
                showError('Please select invoice month');
                return;
            }

            if (serviceInstances.length === 0) {
                showError('Please add at least one service event');
                return;
            }

            // Check each instance has required fields
            for (const instance of serviceInstances) {
                if (!instance.serviceType || !instance.clientName || !instance.date || !instance.serviceTimeIn || !instance.serviceTimeOut) {
                    showError('Please complete all required fields in each service event');
                    return;
                }
            }

            // Calculate totals
            let totalBillable = 0;
            let totalDrive = 0;
            let totalMiles = 0;

            serviceInstances.forEach(instance => {
                totalBillable += instance.totalBillableHours || instance.serviceBillableHours || 0;
                totalDrive += (instance.travelToTime || 0) + (instance.travelBackTime || 0);
                totalMiles += instance.totalMiles || 0;
            });

            const totalReimbursement = totalMiles * MILEAGE_RATE;

            // Update summary view
            document.getElementById('summaryStaffName').textContent = staffName;

            // Format month display
            const [year, month] = invoiceMonth.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[parseInt(month) - 1];
            document.getElementById('summaryWeekDates').textContent = `${monthName} ${year}`;
            document.getElementById('summaryWeekRange').textContent = `${monthName} ${year}`;

            // Update totals
            document.getElementById('summaryTotalHours').textContent = totalBillable.toFixed(2);
            document.getElementById('summaryTotalMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('summaryMileagePay').textContent = '$' + totalReimbursement.toFixed(2);
            document.getElementById('summaryInstanceCount').textContent = serviceInstances.length;

            // Update mileage breakdown
            document.getElementById('summaryMilesBreakdown').textContent = totalMiles.toFixed(1) + ' mi';
            document.getElementById('summaryTotalReimbursement').textContent = '$' + totalReimbursement.toFixed(2);

            // Render instances list
            renderSummaryInstances();

            // Show summary view
            showView('invoiceSummaryView');
        }

        function renderSummaryInstances() {
            const container = document.getElementById('summaryInstancesList');

            container.innerHTML = serviceInstances.map(instance => {
                const totalMiles = instance.totalMiles || 0;
                const mileageReimb = totalMiles * MILEAGE_RATE;
                const totalHours = instance.totalBillableHours || instance.serviceBillableHours || 0;
                const hasTravel = instance.serviceType &&
                    (instance.serviceType.includes('Travel') || instance.serviceType.includes('travel'));

                return `
                    <div class="entry-card" style="margin-bottom: 10px;">
                        <div class="entry-header">
                            <div>
                                <div class="entry-title">${instance.clientName}</div>
                                <div class="entry-date">${formatDateDisplay(instance.date)} | ${instance.serviceType}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: #2c5aa0;">${totalHours.toFixed(2)} hrs</div>
                            </div>
                        </div>
                        <div class="entry-details" style="margin-top: 8px;">
                            <div><strong>Service Time:</strong> ${instance.serviceTimeIn || ''} - ${instance.serviceTimeOut || ''} (${(instance.serviceBillableHours || 0).toFixed(2)} hrs)</div>
                            ${instance.serviceAddress ? `<div><strong>Location:</strong> ${instance.serviceAddress}</div>` : ''}
                            ${hasTravel && (instance.travelToMiles > 0 || instance.travelBackMiles > 0) ? `
                                <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee;">
                                    ${instance.travelToMiles > 0 ? `<div>üöó <strong>Travel TO:</strong> ${instance.travelToFrom || ''} ‚Üí ${instance.travelToDestination || instance.serviceAddress || ''} (${instance.travelToMiles.toFixed(1)} mi)</div>` : ''}
                                    ${instance.travelBackMiles > 0 ? `<div>üöó <strong>Travel BACK:</strong> ${instance.travelBackFrom || instance.serviceAddress || ''} ‚Üí ${instance.travelBackDestination || ''} (${instance.travelBackMiles.toFixed(1)} mi)</div>` : ''}
                                    <div style="margin-top: 4px;"><strong>Total Miles:</strong> ${totalMiles.toFixed(1)} mi = <span style="color: #28a745; font-weight: 600;">$${mileageReimb.toFixed(2)}</span></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function submitInvoiceForApproval() {
            if (!confirm('Submit this invoice for approval? You will not be able to edit it after submission.')) {
                return;
            }

            try {
                const staffName = document.querySelector('[name="staffName"]').value.trim();
                const invoiceMonth = document.getElementById('invoiceMonth').value;

                // Calculate month start/end dates
                const [year, month] = invoiceMonth.split('-');
                const monthStartDate = `${year}-${month}-01`;
                const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                const monthEndDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

                // Calculate totals
                let totalBillable = 0;
                let totalDrive = 0;
                let totalMiles = 0;

                serviceInstances.forEach(instance => {
                    totalBillable += instance.totalBillableHours || instance.serviceBillableHours || 0;
                    totalDrive += (instance.travelToTime || 0) + (instance.travelBackTime || 0);
                    totalMiles += instance.totalMiles || 0;
                });

                const totalReimbursement = totalMiles * MILEAGE_RATE;

                const invoiceData = {
                    id: currentEditId || undefined,
                    staffName,
                    weekStartDate: monthStartDate, // Using weekStartDate for backward compatibility
                    weekEndDate: monthEndDate,
                    invoiceMonth: invoiceMonth,
                    status: 'submitted',
                    serviceInstances: serviceInstances,
                    totalBillableHours: totalBillable,
                    totalDriveTime: totalDrive,
                    totalMileage: totalMiles,
                    totalReimbursement: totalReimbursement
                };

                const invoiceId = await saveInvoice(invoiceData);
                await submitInvoice(invoiceId);

                showSuccess('Invoice submitted for approval!');

                // Reset form
                newInvoice();

                // Navigate to dashboard
                if (currentUserData?.role === 'admin') {
                    showView('adminDashboardView');
                } else {
                    showView('dashboardView');
                }
            } catch (error) {
                console.error('Error submitting invoice:', error);
                showError('Failed to submit invoice');
            }
        }

        function printInvoiceSummary() {
            window.print();
        }

        /**
         * AUTO-SAVE
         */
        function setupAutoSave() {
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        if (currentEditId !== null) {
                            saveDraft(true);
                        }
                    }, 2000);
                });
            });
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        /**
         * SAVE & SUBMIT (Supabase)
         */
        function getInvoiceData() {
            const form = document.getElementById('invoiceForm');
            const formData = new FormData(form);

            // Get invoice month and calculate start/end dates
            const invoiceMonth = formData.get('invoiceMonth') || document.getElementById('invoiceMonth')?.value;
            let monthStartDate, monthEndDate;

            if (invoiceMonth) {
                const [year, month] = invoiceMonth.split('-');
                monthStartDate = `${year}-${month}-01`;
                // Get last day of month
                const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                monthEndDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            } else {
                // Fallback to current month
                const now = new Date();
                monthStartDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                monthEndDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
            }

            // Parse totals
            const totalBillableHours = parseFloat(document.getElementById('totalBillableHours').textContent) || 0;
            const totalDriveTime = parseFloat(document.getElementById('totalDriveTime').textContent) || 0;
            const totalMileage = parseFloat(document.getElementById('totalMileage').textContent.replace(' mi', '')) || 0;
            const totalReimbursement = parseFloat(document.getElementById('totalReimbursement').textContent.replace('$', '')) || 0;

            return {
                id: currentEditId,
                weekStartDate: monthStartDate, // Using weekStartDate for backward compatibility
                weekEndDate: monthEndDate,
                invoiceMonth: invoiceMonth,
                serviceInstances: serviceInstances,
                totalBillableHours: totalBillableHours,
                totalDriveTime: totalDriveTime,
                totalMileage: totalMileage,
                totalReimbursement: totalReimbursement,
                status: 'draft'
            };
        }

        async function saveDraft(isAuto = false) {
            if (!currentUser) {
                showError('Please login to save invoices');
                return;
            }

            const data = getInvoiceData();
            data.status = 'draft';

            try {
                const invoiceId = await saveInvoice(data);
                currentEditId = invoiceId;

                if (!isAuto) {
                    showSuccess('Draft saved successfully!');
                } else {
                    showAutoSaveIndicator();
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                if (!isAuto) {
                    showError('Failed to save draft');
                }
            }
        }

        async function submitInvoice() {
            if (!currentUser) {
                showError('Please login to submit invoices');
                return;
            }

            const form = document.getElementById('invoiceForm');

            if (!form.checkValidity()) {
                showError('Please fill out all required fields');
                form.reportValidity();
                return;
            }

            if (serviceInstances.length === 0) {
                showError('Please add at least one service instance');
                return;
            }

            if (!confirm('Submit this invoice for approval?')) {
                return;
            }

            const data = getInvoiceData();
            data.status = 'submitted';

            try {
                await saveInvoice(data);
                showSuccess('Invoice submitted successfully!');
                newInvoice();

                // Return to dashboard
                if (currentUserData.role === 'admin') {
                    showView('adminDashboardView');
                } else {
                    showView('dashboardView');
                }
            } catch (error) {
                console.error('Error submitting invoice:', error);
                showError('Failed to submit invoice');
            }
        }

        /**
         * NAVIGATION
         */
        function handleNewEntry() {
            const isFormView = document.getElementById('formView').classList.contains('active');
            if (isFormView) {
                newInvoice();
            } else {
                switchView('form');
            }
        }

        function newInvoice() {
            if (currentEditId !== null && !confirm('Start a new invoice? Any unsaved changes will be lost.')) {
                return;
            }

            clearLocalDraft();
            document.getElementById('invoiceForm').reset();

            // Set invoice month to current month
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('invoiceMonth').value = monthStr;

            // Set staff name from current user
            if (currentUserData) {
                document.querySelector('[name="staffName"]').value = currentUserData.displayName;
            }

            updateMonthBadge();

            currentEditId = null;
            serviceInstances = [];
            instanceIdCounter = 0;
            addServiceInstance();
            calculateMonthlyTotals();
            showView('formView');
        }

        function switchView(view) {
            // Map old view names to new view IDs
            const viewMap = {
                'form': 'formView',
                'list': 'listView'
            };

            const viewId = viewMap[view] || view;
            showView(viewId);

            // Handle list view buttons
            const listButtons = document.getElementById('listViewButtons');
            if (viewId === 'listView') {
                listButtons.classList.add('show');
                loadEntries(); // Load localStorage entries for backward compatibility
            } else {
                listButtons.classList.remove('show');
            }
        }

        /**
         * SAVED ENTRIES
         */
        function loadEntries() {
            const entries = JSON.parse(localStorage.getItem('invoiceEntries') || '[]');
            const container = document.getElementById('entriesList');

            document.getElementById('savedCount').textContent = entries.length;

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="no-entries">
                        <div style="font-size: 14px; font-weight: 600;">No saved invoices</div>
                        <div style="font-size: 12px; margin-top: 5px;">Create your first invoice</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = entries.map((entry, index) => `
                <div class="entry-card">
                    <div class="entry-header">
                        <div>
                            <div class="entry-title">${entry.staffName || 'Untitled'}</div>
                            <div class="entry-date">${new Date(entry.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="entry-details">
                        <div><strong>Week:</strong> ${entry.weekStartDate || 'N/A'}</div>
                        <div><strong>Instances:</strong> ${JSON.parse(entry.serviceInstances || '[]').length}</div>
                        <div><strong>Total Hours:</strong> ${entry.totalBillableHours || '0.00'}</div>
                        <div><strong>Reimbursement:</strong> ${entry.totalReimbursement || '$0.00'}</div>
                    </div>
                    <div class="entry-actions">
                        <button class="btn-primary" onclick="loadEntry(${index})">Edit</button>
                        <button class="btn-secondary" onclick="printEntry(${index})">Print</button>
                        <button class="btn-danger" onclick="deleteEntry(${index})">Delete</button>
                    </div>
                </div>
            `).reverse().join('');
        }

        function loadEntry(index) {
            const entries = JSON.parse(localStorage.getItem('invoiceEntries') || '[]');
            const entry = entries[index];

            if (!entry) return;

            const form = document.getElementById('invoiceForm');
            Object.keys(entry).forEach(key => {
                if (key === 'serviceInstances') {
                    try {
                        serviceInstances = JSON.parse(entry[key]);
                        instanceIdCounter = Math.max(...serviceInstances.map(s => s.id), 0) + 1;
                        renderServiceInstances();
                        calculateWeeklyTotals();
                    } catch (e) {
                        serviceInstances = [];
                        instanceIdCounter = 0;
                        addServiceInstance();
                    }
                } else {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = entry[key] || '';
                    }
                }
            });

            updateWeekBadge();
            currentEditId = index;
            switchView('form');
        }

        function deleteEntry(index) {
            if (!confirm('Delete this invoice?')) return;

            let entries = JSON.parse(localStorage.getItem('invoiceEntries') || '[]');
            entries.splice(index, 1);
            localStorage.setItem('invoiceEntries', JSON.stringify(entries));

            if (currentEditId === index) {
                newInvoice();
            } else if (currentEditId > index) {
                currentEditId--;
            }

            loadEntries();
        }

        function printEntry(index) {
            loadEntry(index);
            setTimeout(() => window.print(), 100);
        }

        function exportAll() {
            const entries = JSON.parse(localStorage.getItem('invoiceEntries') || '[]');
            if (entries.length === 0) {
                alert('No invoices to export');
                return;
            }

            const dataStr = JSON.stringify(entries, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `invoice_entries_${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function clearAllDrafts() {
            if (!confirm('Delete all saved invoices?')) {
                return;
            }

            localStorage.removeItem('invoiceEntries');
            newInvoice();
            loadEntries();
        }

        /**
         * TRAVEL LOG GENERATOR
         */
        let travelLogFiles = [];
        let travelLogParsedData = [];

        const TRAVEL_LOG_COLUMN_MAP = {
            serviceType: 0,
            serviceChoice: 1,
            travelComments: 2,
            clientName: 3,
            masterCase: 4,
            date: 5,
            timeIn: 6,
            timeOut: 7,
            driveFrom: 8,
            driveTo: 9,
            miles: 10,
            staffInitials: 11,
            billableHours: 23,
            driveTotal: 26
        };

        // Initialize travel log generator when view is shown
        function initTravelLogGenerator() {
            const now = new Date();
            const monthSelect = document.getElementById('travelLogMonth');
            const yearInput = document.getElementById('travelLogYear');
            if (monthSelect) monthSelect.value = now.toLocaleString('default', { month: 'long' });
            if (yearInput) yearInput.value = now.getFullYear();

            // Update saved events count
            updateSavedEventsCount();

            const uploadArea = document.getElementById('travelLogUploadArea');
            const fileInput = document.getElementById('travelLogFileInput');

            if (uploadArea && !uploadArea.hasAttribute('data-initialized')) {
                uploadArea.setAttribute('data-initialized', 'true');

                uploadArea.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') {
                        fileInput.click();
                    }
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = '#d4edda';
                    uploadArea.style.borderColor = '#28a745';
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.background = '#f8fafc';
                    uploadArea.style.borderColor = '#2c5aa0';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = '#f8fafc';
                    uploadArea.style.borderColor = '#2c5aa0';
                    handleTravelLogFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => handleTravelLogFiles(e.target.files));
            }
        }

        function handleTravelLogFiles(files) {
            for (const file of files) {
                if (!travelLogFiles.some(f => f.name === file.name)) {
                    travelLogFiles.push(file);
                }
            }
            updateTravelLogFileList();
        }

        function updateTravelLogFileList() {
            const fileList = document.getElementById('travelLogFileList');
            fileList.innerHTML = travelLogFiles.map((file, i) => `
                <div style="background: #e8f0fe; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                    <span>üìÑ ${file.name}</span>
                    <button onclick="removeTravelLogFile(${i})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">√ó</button>
                </div>
            `).join('');

            document.getElementById('travelLogProcessBtn').style.display = travelLogFiles.length > 0 ? 'inline-block' : 'none';
            document.getElementById('travelLogClearBtn').style.display = travelLogFiles.length > 0 ? 'inline-block' : 'none';
        }

        function removeTravelLogFile(index) {
            travelLogFiles.splice(index, 1);
            updateTravelLogFileList();
        }

        function clearTravelLogFiles() {
            travelLogFiles = [];
            travelLogParsedData = [];
            updateTravelLogFileList();
            document.getElementById('travelLogPreview').style.display = 'none';
        }

        // Generate travel logs from saved service events
        function generateTravelLogsFromSavedEvents() {
            const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');

            if (savedEvents.length === 0) {
                showError('No saved service events found. Please save some events in the Invoice System first.');
                return;
            }

            // Convert saved events to travel log format
            travelLogParsedData = [];

            savedEvents.forEach(event => {
                const dateStr = event.date || event.serviceDate;
                if (!dateStr) return;

                const dateObj = new Date(dateStr + 'T00:00:00');
                const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}/${String(dateObj.getFullYear()).slice(-2)}`;

                // Travel TO entry
                if (event.travelTo && parseFloat(event.travelTo.miles) > 0) {
                    travelLogParsedData.push({
                        serviceType: event.serviceType || 'Travel',
                        serviceChoice: 'Travel-to',
                        travelComments: `${event.travelTo.from || 'Office'} to ${event.travelTo.to || event.serviceAddress || 'Service'}`,
                        clientName: event.clientName || '',
                        masterCase: event.masterCase || '',
                        date: formattedDate,
                        timeIn: event.travelTo.departTime || '',
                        timeOut: event.travelTo.arriveTime || '',
                        driveFrom: event.travelTo.from || 'Office',
                        driveTo: event.travelTo.to || event.serviceAddress || 'Service',
                        miles: parseFloat(event.travelTo.miles) || 0,
                        travelHours: (parseFloat(event.travelTo.travelTime) || 0) / 60,
                        billableHours: 0,
                        staffName: event.staffName || 'Staff Member',
                        isTravel: true,
                        sourceFile: 'Saved Events'
                    });
                }

                // Service entry (not travel, but for reference)
                if (event.serviceBillableHours > 0) {
                    travelLogParsedData.push({
                        serviceType: event.serviceType || 'Service',
                        serviceChoice: event.serviceType || 'Service',
                        travelComments: '',
                        clientName: event.clientName || '',
                        masterCase: event.masterCase || '',
                        date: formattedDate,
                        timeIn: event.serviceTimeIn || '',
                        timeOut: event.serviceTimeOut || '',
                        driveFrom: '',
                        driveTo: '',
                        miles: 0,
                        travelHours: 0,
                        billableHours: parseFloat(event.serviceBillableHours) || 0,
                        staffName: event.staffName || 'Staff Member',
                        isTravel: false,
                        sourceFile: 'Saved Events'
                    });
                }

                // Travel FROM entry
                if (event.travelFrom && parseFloat(event.travelFrom.miles) > 0) {
                    travelLogParsedData.push({
                        serviceType: event.serviceType || 'Travel',
                        serviceChoice: 'Travel-from',
                        travelComments: `${event.travelFrom.from || event.serviceAddress || 'Service'} to ${event.travelFrom.to || 'Office'}`,
                        clientName: event.clientName || '',
                        masterCase: event.masterCase || '',
                        date: formattedDate,
                        timeIn: event.travelFrom.departTime || '',
                        timeOut: event.travelFrom.arriveTime || '',
                        driveFrom: event.travelFrom.from || event.serviceAddress || 'Service',
                        driveTo: event.travelFrom.to || 'Office',
                        miles: parseFloat(event.travelFrom.miles) || 0,
                        travelHours: (parseFloat(event.travelFrom.travelTime) || 0) / 60,
                        billableHours: 0,
                        staffName: event.staffName || 'Staff Member',
                        isTravel: true,
                        sourceFile: 'Saved Events'
                    });
                }

                // Additional travel entries
                if (event.additionalTravel && Array.isArray(event.additionalTravel)) {
                    event.additionalTravel.forEach((travel, idx) => {
                        if (parseFloat(travel.miles) > 0) {
                            travelLogParsedData.push({
                                serviceType: event.serviceType || 'Travel',
                                serviceChoice: 'Additional-travel',
                                travelComments: `${travel.from || ''} to ${travel.to || ''}`,
                                clientName: event.clientName || '',
                                masterCase: event.masterCase || '',
                                date: formattedDate,
                                timeIn: travel.departTime || '',
                                timeOut: travel.arriveTime || '',
                                driveFrom: travel.from || '',
                                driveTo: travel.to || '',
                                miles: parseFloat(travel.miles) || 0,
                                travelHours: (parseFloat(travel.travelTime) || 0) / 60,
                                billableHours: 0,
                                staffName: event.staffName || 'Staff Member',
                                isTravel: true,
                                sourceFile: 'Saved Events'
                            });
                        }
                    });
                }
            });

            if (travelLogParsedData.length > 0) {
                showSuccess(`Generated ${travelLogParsedData.length} entries from ${savedEvents.length} saved events!`);
                generateTravelLogForms();
            } else {
                showError('No travel entries found in saved events. Make sure events have travel data.');
            }
        }

        // Update saved events count when viewing travel log generator
        function updateSavedEventsCount() {
            const savedEvents = JSON.parse(localStorage.getItem('savedServiceEvents') || '[]');
            const countEl = document.getElementById('savedEventsCount');
            if (countEl) {
                countEl.textContent = `(${savedEvents.length} events available)`;
            }
        }

        async function processTimesheets() {
            travelLogParsedData = [];

            for (const file of travelLogFiles) {
                try {
                    const data = await parseTravelLogFile(file);
                    travelLogParsedData.push(...data);
                } catch (error) {
                    console.error(`Error parsing ${file.name}:`, error);
                }
            }

            if (travelLogParsedData.length > 0) {
                generateTravelLogForms();
            } else {
                showError('No data could be parsed from the uploaded files.');
            }
        }

        function parseTravelLogFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        let headerRowIndex = findTravelLogHeaderRow(jsonData);
                        let staffName = extractTravelLogStaffName(jsonData, file.name);

                        const entries = [];
                        for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            const entry = parseTravelLogRow(row, staffName, file.name);
                            if (entry) entries.push(entry);
                        }
                        resolve(entries);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function findTravelLogHeaderRow(jsonData) {
            for (let i = 0; i < Math.min(jsonData.length, 15); i++) {
                const row = jsonData[i];
                if (!row) continue;
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                if (rowText.includes('service type') || (rowText.includes('master case') && rowText.includes('date'))) {
                    return i;
                }
            }
            return 7;
        }

        function extractTravelLogStaffName(jsonData, fileName) {
            for (let i = 0; i < Math.min(jsonData.length, 5); i++) {
                const row = jsonData[i];
                if (!row) continue;
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toLowerCase();
                    if (cell.includes('name:') && row[j + 1]) {
                        return String(row[j + 1]).trim();
                    }
                }
            }
            const match = fileName.match(/^([^.]+)\.([^.]+)/);
            return match ? `${match[2]} ${match[1]}` : 'Unknown Staff';
        }

        function parseTravelLogRow(row, staffName, fileName) {
            const serviceType = String(row[TRAVEL_LOG_COLUMN_MAP.serviceType] || '').trim();
            if (!serviceType || serviceType.toLowerCase().includes('service type')) return null;

            const clientName = String(row[TRAVEL_LOG_COLUMN_MAP.clientName] || '').trim();
            if (!clientName) return null;

            const rawDate = row[TRAVEL_LOG_COLUMN_MAP.date];
            const miles = parseFloat(row[TRAVEL_LOG_COLUMN_MAP.miles]) || 0;
            let travelHours = parseFloat(row[TRAVEL_LOG_COLUMN_MAP.driveTotal]) || 0;

            if (travelHours === 0) {
                const timeIn = row[TRAVEL_LOG_COLUMN_MAP.timeIn];
                const timeOut = row[TRAVEL_LOG_COLUMN_MAP.timeOut];
                if (typeof timeIn === 'number' && typeof timeOut === 'number') {
                    travelHours = (timeOut - timeIn) * 24;
                }
            }

            return {
                fileName,
                staffName,
                staffInitials: String(row[TRAVEL_LOG_COLUMN_MAP.staffInitials] || '').trim(),
                serviceType,
                travelComments: String(row[TRAVEL_LOG_COLUMN_MAP.travelComments] || '').trim(),
                clientName,
                masterCase: String(row[TRAVEL_LOG_COLUMN_MAP.masterCase] || '').trim(),
                date: parseTravelLogDate(rawDate),
                dateObj: parseTravelLogDateObj(rawDate),
                timeIn: parseTravelLogTime(row[TRAVEL_LOG_COLUMN_MAP.timeIn]),
                timeOut: parseTravelLogTime(row[TRAVEL_LOG_COLUMN_MAP.timeOut]),
                driveFrom: String(row[TRAVEL_LOG_COLUMN_MAP.driveFrom] || '').trim(),
                driveTo: String(row[TRAVEL_LOG_COLUMN_MAP.driveTo] || '').trim(),
                miles,
                travelHours,
                billableHours: parseFloat(row[TRAVEL_LOG_COLUMN_MAP.billableHours]) || 0,
                isTravel: serviceType.toLowerCase().includes('travel') || miles > 0
            };
        }

        function parseTravelLogDate(value) {
            if (!value) return '';
            if (typeof value === 'number') {
                const date = XLSX.SSF.parse_date_code(value);
                if (date) return `${date.m}/${date.d}/${String(date.y).slice(-2)}`;
            }
            return String(value);
        }

        function parseTravelLogDateObj(value) {
            if (!value) return null;
            if (typeof value === 'number') {
                const date = XLSX.SSF.parse_date_code(value);
                if (date) return new Date(date.y, date.m - 1, date.d);
            }
            return new Date(value);
        }

        function parseTravelLogTime(value) {
            if (!value) return '';
            if (typeof value === 'number') {
                const totalMinutes = Math.round(value * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                return `${displayHours}:${String(minutes).padStart(2, '0')} ${period}`;
            }
            return String(value);
        }

        function generateTravelLogForms() {
            const month = document.getElementById('travelLogMonth').value;
            const year = document.getElementById('travelLogYear').value;
            const contractor = document.getElementById('travelLogContractor').value;

            const byClientService = {};
            travelLogParsedData.forEach(entry => {
                if (!entry.isTravel) return;

                let serviceCategory = 'Travel';
                if (entry.serviceType.includes('PT')) serviceCategory = 'Travel-PT';
                if (entry.serviceType.includes('FS-OH') || entry.serviceType.includes('FS.OH') || entry.serviceType.includes('OHFS')) serviceCategory = 'Travel-FS-OH';
                if (entry.serviceType.includes('FS-IH') || entry.serviceType.includes('FS.IH') || entry.serviceType.includes('IHFS')) serviceCategory = 'Travel-FS-IH';

                const key = `${entry.clientName}|${entry.masterCase}|${serviceCategory}|${entry.staffName}`;

                if (!byClientService[key]) {
                    byClientService[key] = {
                        clientName: entry.clientName,
                        masterCase: entry.masterCase,
                        serviceType: serviceCategory,
                        staffName: entry.staffName,
                        entries: []
                    };
                }
                byClientService[key].entries.push(entry);
            });

            // Generate travel logs section (standalone documents)
            let travelLogsHtml = '<div id="travelLogsSection">';
            Object.values(byClientService).forEach(group => {
                travelLogsHtml += generateSingleTravelLogForm(group, month, year, contractor);
            });
            travelLogsHtml += '</div>';

            // Generate summary sheets section (separate documents)
            let summaryHtml = '<div id="summarySection" style="page-break-before: always;">';
            summaryHtml += generateTravelLogTotalsSheet(month, year, contractor);
            summaryHtml += '</div>';

            document.getElementById('travelLogPrintArea').innerHTML = travelLogsHtml + summaryHtml;
            document.getElementById('travelLogPreview').style.display = 'block';
            document.getElementById('travelLogPreviewTitle').textContent = `Generated ${Object.keys(byClientService).length} Travel Logs`;
        }

        // Helper function to capitalize names properly
        function capitalizeName(name) {
            if (!name) return '';
            return name.toLowerCase().split(' ').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function generateSingleTravelLogForm(group, month, year, contractor) {
            const entries = group.entries.sort((a, b) => (a.dateObj || 0) - (b.dateObj || 0));
            const totalMiles = entries.reduce((sum, e) => sum + e.miles, 0);
            const totalHours = entries.reduce((sum, e) => sum + e.travelHours, 0);

            // Capitalize names
            const staffNameFormatted = capitalizeName(group.staffName);
            const clientNameFormatted = capitalizeName(group.clientName);

            // Get today's date for signature
            const today = new Date();
            const todayFormatted = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;

            // Calculate how many pages needed (15 rows per page for data, but we'll use 20 for continuation pages)
            const rowsPerFirstPage = 15;
            const rowsPerContinuationPage = 20;
            const totalEntries = entries.length;

            // Generate all data rows
            function generateDataRow(entry) {
                return `<tr>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; text-align: center;">${entry.date}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px;"></td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px;"></td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; text-align: center;">${entry.miles || ''}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; text-align: center;">${entry.timeIn}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; text-align: center;">${entry.timeOut}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; text-align: center;">${entry.travelHours ? entry.travelHours.toFixed(2) : ''}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; font-size: 9px;">${entry.driveFrom}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; font-size: 9px;">${entry.driveTo}</td>
                    <td contenteditable="true" style="border: 1px solid #000; padding: 4px; font-size: 9px;">${entry.travelComments}</td>
                </tr>`;
            }

            function generateEmptyRow() {
                return `<tr><td contenteditable="true" style="border: 1px solid #000; padding: 4px; height: 22px;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td><td contenteditable="true" style="border: 1px solid #000;"></td></tr>`;
            }

            function generateHeader(pageNum, totalPages) {
                const pageIndicator = totalPages > 1 ? ` (Page ${pageNum} of ${totalPages})` : '';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px double #000; padding-bottom: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="HHS%20logo.png" alt="DHHS Logo" style="width: 180px; height: auto;">
                        </div>
                        <div style="text-align: center; flex: 1; padding: 0 15px;">
                            <div style="font-weight: bold; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">Nebraska Department of Health and Human Services</div>
                            <div style="font-weight: bold; font-size: 14px; margin-top: 2px;">Division of Children and Family Services</div>
                            <div style="font-size: 13px; font-style: italic; margin-top: 4px;">Child Welfare Service Provider Travel Log${pageIndicator}</div>
                            <div style="font-size: 15px; font-weight: bold; margin-top: 6px; padding: 4px 12px; background: #f0f0f0; display: inline-block; border: 1px solid #ccc;">${group.serviceType}</div>
                        </div>
                        <div style="text-align: right; font-size: 11px;">
                            <table style="border-collapse: collapse;"><tr><td style="border: 1px solid #000; padding: 3px 8px; font-weight: bold; background: #e8e8e8; text-transform: uppercase; font-size: 10px;">Month:</td><td contenteditable="true" style="border: 1px solid #000; padding: 3px 8px; min-width: 60px;">${month}</td><td style="border: 1px solid #000; padding: 3px 8px; font-weight: bold; background: #e8e8e8; text-transform: uppercase; font-size: 10px;">Year:</td><td contenteditable="true" style="border: 1px solid #000; padding: 3px 8px;">${year}</td></tr><tr><td style="border: 1px solid #000; padding: 3px 8px; font-weight: bold; background: #e8e8e8; text-transform: uppercase; font-size: 10px;">Contractor:</td><td contenteditable="true" style="border: 1px solid #000; padding: 3px 8px;" colspan="3">${contractor}</td></tr><tr><td style="border: 1px solid #000; padding: 3px 8px; font-weight: bold; background: #e8e8e8; text-transform: uppercase; font-size: 10px;">Staff:</td><td contenteditable="true" style="border: 1px solid #000; padding: 3px 8px;" colspan="3">${staffNameFormatted}</td></tr></table>
                        </div>
                    </div>
                    <div style="border: 2px solid #000; padding: 8px 12px; margin-bottom: 12px; background: #fafafa;">
                        <div style="font-weight: bold; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 6px;">Case Information</div>
                        <div style="display: flex; gap: 30px;">
                            <div><span style="font-weight: bold; font-size: 10px; text-transform: uppercase;">Client Name:</span> <span contenteditable="true" style="font-weight: 600; font-size: 12px;">${clientNameFormatted}</span></div>
                            <div><span style="font-weight: bold; font-size: 10px; text-transform: uppercase;">Master Case #:</span> <span contenteditable="true" style="font-weight: 600; font-size: 12px;">${group.masterCase}</span></div>
                        </div>
                    </div>`;
            }

            function generateTableHeader() {
                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; border: 2px solid #000;">
                        <thead>
                            <tr><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" rowspan="2">Day of<br>Month</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" colspan="2">Odometer Reading</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" rowspan="2">Total Miles<br>Traveled</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" colspan="2">Travel Time</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" rowspan="2">Total Hours<br>Travelled</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" colspan="2">Travel Destination Addresses</th><th style="border: 2px solid #000; padding: 6px 4px; background: #d0d0d0; font-weight: bold; text-transform: uppercase; font-size: 9px;" rowspan="2">Purpose</th></tr>
                            <tr><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">Start</th><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">Finish</th><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">Start</th><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">Finish</th><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">From</th><th style="border: 1px solid #000; padding: 4px; background: #e8e8e8; font-size: 8px; font-weight: 600;">To</th></tr>
                        </thead>
                        <tbody>`;
            }

            function generateSignatureSection() {
                return `
                    <div style="margin-top: 20px; border: 2px solid #000; padding: 12px;">
                        <div style="font-weight: bold; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Certification & Signatures</div>
                        <div style="display: flex; gap: 12px; font-size: 9px;">
                            <div style="flex: 1.5; background: #f8f8f8; border: 1px solid #ccc; padding: 10px; font-size: 8px; line-height: 1.4;">
                                <strong style="display: block; margin-bottom: 4px;">CERTIFICATION STATEMENT:</strong>
                                By signing this form, the signor certifies that the information contained in this document is true, complete and accurate, and in compliance with the Child Welfare Service contract. Anyone filing a false claim may be prosecuted for fraud.
                            </div>
                            <div style="flex: 1; border: 1px solid #000; padding: 10px; text-align: center; background: white;">
                                <div style="font-weight: bold; text-transform: uppercase; font-size: 9px; margin-bottom: 8px;">Preparer's Signature</div>
                                <div contenteditable="true" class="signature-text" style="border-bottom: 2px solid #000; margin: 8px 10px; height: 28px; font-family: 'Dancing Script', 'Brush Script MT', cursive; font-size: 22px; color: #000080;">${staffNameFormatted}</div>
                                <div style="font-size: 8px; color: #666; margin-top: 8px;">Printed Name</div>
                                <div contenteditable="true" style="font-weight: 500;">${staffNameFormatted}</div>
                            </div>
                            <div style="width: 70px; border: 1px solid #000; padding: 10px; text-align: center; background: white;">
                                <div style="font-weight: bold; font-size: 9px;">DATE</div>
                                <div contenteditable="true" style="border-bottom: 2px solid #000; margin: 15px 5px; height: 22px; font-size: 11px;">${todayFormatted}</div>
                            </div>
                            <div style="flex: 1; border: 1px solid #000; padding: 10px; text-align: center; background: white;">
                                <div style="font-weight: bold; text-transform: uppercase; font-size: 9px; margin-bottom: 8px;">Authorized Approval Agent</div>
                                <div contenteditable="true" class="signature-text" style="border-bottom: 2px solid #000; margin: 8px 10px; height: 28px; font-family: 'Dancing Script', 'Brush Script MT', cursive; font-size: 22px; color: #000080;">Brandon Hinrichs</div>
                                <div style="font-size: 8px; color: #666; margin-top: 8px;">Printed Name</div>
                                <div contenteditable="true" style="font-weight: 500;">Brandon Hinrichs</div>
                            </div>
                            <div style="width: 70px; border: 1px solid #000; padding: 10px; text-align: center; background: white;">
                                <div style="font-weight: bold; font-size: 9px;">DATE</div>
                                <div contenteditable="true" style="border-bottom: 2px solid #000; margin: 15px 5px; height: 22px; font-size: 11px;">${todayFormatted}</div>
                            </div>
                        </div>
                    </div>`;
            }

            // Calculate total pages needed
            let totalPages = 1;
            if (totalEntries > rowsPerFirstPage) {
                totalPages = 1 + Math.ceil((totalEntries - rowsPerFirstPage) / rowsPerContinuationPage);
            }

            let html = '';
            let entryIndex = 0;

            for (let page = 1; page <= totalPages; page++) {
                const isLastPage = page === totalPages;
                const rowsThisPage = page === 1 ? rowsPerFirstPage : rowsPerContinuationPage;

                html += `<div class="travel-log-form" style="border: 3px solid #000; padding: 18px; margin-bottom: 25px; font-family: 'Times New Roman', Times, serif; font-size: 11px; background: white; ${!isLastPage ? 'page-break-after: always;' : ''}">`;
                html += generateHeader(page, totalPages);
                html += generateTableHeader();

                // Add data rows for this page
                for (let i = 0; i < rowsThisPage; i++) {
                    if (entryIndex < totalEntries) {
                        html += generateDataRow(entries[entryIndex]);
                        entryIndex++;
                    } else {
                        html += generateEmptyRow();
                    }
                }

                // Add totals row only on last page
                if (isLastPage) {
                    html += `<tr style="font-weight: bold; background: #e8e8e8; border-top: 2px solid #000;"><td style="border: 2px solid #000; padding: 6px; text-align: right; font-size: 11px; text-transform: uppercase;" colspan="3">Total Miles:</td><td contenteditable="true" style="border: 2px solid #000; padding: 6px; text-align: center; font-size: 12px; font-weight: bold;">${totalMiles.toFixed(0)}</td><td style="border: 2px solid #000; padding: 6px; text-align: right; font-size: 11px; text-transform: uppercase;" colspan="2">Total Hours:</td><td contenteditable="true" style="border: 2px solid #000; padding: 6px; text-align: center; font-size: 12px; font-weight: bold;">${totalHours.toFixed(2)}</td><td style="border: 2px solid #000;" colspan="3"></td></tr>`;
                }

                html += `</tbody></table>`;

                // Add signature section only on last page
                if (isLastPage) {
                    html += generateSignatureSection();
                } else {
                    html += `<div style="text-align: center; margin-top: 10px; font-style: italic; color: #666;">Continued on next page...</div>`;
                }

                html += `</div>`;
            }

            // Add page break after this travel log set
            if (totalPages > 0) {
                html = html.slice(0, -6) + ' page-break-after: always;">' + html.slice(html.lastIndexOf('>') + 1);
            }

            return html;
        }

        function generateTravelLogTotalsSheet(month, year, contractor) {
            // Billing rates
            const BILLING_RATES = {
                DRUG_TESTING: 75,      // $75 per occurrence
                TRAVEL: 35,            // $35 per hour/unit
                SESSION: 67            // $67 per hour/unit (PT, IHFS, OHFS)
            };

            // Helper to categorize service types
            function getServiceCategory(serviceType) {
                if (serviceType.includes('PT-Kids') || serviceType.includes('PT Kids')) return 'Travel-PT-Kids';
                if (serviceType.includes('PT')) return 'Travel-PT';
                if (serviceType.includes('FS-OH') || serviceType.includes('FS.OH') || serviceType.includes('OHFS')) return 'Travel-FS-OH';
                if (serviceType.includes('FS-IH') || serviceType.includes('FS.IH') || serviceType.includes('IHFS')) return 'Travel-FS-IH';
                if (serviceType.includes('DT') || serviceType.includes('Drug')) return 'Drug Testing';
                return 'Other';
            }

            // Calculate revenue for a service category
            function calculateRevenue(serviceCategory, entries, travelHours, billableHours) {
                let revenue = 0;

                if (serviceCategory === 'Drug Testing') {
                    // Drug testing: $75 per occurrence
                    revenue = entries * BILLING_RATES.DRUG_TESTING;
                } else if (serviceCategory.includes('Travel')) {
                    // Travel services: $35/hr for travel + $67/hr for session
                    revenue = (travelHours * BILLING_RATES.TRAVEL) + (billableHours * BILLING_RATES.SESSION);
                } else {
                    // Other session services: $67/hr
                    revenue = billableHours * BILLING_RATES.SESSION;
                }

                return revenue;
            }

            // Group by Staff with Service Type breakdown
            const byStaffService = {};
            const serviceTypes = new Set();

            travelLogParsedData.forEach(e => {
                const serviceCategory = getServiceCategory(e.serviceType);
                serviceTypes.add(serviceCategory);

                if (!byStaffService[e.staffName]) {
                    byStaffService[e.staffName] = { total: { entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 }, byService: {} };
                }

                if (!byStaffService[e.staffName].byService[serviceCategory]) {
                    byStaffService[e.staffName].byService[serviceCategory] = { entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 };
                }

                // Calculate revenue for this entry
                const entryRevenue = calculateRevenue(serviceCategory, 1, e.travelHours, e.billableHours);

                byStaffService[e.staffName].total.entries++;
                byStaffService[e.staffName].total.miles += e.miles;
                byStaffService[e.staffName].total.hours += e.travelHours;
                byStaffService[e.staffName].total.billableHours += e.billableHours;
                byStaffService[e.staffName].total.revenue += entryRevenue;

                byStaffService[e.staffName].byService[serviceCategory].entries++;
                byStaffService[e.staffName].byService[serviceCategory].miles += e.miles;
                byStaffService[e.staffName].byService[serviceCategory].hours += e.travelHours;
                byStaffService[e.staffName].byService[serviceCategory].billableHours += e.billableHours;
                byStaffService[e.staffName].byService[serviceCategory].revenue += entryRevenue;
            });

            const sortedServiceTypes = Array.from(serviceTypes).sort();

            // Generate staff by service type sheets
            let staffServiceSheets = '';
            Object.entries(byStaffService).forEach(([staffName, data]) => {
                const staffNameFormatted = capitalizeName(staffName);
                let serviceRows = '';
                let totalMiles = 0, totalHours = 0, totalBillable = 0, totalRevenue = 0;

                sortedServiceTypes.forEach(service => {
                    const svc = data.byService[service] || { entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 };
                    if (svc.entries > 0) {
                        totalMiles += svc.miles;
                        totalHours += svc.hours;
                        totalBillable += svc.billableHours;
                        totalRevenue += svc.revenue;
                        serviceRows += `<tr>
                            <td style="border: 1px solid #000; padding: 8px;">${service}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${svc.entries}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.miles)}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.hours)}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.billableHours)}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(svc.miles * MILEAGE_RATE)}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745; font-weight: bold;">$${Math.round(svc.revenue)}</td>
                        </tr>`;
                    }
                });

                staffServiceSheets += `
                    <div style="border: 2px solid #000; padding: 20px; margin-bottom: 20px; page-break-after: always;">
                        <h2 style="text-align: center; color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">Monthly Totals: ${staffNameFormatted}</h2>
                        <p style="text-align: center;">${month} ${year} | Contractor: ${contractor}</p>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Service Type</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Entries</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Miles</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Travel Hours</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Billable Hours</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #2c5aa0; color: white;">Mileage Reimb.</th>
                                    <th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviceRows}
                                <tr style="background: #ffc107; font-weight: bold;">
                                    <td style="border: 1px solid #000; padding: 8px;">STAFF TOTAL</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right;">${data.total.entries}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(totalMiles)}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(totalHours)}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(totalBillable)}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(totalMiles * MILEAGE_RATE)}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745;">$${Math.round(totalRevenue)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Grand totals by service type
            const grandByService = {};
            let grandMiles = 0, grandHours = 0, grandBillable = 0, grandRevenue = 0;

            travelLogParsedData.forEach(e => {
                const serviceCategory = getServiceCategory(e.serviceType);
                if (!grandByService[serviceCategory]) {
                    grandByService[serviceCategory] = { entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 };
                }
                const entryRevenue = calculateRevenue(serviceCategory, 1, e.travelHours, e.billableHours);
                grandByService[serviceCategory].entries++;
                grandByService[serviceCategory].miles += e.miles;
                grandByService[serviceCategory].hours += e.travelHours;
                grandByService[serviceCategory].billableHours += e.billableHours;
                grandByService[serviceCategory].revenue += entryRevenue;
                grandMiles += e.miles;
                grandHours += e.travelHours;
                grandBillable += e.billableHours;
                grandRevenue += entryRevenue;
            });

            let grandServiceRows = '';
            sortedServiceTypes.forEach(service => {
                const svc = grandByService[service] || { entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 };
                if (svc.entries > 0) {
                    grandServiceRows += `<tr>
                        <td style="border: 1px solid #000; padding: 8px;">${service}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${svc.entries}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.miles)}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.hours)}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(svc.billableHours)}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(svc.miles * MILEAGE_RATE)}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745; font-weight: bold;">$${Math.round(svc.revenue)}</td>
                    </tr>`;
                }
            });

            // Group by Client/Family
            const byClient = {};
            travelLogParsedData.forEach(e => {
                const key = `${e.clientName}|${e.masterCase}`;
                const serviceCategory = getServiceCategory(e.serviceType);
                const entryRevenue = calculateRevenue(serviceCategory, 1, e.travelHours, e.billableHours);
                if (!byClient[key]) byClient[key] = { clientName: e.clientName, masterCase: e.masterCase, entries: 0, miles: 0, hours: 0, billableHours: 0, revenue: 0 };
                byClient[key].entries++;
                byClient[key].miles += e.miles;
                byClient[key].hours += e.travelHours;
                byClient[key].billableHours += e.billableHours;
                byClient[key].revenue += entryRevenue;
            });

            let clientRows = '';
            Object.values(byClient).forEach(data => {
                clientRows += `<tr><td style="border: 1px solid #000; padding: 8px;">${capitalizeName(data.clientName)}</td><td style="border: 1px solid #000; padding: 8px;">${data.masterCase}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${data.entries}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(data.miles)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(data.hours)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(data.billableHours)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(data.miles * MILEAGE_RATE)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745; font-weight: bold;">$${Math.round(data.revenue)}</td></tr>`;
            });

            return `
                ${staffServiceSheets}

                <div style="border: 2px solid #000; padding: 20px; margin-bottom: 20px; page-break-after: always;">
                    <h2 style="text-align: center; color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">Grand Totals by Service Type - ${month} ${year}</h2>
                    <p style="text-align: center;">Contractor: ${contractor}</p>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px;">
                        <thead><tr><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Service Type</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Entries</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Miles</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Travel Hours</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Billable Hours</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Mileage Reimb.</th><th style="border: 1px solid #000; padding: 8px; background: #28a745; color: white;">Revenue</th></tr></thead>
                        <tbody>${grandServiceRows}
                            <tr style="background: #ffc107; font-weight: bold;"><td style="border: 1px solid #000; padding: 8px;">GRAND TOTAL</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${travelLogParsedData.length}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandMiles)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandHours)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandBillable)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(grandMiles * MILEAGE_RATE)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745; font-weight: bold;">$${Math.round(grandRevenue)}</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="border: 2px solid #000; padding: 20px; margin-bottom: 20px; page-break-after: always;">
                    <h2 style="text-align: center; color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">Totals by Client/Family - ${month} ${year}</h2>
                    <p style="text-align: center;">Contractor: ${contractor}</p>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px;">
                        <thead><tr><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Client Name</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Master Case #</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Entries</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Miles</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Travel Hours</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Billable Hours</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Mileage Reimb.</th><th style="border: 1px solid #000; padding: 8px; background: #dc3545; color: white;">Revenue</th></tr></thead>
                        <tbody>${clientRows}
                            <tr style="background: #ffc107; font-weight: bold;"><td style="border: 1px solid #000; padding: 8px;" colspan="2">TOTAL</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${travelLogParsedData.length}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandMiles)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandHours)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">${Math.round(grandBillable)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right;">$${Math.round(grandMiles * MILEAGE_RATE)}</td><td style="border: 1px solid #000; padding: 8px; text-align: right; color: #28a745; font-weight: bold;">$${Math.round(grandRevenue)}</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="border: 2px solid #000; padding: 20px; margin-bottom: 20px;">
                    <h2 style="text-align: center; color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 10px;">Grand Summary - ${month} ${year}</h2>
                    <p style="text-align: center;">Contractor: ${contractor}</p>
                    <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 30px; border-radius: 12px; text-align: center; margin: 20px 0; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                        <div style="font-size: 48px; font-weight: bold;">$${Math.round(grandRevenue)}</div>
                        <div style="font-size: 18px; margin-top: 5px;">Total Monthly Revenue</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                        <div style="background: #2c5aa0; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;">${travelLogParsedData.length}</div>
                            <div>Total Entries</div>
                        </div>
                        <div style="background: #28a745; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;">${Math.round(grandMiles)}</div>
                            <div>Total Miles</div>
                        </div>
                        <div style="background: #ffc107; color: #000; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;">$${Math.round(grandMiles * MILEAGE_RATE)}</div>
                            <div>Mileage Reimbursement</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;">${Math.round(grandHours)}</div>
                            <div>Travel Hours</div>
                        </div>
                        <div style="background: #6f42c1; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;">${Math.round(grandBillable)}</div>
                            <div>Billable Hours</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function printTravelLogs(section = 'all') {
            let printContent;
            let title;

            if (section === 'logs') {
                printContent = document.getElementById('travelLogsSection').innerHTML;
                title = 'DHHS Travel Logs';
            } else if (section === 'summary') {
                printContent = document.getElementById('summarySection').innerHTML;
                title = 'Travel Log Summary';
            } else {
                printContent = document.getElementById('travelLogPrintArea').innerHTML;
                title = 'DHHS Travel Logs - Complete Package';
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
                    <style>
                        * {
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Times New Roman', Times, serif;
                            margin: 0;
                            padding: 0;
                            background: #f0f0f0;
                            color: #000;
                            line-height: 1.4;
                        }
                        .signature-text {
                            font-family: 'Dancing Script', 'Brush Script MT', cursive !important;
                        }

                        /* Edit toolbar for screen view */
                        .edit-toolbar {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(135deg, #1a3a6e, #0d2240);
                            color: white;
                            padding: 12px 25px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                            z-index: 1000;
                        }
                        .edit-toolbar h3 { margin: 0; font-size: 16px; font-weight: 600; }
                        .edit-toolbar p { margin: 2px 0 0 0; font-size: 12px; opacity: 0.85; }
                        .toolbar-buttons {
                            display: flex;
                            gap: 10px;
                        }
                        .edit-toolbar button {
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            font-size: 13px;
                            font-weight: bold;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                        }
                        .btn-print {
                            background: linear-gradient(135deg, #28a745, #20c997);
                            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
                        }
                        .btn-print:hover {
                            background: linear-gradient(135deg, #218838, #1abc9c);
                            transform: translateY(-1px);
                        }
                        .content-area {
                            margin-top: 70px;
                            padding: 20px;
                        }

                        /* Each travel log as a standalone page */
                        .travel-log-form {
                            background: white;
                            margin: 0 auto 30px auto;
                            max-width: 1100px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
                        }

                        /* Editable field highlighting */
                        [contenteditable="true"]:hover {
                            background: #fffde7 !important;
                            cursor: text;
                        }
                        [contenteditable="true"]:focus {
                            background: #fff9c4 !important;
                            outline: 2px solid #2c5aa0;
                        }

                        /* Document page styling for screen */
                        .content-area > div {
                            background: white;
                            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
                            margin-bottom: 30px;
                        }

                        /* Table styling enhancements */
                        table {
                            border-collapse: collapse;
                            width: 100%;
                        }
                        th, td {
                            border: 1px solid #000 !important;
                        }

                        /* Print-specific styles */
                        @media print {
                            @page {
                                size: landscape;
                                margin: 0.35in;
                            }

                            html, body {
                                background: white !important;
                                margin: 0;
                                padding: 0;
                                font-size: 10pt;
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }

                            .edit-toolbar {
                                display: none !important;
                            }

                            .content-area {
                                margin: 0;
                                padding: 0;
                                max-width: none;
                            }

                            /* Hide section wrappers */
                            #travelLogsSection,
                            #summarySection {
                                display: contents;
                            }

                            .content-area > div {
                                box-shadow: none !important;
                                margin: 0;
                                padding: 0;
                            }

                            /* EACH TRAVEL LOG IS ITS OWN PAGE */
                            .travel-log-form {
                                page-break-after: always !important;
                                page-break-inside: avoid !important;
                                margin: 0 !important;
                                padding: 0.2in !important;
                                box-shadow: none !important;
                                border: 2px solid #000 !important;
                                background: white !important;
                            }

                            /* Last travel log in section still breaks for summary */
                            #travelLogsSection .travel-log-form:last-child {
                                page-break-after: always !important;
                            }

                            /* Summary section pages */
                            #summarySection > div {
                                page-break-after: always !important;
                                page-break-inside: avoid !important;
                            }
                            #summarySection > div:last-child {
                                page-break-after: auto;
                            }

                            /* Clean borders for printing */
                            table {
                                border: 2px solid #000 !important;
                            }

                            th {
                                background: #e0e0e0 !important;
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }

                            /* Remove editable highlights when printing */
                            [contenteditable="true"]:hover,
                            [contenteditable="true"]:focus {
                                background: transparent !important;
                                outline: none !important;
                            }

                            /* Ensure images print */
                            img {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                max-width: 180px !important;
                            }

                            /* Summary cards print properly */
                            div[style*="background: linear-gradient"],
                            div[style*="background: #"] {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="edit-toolbar">
                        <div>
                            <h3>Document Preview</h3>
                            <p>Click any field to edit before printing</p>
                        </div>
                        <div class="toolbar-buttons">
                            <button class="btn-print" onclick="window.print()">Print This Section</button>
                        </div>
                    </div>
                    <div class="content-area">${printContent}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>
</body>
</html>
